<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FLOW - Demand Flow Navigator</title>

    <!-- CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&family=Inter:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#0f172a">

    <style>
        :root {
            --navy: #0f172a;
            --navy-light: #1e293b;
            --teal: #0d9488;
            --teal-light: #14b8a6;
            --teal-dim: rgba(13, 148, 136, 0.15);
            --red: #ef4444;
            --orange: #f59e0b;
            --hot-pink: #f43f5e;
            --amber: #d97706;
            --hotel-purple: #8b5cf6;
            --uber-green: #22c55e;
            --didi-orange: #f97316;
            --nagashi-gray: #94a3b8;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--navy);
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: var(--navy);
            padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header-left { display: flex; flex-direction: column; gap: 2px; }
        .app-name { font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 900; letter-spacing: 0.5px; }
        .app-name .o { color: var(--teal-light); }
        .app-subtitle { font-family: 'Inter', sans-serif; font-size: 10px; color: var(--gray-400); letter-spacing: 0.5px; }
        .header-date { font-family: 'Inter', sans-serif; font-size: 12px; color: var(--gray-400); }

        /* Tab Bar */
        .tab-bar { background: var(--navy-light); display: flex; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tab {
            flex: 1; padding: 14px 12px; text-align: center; cursor: pointer;
            color: var(--gray-400); font-size: 13px; font-weight: 600;
            border-bottom: 2.5px solid transparent; transition: all 0.2s;
        }
        .tab.active { color: var(--teal-light); border-bottom-color: var(--teal); }
        .tab-icon { font-size: 18px; display: block; margin-bottom: 4px; }

        /* Content Area */
        .content { display: none; padding-bottom: 100px; }
        .content.active { display: block; }
        .content-padded { padding: 20px; }

        /* NEXT EVENT Banner */
        .next-event-banner {
            background: linear-gradient(135deg, #1a0a1e 0%, #2d1035 50%, #1a2040 100%);
            border: 1px solid rgba(244, 63, 94, 0.2);
            border-radius: 14px; padding: 20px; margin-bottom: 20px;
            position: relative; overflow: hidden;
        }
        .next-event-banner::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(244, 63, 94, 0.3) 0%, transparent 70%);
            pointer-events: none;
        }
        .next-label { font-family: 'Inter', sans-serif; font-size: 10px; color: var(--hot-pink); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .next-time { font-family: 'Inter', sans-serif; font-size: 32px; font-weight: 900; color: white; margin-bottom: 4px; }
        .next-time-label { font-size: 10px; color: var(--gray-400); margin-bottom: 12px; }
        .next-event-name { font-size: 17px; font-weight: 900; color: white; margin-bottom: 6px; }
        .next-event-detail { font-size: 12px; color: var(--gray-300); margin-bottom: 12px; }
        .countdown-badge { display: inline-block; background: var(--hot-pink); color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .countdown-badge.soon { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Filter Chips */
        .filter-chips { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .filter-chips::-webkit-scrollbar { display: none; }
        .filter-chip {
            padding: 8px 16px; border-radius: 20px; border: 1.5px solid var(--gray-700);
            background: transparent; color: var(--gray-400); font-size: 13px; font-weight: 600;
            white-space: nowrap; cursor: pointer; transition: all 0.2s;
        }
        .filter-chip.active { border-color: var(--teal); background: var(--teal-dim); color: var(--teal-light); }

        /* Timeline */
        .timeline { display: flex; flex-direction: column; gap: 16px; }
        .time-divider { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
        .time-divider-line { flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1); }
        .time-divider-label { font-family: 'Inter', sans-serif; font-size: 10px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }

        /* Timeline Item */
        .timeline-item { display: flex; gap: 12px; padding: 16px; background: var(--navy-light); border-radius: 12px; border-left: 3px solid transparent; }
        .timeline-item.rank-s {
            border-left: 4px solid var(--hot-pink);
            background: linear-gradient(135deg, rgba(244,63,94,0.15) 0%, var(--navy-light) 100%);
            box-shadow: 0 0 12px rgba(244,63,94,0.2);
        }
        .timeline-item.rank-a {
            border-left: 4px solid var(--amber);
            background: linear-gradient(135deg, rgba(217,119,6,0.1) 0%, var(--navy-light) 100%);
        }
        .timeline-item.rank-a-hotel {
            border-left: 4px solid var(--hotel-purple);
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, var(--navy-light) 100%);
        }
        .timeline-item.rank-b {
            border-left: 3px solid var(--gray-700);
            opacity: 0.7;
        }

        .timeline-time { width: 52px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; }
        .timeline-time-main { font-family: 'Inter', sans-serif; font-size: 18px; font-weight: 900; line-height: 1; }
        .timeline-time.rank-s .timeline-time-main { color: var(--hot-pink); font-size: 22px; }
        .timeline-time.rank-a .timeline-time-main { color: var(--amber); }
        .timeline-time.rank-a-hotel .timeline-time-main { color: var(--hotel-purple); }
        .timeline-time.rank-b .timeline-time-main { color: var(--gray-400); font-size: 16px; }
        .timeline-time-label { font-size: 9px; color: var(--gray-400); margin-top: 2px; }

        .timeline-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
        .timeline-dot.concert { background: var(--red); }
        .timeline-dot.hotel { background: var(--hotel-purple); }
        .timeline-dot.facility { background: var(--teal); }

        .timeline-content { flex: 1; }
        .timeline-venue { font-size: 14px; font-weight: 700; color: white; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .timeline-item.rank-s .timeline-venue { font-size: 17px; font-weight: 900; }
        .timeline-item.rank-a .timeline-venue, .timeline-item.rank-a-hotel .timeline-venue { font-size: 15px; }
        .timeline-item.rank-b .timeline-venue { font-size: 13px; color: var(--gray-300); }

        .rank-badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 800; color: white; letter-spacing: 1px; }
        .rank-badge.rank-s { background: var(--hot-pink); box-shadow: 0 0 8px rgba(244,63,94,0.5); }
        .rank-badge.rank-a { background: var(--amber); }
        .type-tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 9px; font-weight: 700; color: white; }
        .type-tag.banquet { background: var(--hotel-purple); }
        .type-tag.conference { background: var(--teal); }

        .timeline-detail { font-size: 12px; color: var(--gray-500); margin-bottom: 6px; }
        .people-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-bottom: 6px; }
        .people-badge.large { background: rgba(244, 63, 94, 0.2); color: var(--hot-pink); }
        .people-badge.medium { background: rgba(139, 92, 246, 0.2); color: var(--hotel-purple); }
        .people-badge.small { background: rgba(148, 163, 184, 0.2); color: var(--gray-400); }
        .demand-memo { font-size: 10px; color: var(--gray-400); margin-bottom: 4px; }
        .start-time { font-size: 10px; color: var(--gray-400); }
        .navi-hint { font-size: 9px; color: var(--teal); margin-top: 4px; opacity: 0.6; }
        .timeline-item { cursor: pointer; transition: transform 0.1s; }
        .timeline-item:active { transform: scale(0.98); }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-400); }
        .empty-state-icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state-text { font-size: 14px; margin-bottom: 4px; }
        .empty-state-sub { font-size: 12px; color: var(--gray-500); }

        /* Map Tabs */
        .map-container { display: flex; flex-direction: column; height: calc(100vh - 140px); min-height: 500px; position: relative; }
        .map-filters {
            padding: 0; background: var(--navy-light); border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .map-filters.open { max-height: 300px; padding: 10px 16px; }
        .filter-toggle-bar {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 8px; background: var(--navy-light); cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px; color: var(--gray-400); font-weight: 600;
        }
        .filter-toggle-bar .arrow { transition: transform 0.3s; display: inline-block; }
        .filter-toggle-bar.open .arrow { transform: rotate(180deg); }
        .filter-section { margin-bottom: 6px; }
        .filter-section:last-child { margin-bottom: 0; }
        .filter-label { font-size: 9px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; font-weight: 600; }
        .toggle-group { display: flex; gap: 6px; }
        .toggle-btn {
            flex: 1; padding: 5px 10px; border-radius: 6px; border: 1.5px solid var(--gray-700);
            background: transparent; color: var(--gray-400); font-size: 11px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .toggle-btn.active { background: white; color: var(--navy); border-color: white; box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2); }
        .filter-group { display: flex; gap: 4px; flex-wrap: wrap; }
        .filter-btn {
            padding: 4px 10px; border-radius: 14px; border: 1.5px solid var(--gray-700);
            background: transparent; color: var(--gray-400); font-size: 10px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .filter-btn.active { border-color: var(--teal); background: var(--teal-dim); color: var(--teal-light); }
        .filter-btn.active.uber { border-color: var(--uber-green); background: rgba(34,197,94,0.15); color: var(--uber-green); }
        .filter-btn.active.didi { border-color: var(--didi-orange); background: rgba(249,115,22,0.15); color: var(--didi-orange); }

        #map, #long-map { flex: 1; min-height: 400px; background: #f0f0f0; }
        .leaflet-container { height: 100% !important; width: 100% !important; }
        .leaflet-control-zoom { border: none !important; box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important; }
        .leaflet-control-zoom a { background: var(--navy-light) !important; color: white !important; border: none !important; }
        .leaflet-control-zoom a:hover { background: var(--gray-700) !important; }

        .map-legend {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(15,23,42,0.9); backdrop-filter: blur(10px);
            padding: 12px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); z-index: 1000;
        }
        .legend-title { font-size: 10px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 11px; color: var(--gray-300); }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .legend-dot.uber { background: var(--uber-green); }
        .legend-dot.didi { background: var(--didi-orange); }
        .legend-box { width: 16px; height: 16px; border-radius: 4px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .legend-box.high { background: rgba(239,68,68,0.9); }
        .legend-box.medium { background: rgba(245,158,11,0.9); }
        .legend-box.venue { background: #6366f1; }
        .legend-box.hotel { background: var(--hotel-purple); }
        .legend-gradient { width: 100px; height: 12px; border-radius: 6px; background: linear-gradient(to right, #0066ff, #00ccaa, #44dd00, #ffaa00, #cc0000); }

        .map-stats {
            position: absolute; top: 20px; right: 20px;
            background: rgba(15,23,42,0.9); backdrop-filter: blur(10px);
            padding: 12px 16px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); z-index: 1000; min-width: 140px;
        }
        .stats-label { font-size: 10px; color: var(--gray-400); margin-bottom: 4px; }
        .stats-value { font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 900; color: var(--teal-light); margin-bottom: 6px; }
        .stats-detail { font-size: 11px; color: var(--gray-400); }

        /* Custom Markers */
        .app-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .app-dot.uber { background: var(--uber-green); }
        .app-dot.didi { background: var(--didi-orange); }
        .app-dot.high { background: #ef4444; }
        .app-dot.medium { background: #f59e0b; }
        .fare-pin {
            padding: 2px 6px; border-radius: 12px; border: 2px solid white;
            font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); white-space: nowrap;
            line-height: 1.2;
        }
        .fare-pin.high { background: rgba(239,68,68,0.85); }
        .fare-pin.medium { background: rgba(245,158,11,0.85); }
        .venue-pin {
            padding: 2px 6px; border-radius: 12px; border: 2px solid white;
            font-size: 9px; font-weight: 700; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); white-space: nowrap;
            line-height: 1.2;
        }
        .venue-pin.venue { background: #6366f1; }
        .venue-pin.hotel { background: var(--hotel-purple); }

        /* Popup */
        .leaflet-popup-content-wrapper { background: var(--navy-light) !important; color: white !important; border-radius: 10px !important; padding: 0 !important; }
        .leaflet-popup-content { margin: 12px 14px !important; font-family: 'Noto Sans JP', sans-serif !important; }
        .leaflet-popup-tip { background: var(--navy-light) !important; }
        .popup-tag { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-bottom: 6px; margin-right: 4px; }
        .popup-tag.uber { background: var(--uber-green); color: white; }
        .popup-tag.didi { background: var(--didi-orange); color: white; }
        .popup-tag.morning { background: rgba(245,158,11,0.2); color: var(--orange); }
        .popup-tag.day { background: rgba(14,165,233,0.2); color: #0ea5e9; }
        .popup-tag.evening { background: rgba(249,115,22,0.2); color: var(--didi-orange); }
        .popup-tag.night { background: rgba(99,102,241,0.2); color: #6366f1; }
        .popup-area { font-size: 13px; font-weight: 700; color: white; margin-bottom: 4px; }
        .popup-route { font-size: 13px; font-weight: 700; color: white; margin-bottom: 4px; }
        .popup-fare { font-family: 'Inter', sans-serif; font-size: 18px; font-weight: 900; margin-bottom: 4px; }
        .popup-fare.high { color: var(--red); }
        .popup-fare.medium { color: var(--orange); }
        .popup-datetime { font-size: 10px; color: var(--gray-400); margin-bottom: 8px; }
        .popup-navi-btn { display: block; width: 100%; padding: 8px 12px; background: var(--teal); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; text-align: center; }

        /* FAB */
        .fab {
            position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
            background: var(--teal); border-radius: 50%; border: none;
            box-shadow: 0 4px 12px rgba(13,148,136,0.4);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; font-weight: 300; transition: all 0.3s; z-index: 1000;
        }
        .fab:active { transform: scale(0.95); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; z-index: 2000; }
        .modal-overlay.active { display: block; }
        .modal {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--navy-light);
            border-radius: 20px 20px 0 0; padding: 24px; max-height: 80vh; overflow-y: auto;
            z-index: 2001; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.active { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; color: white; }
        .modal-close { background: none; border: none; color: var(--gray-400); font-size: 28px; cursor: pointer; }
        .modal-section { margin-bottom: 20px; }
        .modal-label { font-size: 12px; color: var(--gray-400); margin-bottom: 8px; font-weight: 600; }
        .modal-textarea {
            width: 100%; min-height: 150px; background: var(--navy);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
            padding: 12px; color: white; font-size: 14px; font-family: 'Noto Sans JP', sans-serif; resize: vertical;
        }
        .modal-textarea:focus { outline: none; border-color: var(--teal); }
        .modal-textarea::placeholder { color: var(--gray-500); }
        .modal-btn { width: 100%; padding: 14px; background: var(--teal); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
        .modal-btn:disabled { background: var(--gray-700); cursor: not-allowed; opacity: 0.5; }
        .parse-preview { background: var(--navy); border: 1px solid rgba(13,148,136,0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px; display: none; }
        .parse-preview.active { display: block; }
        .preview-title { font-size: 13px; color: var(--teal); margin-bottom: 12px; font-weight: 600; }
        .preview-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .preview-item:last-child { border-bottom: none; }
        .preview-label { font-size: 12px; color: var(--gray-400); }
        .preview-value { font-size: 13px; color: white; font-weight: 600; }

        /* Modal Input */
        .modal-input {
            width: 100%; padding: 12px 14px; background: var(--navy);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 8px;
            color: white; font-size: 15px; font-family: 'Noto Sans JP', sans-serif;
        }
        .modal-input:focus { outline: none; border-color: var(--teal); }
        .modal-input::placeholder { color: var(--gray-500); }

        /* App Select Buttons */
        .app-select-group { display: flex; gap: 8px; }
        .app-select-btn {
            flex: 1; padding: 12px 8px; border-radius: 8px;
            border: 1.5px solid var(--gray-700); background: transparent;
            color: var(--gray-400); font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .app-select-btn.active { border-color: var(--teal); background: var(--teal-dim); color: var(--teal-light); }
        .app-select-btn[data-app="uber"].active { border-color: var(--uber-green); background: rgba(34,197,94,0.15); color: var(--uber-green); }
        .app-select-btn[data-app="didi"].active { border-color: var(--didi-orange); background: rgba(249,115,22,0.15); color: var(--didi-orange); }

        /* Dashboard Styles */
        .dashboard-container { padding: 16px; }
        .dashboard-header { margin-bottom: 16px; }
        .dashboard-period-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .period-tab {
            flex: 1; padding: 10px; text-align: center; border-radius: 8px;
            background: var(--navy-light); border: 1.5px solid var(--gray-700);
            color: var(--gray-400); font-size: 12px; font-weight: 600; cursor: pointer;
        }
        .period-tab.active { background: var(--teal-dim); border-color: var(--teal); color: var(--teal-light); }

        .summary-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .summary-card {
            background: var(--navy-light); border-radius: 12px; padding: 16px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .summary-card.highlight {
            background: linear-gradient(135deg, rgba(13,148,136,0.15) 0%, var(--navy-light) 100%);
            border-color: rgba(13,148,136,0.3);
        }
        .summary-card-label { font-size: 11px; color: var(--gray-400); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card-value { font-family: 'Inter', sans-serif; font-size: 24px; font-weight: 900; color: white; }
        .summary-card-value.teal { color: var(--teal-light); }
        .summary-card-sub { font-size: 11px; color: var(--gray-500); margin-top: 4px; }
        .summary-card-trend { display: inline-block; font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .summary-card-trend.up { background: rgba(34,197,94,0.2); color: #22c55e; }
        .summary-card-trend.down { background: rgba(239,68,68,0.2); color: #ef4444; }

        .chart-section { background: var(--navy-light); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .chart-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .chart-container { position: relative; height: 200px; }
        .chart-container.tall { height: 250px; }

        .ranking-section { background: var(--navy-light); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .ranking-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 12px; }
        .ranking-list { display: flex; flex-direction: column; gap: 8px; }
        .ranking-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--navy); border-radius: 8px; }
        .ranking-rank { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800; color: white; }
        .ranking-rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .ranking-rank.silver { background: linear-gradient(135deg, #94a3b8, #64748b); }
        .ranking-rank.bronze { background: linear-gradient(135deg, #d97706, #b45309); }
        .ranking-rank.normal { background: var(--gray-700); }
        .ranking-info { flex: 1; }
        .ranking-name { font-size: 13px; font-weight: 600; color: white; }
        .ranking-detail { font-size: 11px; color: var(--gray-400); }
        .ranking-value { font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 700; color: var(--teal-light); }

        .breakdown-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .breakdown-item { background: var(--navy); border-radius: 8px; padding: 12px; text-align: center; }
        .breakdown-icon { font-size: 20px; margin-bottom: 4px; }
        .breakdown-label { font-size: 10px; color: var(--gray-400); margin-bottom: 4px; }
        .breakdown-value { font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 700; color: white; }
        .breakdown-pct { font-size: 10px; color: var(--gray-500); }

        /* Score Map (Spot Tab) Styles */
        .score-map-wrap { display: flex; height: 100%; width: 100%; }
        .score-map-side { flex: 1; position: relative; }
        #score-map { width: 100%; height: 100%; }
        .score-map-wrap .leaflet-tile-pane { filter: none; }

        /* Top control bar */
        .score-bar {
            position: absolute; top: 0; left: 0; right: 0; z-index: 800;
            padding: 8px 14px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
            background: linear-gradient(180deg, rgba(15,23,42,0.95) 0%, rgba(15,23,42,0.7) 85%, transparent 100%);
            pointer-events: none;
        }
        .score-bar > * { pointer-events: auto; }

        /* Time stepper */
        .score-time-wrap { display: flex; align-items: center; gap: 0; }
        .score-time-btn {
            width: 32px; height: 32px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.15); background: rgba(15,23,42,0.8);
            color: var(--gray-400); font-size: 1em; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.15s;
        }
        .score-time-btn:active { background: rgba(0,230,118,0.15); color: #00e676; }
        .score-time-val {
            font-family: 'JetBrains Mono', 'Inter', monospace; font-size: 1.3em; font-weight: 700;
            color: #fff; min-width: 60px; text-align: center;
        }

        /* Day & mode pills */
        .score-pgroup {
            display: flex; gap: 2px; background: rgba(15,23,42,0.7);
            border-radius: 8px; padding: 2px; border: 1px solid rgba(255,255,255,0.1);
        }
        .score-pb {
            padding: 5px 10px; border-radius: 6px; border: none; background: transparent;
            color: var(--gray-400); font-size: 0.7em; cursor: pointer; font-weight: 500; transition: all 0.15s;
        }
        .score-pb.d-on { background: rgba(0,230,118,0.2); color: #fff; font-weight: 700; }
        .score-pb.m-gem { background: rgba(52,211,153,0.2); color: #34d399; font-weight: 700; }
        .score-pb.m-std { background: rgba(34,211,238,0.2); color: #22d3ee; font-weight: 700; }

        /* Map pins */
        .score-pin {
            position: relative; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; font-family: 'JetBrains Mono', monospace; font-weight: 700; color: #fff;
            border: 2.5px solid rgba(255,255,255,0.3); transition: transform 0.15s;
        }
        .score-pin.p1 { width: 48px; height: 48px; font-size: 16px; box-shadow: 0 0 24px rgba(239,68,68,0.6); animation: scorePulse 2s infinite; border-color: rgba(255,255,255,0.5); }
        .score-pin.p2 { width: 42px; height: 42px; font-size: 14px; box-shadow: 0 0 18px rgba(249,115,22,0.5); border-color: rgba(255,255,255,0.4); }
        .score-pin.p3 { width: 38px; height: 38px; font-size: 13px; box-shadow: 0 0 14px rgba(34,211,238,0.4); }
        .score-pin.p4 { width: 30px; height: 30px; font-size: 11px; opacity: 0.7; box-shadow: 0 0 8px rgba(99,102,241,0.3); }
        .score-pin.p-known { width: 20px; height: 20px; font-size: 0; opacity: 0.3; border: 1px solid rgba(100,116,139,0.3); box-shadow: none; }
        .score-pin.sel { border-color: #fff; transform: scale(1.3); z-index: 999 !important; }
        .score-plbl {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 3px;
            white-space: nowrap; font-size: 10px; font-weight: 700; color: #fff;
            text-shadow: 0 1px 4px rgba(0,0,0,1); background: rgba(15,23,42,0.6);
            padding: 1px 5px; border-radius: 3px; pointer-events: none;
        }
        @keyframes scorePulse { 0%,100%{box-shadow:0 0 24px rgba(239,68,68,0.5)}50%{box-shadow:0 0 36px rgba(239,68,68,0.8)} }

        /* Sidebar */
        .score-sidebar {
            width: 240px; flex-shrink: 0; display: flex; flex-direction: column;
            background: var(--navy); border-left: 1px solid rgba(255,255,255,0.1);
        }
        .score-sb-head {
            padding: 10px 12px 6px; display: flex; justify-content: space-between;
            align-items: center; flex-shrink: 0;
        }
        .score-sb-head .ttl { font-size: 0.78em; font-weight: 700; }
        .score-sb-head .cnt { font-family: 'JetBrains Mono', monospace; font-size: 0.68em; color: var(--gray-400); }
        .score-sb-list { flex: 1; overflow-y: auto; padding: 0 6px 16px; -webkit-overflow-scrolling: touch; }
        .score-sb-list::-webkit-scrollbar { width: 2px; }
        .score-sb-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 1px; }

        /* List items */
        .score-li {
            padding: 9px 10px; margin: 2px 0; border-radius: 10px;
            border: 1px solid transparent; cursor: pointer; transition: all 0.12s;
            display: flex; align-items: center; gap: 8px;
        }
        .score-li:hover { background: rgba(255,255,255,0.02); }
        .score-li.sel { background: rgba(0,230,118,0.06); border-color: rgba(0,230,118,0.2); }
        .score-li .rk { width: 22px; text-align: center; flex-shrink: 0; }
        .score-li .rk span { font-family: 'JetBrains Mono', monospace; font-size: 0.75em; font-weight: 700; }
        .score-li .rk.top .medal {
            width: 20px; height: 20px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 0.7em; font-weight: 900; color: #fff;
        }
        .score-li .mid { flex: 1; min-width: 0; }
        .score-li .nm { font-size: 0.85em; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score-li .tg { font-size: 0.6em; margin-top: 2px; color: var(--gray-400); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score-li .rides-info { font-size: 0.6em; margin-top: 3px; color: #22d3ee; font-weight: 600; }
        .score-li .sv { text-align: right; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .score-li .sv .n { font-family: 'JetBrains Mono', monospace; font-size: 1.3em; font-weight: 700; line-height: 1; }
        .score-li .sv .u { font-size: 0.5em; color: var(--gray-400); }
        .score-li .navi-btn {
            font-size: 0.7em; padding: 3px 8px; border-radius: 6px;
            background: rgba(0,230,118,0.15); border: 1px solid rgba(0,230,118,0.3);
            color: #00e676; cursor: pointer; transition: all 0.15s;
        }
        .score-li .navi-btn:active { background: rgba(0,230,118,0.3); transform: scale(0.95); }
        .score-sep { padding: 6px 10px; font-size: 0.62em; color: var(--gray-400); opacity: 0.5; margin-top: 4px; }

        /* Expanded detail */
        .score-dtl {
            display: none; padding: 8px 10px 10px; margin: -1px 6px 4px;
            background: var(--navy-light); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0 0 10px 10px; font-size: 0.72em; line-height: 1.6;
        }
        .score-dtl.show { display: block; }
        .score-dtl .rs { color: var(--gray-400); margin-bottom: 6px; }
        .score-dtl .bdr { display: flex; gap: 4px; flex-wrap: wrap; }
        .score-dtl .bd { padding: 3px 8px; border-radius: 5px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; font-weight: 600; }
        .score-dtl .rl { margin-top: 5px; font-size: 0.9em; }

        /* GPS location button (bottom-left) */
        .score-location-btn {
            position: absolute; bottom: 20px; left: 16px; z-index: 800;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(15,23,42,0.92); backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .score-location-btn:active { transform: scale(0.95); background: rgba(0,230,118,0.15); }
        .score-location-btn svg { width: 22px; height: 22px; }

        /* Distance badge in sidebar */
        .score-li .dst { font-size: 0.65em; color: var(--gray-500); margin-left: 4px; }

        /* Mobile: hide sidebar, show bottom sheet style */
        @media (max-width: 767px) {
            #apps-content.active { display: block; height: calc(100vh - 80px); }
            .score-map-wrap { flex-direction: column; height: 100%; }
            .score-map-side { height: 55%; flex: none; }
            .score-sidebar { width: 100%; height: 45%; border-left: none; border-top: 1px solid rgba(255,255,255,0.1); }
            .score-bar { padding: 6px 10px; gap: 8px; }
            .score-time-val { font-size: 1.1em; min-width: 50px; }
            .score-pb { padding: 4px 8px; font-size: 0.65em; }
        }
        /* 現在地マーカー（共通） */
        .current-location-marker {
            width: 20px; height: 20px; border-radius: 50%;
            background: #4285f4; border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        .current-location-marker::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(66,133,244,0.2);
            animation: currentLocationPulse 2s ease-in-out infinite;
        }
        @keyframes currentLocationPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.2; }
        }
        /* Optimal position pulse marker */
        .optimal-pulse-marker {
            width: 28px; height: 28px; border-radius: 50%;
            animation: optimalPulse 1.5s ease-in-out infinite;
        }
        .optimal-pulse-marker.event {
            background: rgba(255,152,0,0.9);
            box-shadow: 0 0 0 4px rgba(255,152,0,0.3), 0 0 20px rgba(255,152,0,0.5);
        }
        .optimal-pulse-marker.hotel {
            background: rgba(206,147,216,0.9);
            box-shadow: 0 0 0 4px rgba(206,147,216,0.3), 0 0 20px rgba(206,147,216,0.5);
        }
        .optimal-pulse-marker.long {
            background: rgba(100,181,246,0.9);
            box-shadow: 0 0 0 4px rgba(100,181,246,0.3), 0 0 20px rgba(100,181,246,0.5);
        }
        @keyframes optimalPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.8; }
        }

        /* Navi Tab Styles */
        .navi-map-wrap {
            position: relative; height: calc(100vh - 140px); min-height: 400px;
        }
        .navi-filter-group {
            position: absolute; top: 12px; left: 12px; z-index: 1000;
            display: flex; gap: 6px;
            backdrop-filter: blur(10px);
        }
        .navi-filter-btn {
            display: flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 14px;
            font-size: 10px; font-weight: 800;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .navi-filter-btn.event {
            background: rgba(255,152,0,0.35); border: 1.5px solid rgba(255,152,0,0.7); color: #fff;
        }
        .navi-filter-btn.hotel {
            background: rgba(156,39,176,0.35); border: 1.5px solid rgba(156,39,176,0.7); color: #fff;
        }
        .navi-filter-btn.long {
            background: rgba(33,150,243,0.35); border: 1.5px solid rgba(33,150,243,0.7); color: #fff;
        }
        .navi-filter-btn.off { opacity: 0.3; }
        .navi-filter-dot {
            width: 5px; height: 5px; border-radius: 50%; background: #ff9800;
            animation: naviDotPulse 1.5s ease-in-out infinite;
        }
        @keyframes naviDotPulse {
            0%, 100% { opacity: 1; } 50% { opacity: 0.4; }
        }
        .navi-location-btn {
            position: absolute; right: 12px; z-index: 1000;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(10,10,20,0.88); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.25s ease;
        }
        .navi-location-btn:active { transform: scale(0.95); }
        .navi-location-btn svg { width: 22px; height: 22px; }

        /* Bottom Sheet */
        .navi-sheet {
            position: fixed; left: 0; right: 0; bottom: 0; z-index: 1001;
            background: linear-gradient(180deg, #111122 0%, #0d0d18 20%);
            border-radius: 14px 14px 0 0;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.6);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        .navi-sheet-handle {
            display: flex; justify-content: center; padding: 8px 0;
            touch-action: none; cursor: pointer;
        }
        .navi-sheet-handle-bar {
            width: 36px; height: 4px; border-radius: 2px;
            background: rgba(255,255,255,0.2);
        }
        /* Optimal Position Card */
        .navi-optimal-wrap {
            padding: 0 12px 10px;
        }
        .navi-optimal-card {
            padding: 14px; border-radius: 14px;
            border: 1.5px solid rgba(0,230,118,0.25);
            background: rgba(0,230,118,0.03);
            position: relative;
            transition: opacity 0.3s ease;
        }
        .navi-optimal-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 8px;
        }
        .navi-optimal-label {
            font-size: 11px; color: #00e676; font-weight: 700;
            letter-spacing: 1px;
        }
        .navi-optimal-badge {
            font-size: 10px; font-weight: 700; padding: 3px 8px;
            border-radius: 10px; border: 1px solid;
        }
        .navi-optimal-badge.hot {
            background: rgba(255,23,68,0.2); border-color: rgba(255,23,68,0.4); color: #ff5252;
        }
        .navi-optimal-badge.high {
            background: rgba(255,152,0,0.2); border-color: rgba(255,152,0,0.4); color: #ff9800;
        }
        .navi-optimal-badge.mid {
            background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #999;
        }
        .navi-optimal-body {
            display: flex; align-items: center; gap: 12px;
        }
        .navi-optimal-info { flex: 1; min-width: 0; }
        .navi-optimal-venue {
            font-size: 20px; font-weight: 900; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .navi-optimal-venue.event { color: #ff9800; }
        .navi-optimal-venue.hotel { color: #ce93d8; }
        .navi-optimal-venue.long { color: #64b5f6; }
        .navi-optimal-reason {
            font-size: 12px; color: #999; margin-bottom: 8px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .navi-optimal-score-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 6px;
        }
        .navi-optimal-score-bar {
            flex: 1; height: 8px; border-radius: 4px;
            background: rgba(255,255,255,0.06); position: relative;
            overflow: visible;
        }
        .navi-optimal-score-fill {
            height: 100%; border-radius: 4px;
            position: relative;
        }
        .navi-optimal-score-fill.green { background: #00e676; }
        .navi-optimal-score-fill.orange { background: #ff9800; }
        .navi-optimal-score-fill.yellow { background: #fdd835; }
        .navi-optimal-score-fill.gray { background: #666; }
        .navi-optimal-score-dot {
            position: absolute; right: -7px; top: -3px;
            width: 14px; height: 14px; border-radius: 50%;
            background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .navi-optimal-score-num {
            font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 900;
            color: white; min-width: 36px; text-align: right;
        }
        .navi-optimal-meta {
            display: flex; align-items: center; gap: 12px;
            font-size: 12px;
        }
        .navi-optimal-eta { color: #64b5f6; }
        .navi-optimal-countdown { color: #ff5252; }
        .navi-optimal-btn {
            width: 52px; height: 52px; border-radius: 50%;
            background: #00e676; border: none; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .navi-optimal-btn:active { transform: scale(0.95); }
        .navi-optimal-btn svg { width: 24px; height: 24px; fill: white; }
        .navi-optimal-empty {
            text-align: center; padding: 20px; color: #666; font-size: 13px;
        }

        /* Sub cards (TOP 2, 3) */
        .navi-sub-label {
            font-size: 11px; color: #555; margin: 8px 12px 6px;
        }
        .navi-sub-cards {
            display: flex; gap: 8px; padding: 0 12px 10px;
        }
        .navi-sub-card {
            flex: 1; padding: 10px; border-radius: 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            position: relative; cursor: pointer;
        }
        .navi-sub-card:active { background: rgba(255,255,255,0.05); }
        .navi-sub-rank {
            position: absolute; top: 8px; right: 8px;
            font-size: 10px; color: #555; font-weight: 700;
        }
        .navi-sub-venue {
            font-size: 13px; font-weight: 800; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-bottom: 2px; padding-right: 20px;
        }
        .navi-sub-venue.event { color: #ff9800; }
        .navi-sub-venue.hotel { color: #ce93d8; }
        .navi-sub-venue.long { color: #64b5f6; }
        .navi-sub-info {
            font-size: 10px; color: #777; margin-bottom: 6px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .navi-sub-bottom {
            display: flex; align-items: center; justify-content: space-between;
        }
        .navi-sub-score-wrap {
            display: flex; align-items: center; gap: 6px;
        }
        .navi-sub-score-bar {
            width: 50px; height: 4px; border-radius: 2px;
            background: rgba(255,255,255,0.06);
        }
        .navi-sub-score-fill {
            height: 100%; border-radius: 2px;
        }
        .navi-sub-score-num {
            font-size: 12px; font-weight: 700; color: #888;
        }
        .navi-sub-btn {
            width: 32px; height: 32px; border-radius: 50%;
            background: #00e676; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .navi-sub-btn svg { width: 14px; height: 14px; fill: white; }

        /* Pulse animation for TOP1 marker */
        @keyframes naviOptimalPulse {
            0% { box-shadow: 0 0 0 0 rgba(0,230,118,0.6); }
            100% { box-shadow: 0 0 0 20px rgba(0,230,118,0); }
        }
        .navi-marker.optimal {
            animation: naviOptimalPulse 1.5s ease-out infinite;
            background: #00e676;
        }
        .navi-marker.optimal::after { border-top-color: #00e676; }
        .navi-sheet-tabs {
            display: flex; gap: 8px; padding: 0 12px 10px;
        }
        .navi-sheet-tab {
            flex: 1; padding: 12px 0; text-align: center;
            font-size: 13px; font-weight: 700; border-radius: 10px;
            cursor: pointer; transition: all 0.2s; border: 1px solid;
        }
        .navi-sheet-tab.event {
            background: rgba(255,152,0,0.08); border-color: rgba(255,152,0,0.2); color: #997040;
        }
        .navi-sheet-tab.event.active {
            background: rgba(255,152,0,0.15); border-color: rgba(255,152,0,0.45); color: #ff9800;
        }
        .navi-sheet-tab.hotel {
            background: rgba(156,39,176,0.08); border-color: rgba(156,39,176,0.15); color: #7a4088;
        }
        .navi-sheet-tab.hotel.active {
            background: rgba(156,39,176,0.15); border-color: rgba(156,39,176,0.45); color: #ce93d8;
        }
        .navi-list-wrap {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .navi-list-wrap.open { max-height: 45vh; }
        .navi-list {
            padding: 0 12px 12px;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain; max-height: 45vh;
        }
        .navi-card {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06); border-radius: 12px;
            margin-bottom: 6px;
        }
        .navi-card.urgent {
            border-color: rgba(255,23,68,0.25); background: rgba(255,23,68,0.04);
        }
        .navi-card.soon {
            border-color: rgba(255,152,0,0.18); background: rgba(255,152,0,0.03);
        }
        .navi-card.hotel { border-color: rgba(156,39,176,0.18); }
        .navi-card.long { border-color: rgba(33,150,243,0.12); }
        .navi-card-countdown {
            width: 46px; flex-shrink: 0; text-align: center;
        }
        .navi-card-countdown-num {
            font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 900; line-height: 1;
        }
        .navi-card-countdown-num.urgent { color: #ff1744; }
        .navi-card-countdown-num.soon { color: #ff9800; }
        .navi-card-countdown-num.normal { color: #555; }
        .navi-card-countdown-label { font-size: 9px; color: #777; }
        .navi-card-icon {
            width: 38px; height: 38px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0;
        }
        .navi-card-icon.hotel { background: rgba(156,39,176,0.12); }
        .navi-card-icon.long { background: rgba(33,150,243,0.1); }
        .navi-card-info { flex: 1; min-width: 0; }
        .navi-card-venue {
            font-size: 13px; font-weight: 700; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .navi-card-detail {
            font-size: 10px; color: #666; margin-top: 1px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .navi-card-tags { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .navi-card-tag {
            font-size: 9px; padding: 2px 6px; border-radius: 6px;
        }
        .navi-card-tag.people { background: rgba(255,255,255,0.07); color: #999; }
        .navi-card-tag.dist { background: rgba(66,133,244,0.12); color: #64b5f6; }
        .navi-card-tag.fare { background: rgba(0,230,118,0.1); color: #69f0ae; }
        .navi-card-tag.freq { background: rgba(255,255,255,0.06); color: #888; }
        .navi-card-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: #00e676; border: none; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .navi-card-btn:active { transform: scale(0.95); }
        .navi-card-btn svg { width: 18px; height: 18px; fill: white; }

        /* Map Markers */
        .navi-marker {
            padding: 4px 8px; border-radius: 7px;
            font-size: 11px; font-weight: 700; color: white;
            white-space: nowrap; position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .navi-marker::after {
            content: ''; position: absolute; bottom: -6px; left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-top: 6px solid currentColor;
        }
        .navi-marker.urgent { background: #ff1744; }
        .navi-marker.urgent::after { border-top-color: #ff1744; }
        .navi-marker.soon { background: #ff9800; }
        .navi-marker.soon::after { border-top-color: #ff9800; }
        .navi-marker.later { background: rgba(255,255,255,0.3); color: #ddd; }
        .navi-marker.later::after { border-top-color: rgba(255,255,255,0.3); }
        .navi-marker.hotel { background: rgba(156,39,176,0.85); }
        .navi-marker.hotel::after { border-top-color: rgba(156,39,176,0.85); }
        .navi-marker.long { background: rgba(33,150,243,0.8); }
        .navi-marker.long::after { border-top-color: rgba(33,150,243,0.8); }
        @keyframes naviRingPulse {
            0% { box-shadow: 0 0 0 0 rgba(255,23,68,0.6); }
            100% { box-shadow: 0 0 0 14px rgba(255,23,68,0); }
        }
        .navi-marker.urgent { animation: naviRingPulse 1.5s ease-out infinite; }
        .navi-empty { text-align: center; padding: 24px; color: #666; font-size: 13px; }

        /* Sidebar (tablet only, hidden by default) */
        .navi-sidebar { display: none; }

        /* ========================================
           TABLET LAYOUT (768px+)
           ======================================== */
        @media (min-width: 768px) {
            /* Header - horizontal layout for tablet */
            .header {
                padding: 12px 20px;
                display: flex; align-items: center; gap: 20px;
            }
            .header-left { flex-direction: row; align-items: center; gap: 12px; }
            .app-name { font-size: 20px; }
            .app-subtitle { font-size: 9px; }
            .header-date { display: none; }

            /* Tab bar - horizontal pill style */
            .tab-bar {
                display: flex; justify-content: center;
                background: rgba(255,255,255,0.04); border-radius: 10px; padding: 3px;
                border: none; gap: 2px;
                margin: 0 auto;
            }
            .tab {
                flex: none;
                padding: 8px 20px; font-size: 14px; font-weight: 600;
                border-radius: 8px; border-bottom: none;
                color: #666;
            }
            .tab.active {
                background: rgba(255,255,255,0.08); color: #fff;
                border-bottom: none;
            }
            .tab-icon { display: inline; font-size: 14px; margin-right: 6px; margin-bottom: 0; }

            /* Header right - date/time */
            .header-tablet-time {
                margin-left: auto; display: flex; align-items: center; gap: 12px;
            }
            .header-tablet-date { font-size: 14px; color: #888; }
            .header-tablet-clock { font-size: 20px; font-weight: 900; color: #00e676; font-family: 'Inter', sans-serif; }

            /* Content area */
            .content { padding-bottom: 0; }

            /* Navi tab - side by side layout */
            #long-content.active {
                display: flex; height: calc(100vh - 120px);
            }

            /* Spot tab - full height */
            #apps-content.active {
                display: block; height: calc(100vh - 120px);
            }

            /* Map takes remaining space */
            .navi-map-wrap {
                flex: 1; height: 100%; min-height: auto;
            }

            /* Filter chips - larger */
            .navi-filter-btn {
                font-size: 13px; padding: 7px 14px;
            }

            /* Markers - larger */
            .navi-marker {
                font-size: 13px; padding: 6px 12px;
            }
            .navi-marker.later {
                background: rgba(255,255,255,0.12);
                border: 1px solid rgba(255,255,255,0.25);
                color: rgba(255,255,255,0.7);
            }
            .navi-marker.later::after {
                border-top-color: rgba(255,255,255,0.12);
            }

            /* Location button - fixed position in map area */
            .navi-location-btn {
                bottom: 16px !important; right: 16px;
                width: 48px; height: 48px;
            }

            /* Hide bottom sheet on tablet */
            .navi-sheet { display: none; }

            /* Show sidebar on tablet */
            .navi-sidebar {
                display: flex; flex-direction: column;
                width: 420px; flex-shrink: 0;
                background: linear-gradient(180deg, #0f0f1a 0%, #0a0a12 100%);
                border-left: 1px solid rgba(255,255,255,0.06);
            }

            /* Sidebar recommend card */
            .navi-sidebar-recommend {
                margin: 16px; padding: 16px;
                border: 1px solid rgba(255,152,0,0.3); border-radius: 14px;
                background: rgba(255,152,0,0.04);
            }
            .navi-sidebar-recommend-header {
                display: flex; justify-content: space-between; align-items: flex-start;
                margin-bottom: 8px;
            }
            .navi-sidebar-recommend-label {
                font-size: 11px; color: #ff9800; font-weight: 700;
            }
            .navi-sidebar-recommend-btn {
                width: 48px; height: 48px; border-radius: 50%;
                background: #00e676; border: none;
                display: flex; align-items: center; justify-content: center;
                cursor: pointer; transition: transform 0.2s;
            }
            .navi-sidebar-recommend-btn:hover { transform: scale(1.05); }
            .navi-sidebar-recommend-btn svg { width: 22px; height: 22px; fill: white; }
            .navi-sidebar-recommend-main {
                font-size: 20px; font-weight: 900; color: white;
                margin-bottom: 4px;
            }
            .navi-sidebar-recommend-main .venue { color: #ff9800; }
            .navi-sidebar-recommend-sub {
                font-size: 12px; color: #888;
            }

            /* Sidebar tabs */
            .navi-sidebar-tabs {
                display: flex; gap: 8px; padding: 0 16px 12px;
            }
            .navi-sidebar-tab {
                flex: 1; padding: 11px 0; text-align: center;
                font-size: 14px; font-weight: 700; border-radius: 10px;
                cursor: pointer; transition: all 0.2s;
                border: 1px solid;
            }
            .navi-sidebar-tab.event {
                background: rgba(255,152,0,0.06); border-color: rgba(255,152,0,0.15); color: #806040;
            }
            .navi-sidebar-tab.event.active {
                background: rgba(255,152,0,0.12); border-color: rgba(255,152,0,0.5); color: #ff9800;
                box-shadow: 0 0 12px rgba(255,152,0,0.1);
            }
            .navi-sidebar-tab.hotel {
                background: rgba(156,39,176,0.06); border-color: rgba(156,39,176,0.12); color: #604870;
            }
            .navi-sidebar-tab.hotel.active {
                background: rgba(156,39,176,0.12); border-color: rgba(156,39,176,0.5); color: #ce93d8;
            }

            /* Sidebar list area */
            .navi-sidebar-list-wrap {
                display: none; flex: 1; overflow-y: auto;
                padding: 8px 16px 16px;
            }
            .navi-sidebar-list-wrap.active { display: block; }
            .navi-sidebar-list-wrap::-webkit-scrollbar { width: 3px; }
            .navi-sidebar-list-wrap::-webkit-scrollbar-track { background: transparent; }
            .navi-sidebar-list-wrap::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

            /* Section label */
            .navi-sidebar-section {
                font-size: 11px; color: #555; font-weight: 700;
                letter-spacing: 1.5px; text-transform: uppercase;
                padding: 12px 0 8px; margin-bottom: 4px;
                border-bottom: 1px solid rgba(255,255,255,0.06);
            }

            /* Sidebar cards */
            .navi-sidebar-card {
                display: flex; align-items: center; gap: 12px; padding: 14px;
                border-radius: 14px; margin-bottom: 8px;
                background: rgba(255,255,255,0.02);
                border-left: 3px solid rgba(255,255,255,0.15);
                transition: background 0.2s;
                cursor: pointer;
            }
            .navi-sidebar-card:hover { background: rgba(255,255,255,0.05); }
            .navi-sidebar-card.urgent { border-left-color: #ff1744; }
            .navi-sidebar-card.soon { border-left-color: #ff9800; }
            .navi-sidebar-card.hotel { border-left-color: rgba(156,39,176,0.6); }
            .navi-sidebar-card.long { border-left-color: rgba(33,150,243,0.5); }

            .navi-sidebar-card-countdown {
                width: 50px; flex-shrink: 0; text-align: center;
            }
            .navi-sidebar-card-countdown-num {
                font-family: 'Inter', sans-serif; font-size: 26px; font-weight: 900; line-height: 1;
            }
            .navi-sidebar-card-countdown-num.urgent { color: #ff1744; }
            .navi-sidebar-card-countdown-num.soon { color: #ff9800; }
            .navi-sidebar-card-countdown-num.normal { color: #555; }
            .navi-sidebar-card-countdown-label { font-size: 10px; color: #777; }

            .navi-sidebar-card-icon {
                width: 44px; height: 44px; border-radius: 12px;
                display: flex; align-items: center; justify-content: center;
                font-size: 20px; flex-shrink: 0;
            }
            .navi-sidebar-card-icon.hotel { background: rgba(156,39,176,0.12); }
            .navi-sidebar-card-icon.long { background: rgba(33,150,243,0.1); }

            .navi-sidebar-card-info { flex: 1; min-width: 0; }
            .navi-sidebar-card-venue {
                font-size: 15px; font-weight: 700; color: #fff;
                white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            }
            .navi-sidebar-card-detail {
                font-size: 11px; color: #666; margin-top: 2px;
                white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            }
            .navi-sidebar-card-tags { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
            .navi-sidebar-card-tag {
                font-size: 11px; padding: 3px 8px; border-radius: 6px;
            }
            .navi-sidebar-card-tag.people { background: rgba(255,255,255,0.07); color: #999; }
            .navi-sidebar-card-tag.dist { background: rgba(66,133,244,0.12); color: #64b5f6; }
            .navi-sidebar-card-tag.fare { background: rgba(0,230,118,0.1); color: #69f0ae; }
            .navi-sidebar-card-tag.freq { background: rgba(255,255,255,0.06); color: #888; }

            .navi-sidebar-card-btn {
                width: 44px; height: 44px; border-radius: 50%;
                background: #00e676; border: none; flex-shrink: 0;
                display: flex; align-items: center; justify-content: center;
                cursor: pointer; transition: transform 0.2s;
            }
            .navi-sidebar-card-btn:hover { transform: scale(1.05); }
            .navi-sidebar-card-btn svg { width: 20px; height: 20px; fill: white; }

            .navi-sidebar-empty {
                text-align: center; padding: 40px 20px; color: #555; font-size: 14px;
            }
        }

        /* ========================================
           iPad mini LAYOUT (768px - 1150px)
           ======================================== */
        @media (min-width: 768px) and (max-width: 1150px) {
            /* Header - compact */
            .header {
                padding: 10px 16px;
            }

            /* Tab bar - larger for iPad mini */
            .tab-bar {
                padding: 14px 8px 0;
                min-height: 60px;
                background: transparent;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                border-radius: 0;
            }
            .tab {
                flex: 1;
                display: flex; flex-direction: column; align-items: center;
                gap: 6px;
                padding: 0 12px 14px;
                font-size: 13px; font-weight: 600;
                border-radius: 0;
                border-bottom: 3px solid transparent;
                color: var(--gray-400);
            }
            .tab.active {
                background: transparent;
                color: var(--teal-light);
                border-bottom: 3px solid var(--teal);
            }
            .tab-icon {
                display: block;
                font-size: 26px;
                margin-right: 0; margin-bottom: 0;
            }

            /* Navi content height for iPad mini */
            #long-content.active {
                height: calc(100vh - 140px);
            }

            /* Spot content height for iPad mini */
            #apps-content.active {
                height: calc(100vh - 140px);
            }

            /* Header time - compact */
            .header-tablet-clock { font-size: 17px; }

            /* Map markers - compact */
            .navi-filter-btn { font-size: 12px; padding: 6px 12px; }
            .navi-marker { font-size: 12px; padding: 5px 10px; }

            /* Sidebar - narrower */
            .navi-sidebar { width: 340px; }

            /* Sidebar recommend - compact */
            .navi-sidebar-recommend { margin: 12px; padding: 12px; }
            .navi-sidebar-recommend-main { font-size: 17px; }
            .navi-sidebar-recommend-btn { width: 44px; height: 44px; }
            .navi-sidebar-recommend-btn svg { width: 20px; height: 20px; }

            /* Sidebar tabs - compact */
            .navi-sidebar-tab { padding: 9px 0; font-size: 12px; }

            /* Sidebar list - compact */
            .navi-sidebar-list-wrap { padding: 6px 12px 12px; }

            /* Section label - compact */
            .navi-sidebar-section { font-size: 10px; padding: 10px 0 6px; }

            /* Sidebar cards - compact */
            .navi-sidebar-card { padding: 10px; gap: 10px; }
            .navi-sidebar-card-countdown { width: 44px; }
            .navi-sidebar-card-countdown-num { font-size: 22px; }
            .navi-sidebar-card-icon { width: 38px; height: 38px; font-size: 18px; }
            .navi-sidebar-card-venue { font-size: 13px; }
            .navi-sidebar-card-detail { font-size: 10px; }
            .navi-sidebar-card-tags { gap: 4px; margin-top: 4px; }
            .navi-sidebar-card-tag { font-size: 10px; padding: 2px 6px; }
            .navi-sidebar-card-btn { width: 40px; height: 40px; }
            .navi-sidebar-card-btn svg { width: 18px; height: 18px; }
        }

        /* ========================================
           Large iPad LAYOUT (1151px+)
           ======================================== */
        @media (min-width: 1151px) {
            .navi-sidebar { width: 420px; }
        }

        /* ========================================
           Refresh Toast Notification
           ======================================== */
        .refresh-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--gray-300);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .refresh-toast.show {
            opacity: 1;
        }
        .refresh-toast.success {
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        .refresh-toast .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--teal-light);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================
           Pull-to-Refresh Indicator
           ======================================== */
        .pull-indicator {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 36px;
            background: var(--navy-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: transform 0.2s, opacity 0.2s;
            z-index: 100;
        }
        .pull-indicator.visible {
            opacity: 1;
        }
        .pull-indicator.ready {
            transform: translateX(-50%) scale(1.1);
            border-color: var(--teal);
        }
        .pull-indicator.refreshing .pull-arrow {
            display: none;
        }
        .pull-indicator.refreshing::after {
            content: '';
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--teal-light);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .pull-arrow {
            font-size: 16px;
            transition: transform 0.2s;
        }
        .pull-indicator.ready .pull-arrow {
            transform: rotate(180deg);
            color: var(--teal-light);
        }
    </style>
</head>

<body>
    <!-- Refresh Toast -->
    <div class="refresh-toast" id="refreshToast">
        <div class="spinner"></div>
        <span id="refreshToastText">更新中...</span>
    </div>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="app-name">FL<span class="o">O</span>W</div>
            <div class="app-subtitle">demand flow navigator</div>
        </div>
        <div class="header-date" id="headerDate"></div>
        <!-- Tablet time display -->
        <div class="header-tablet-time" id="headerTabletTime" style="display: none;">
            <div class="header-tablet-date" id="headerTabletDate"></div>
            <div class="header-tablet-clock" id="headerTabletClock"></div>
        </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
        <div class="tab active" data-tab="events"><span class="tab-icon">📅</span>イベント</div>
        <div class="tab" data-tab="apps"><span class="tab-icon">🔥</span>スポット</div>
        <div class="tab" data-tab="long"><span class="tab-icon">🧭</span>ナビ</div>
        <div class="tab" data-tab="dashboard"><span class="tab-icon">📊</span>収益</div>
    </div>

    <!-- Events Tab Content -->
    <div class="content active" id="events-content">
        <div class="content-padded">
            <div class="next-event-banner" id="nextBanner">
                <div class="next-label">⚡ NEXT</div>
                <div class="next-time" id="nextTime">--:--</div>
                <div class="next-time-label">終了予定</div>
                <div class="next-event-name" id="nextName">読み込み中...</div>
                <div class="next-event-detail" id="nextDetail"></div>
                <div class="countdown-badge" id="nextCountdown"></div>
            </div>
            <div class="filter-chips">
                <button class="filter-chip active" data-filter="all">全て</button>
                <button class="filter-chip" data-filter="concert">🎤 コンサート</button>
                <button class="filter-chip" data-filter="hotel">🏨 ホテル宴会</button>
                <button class="filter-chip" data-filter="facility">🎢 施設</button>
            </div>
            <div class="timeline" id="timeline"></div>
        </div>
    </div>

    <!-- Score Map Tab Content -->
    <div class="content" id="apps-content">
        <div class="score-map-wrap">
            <div class="score-map-side">
                <div id="score-map"></div>
                <div class="score-bar">
                    <div class="score-time-wrap">
                        <button class="score-time-btn" onclick="scoreStepTime(-1)">◀</button>
                        <span class="score-time-val" id="scoreTimeVal">21:00</span>
                        <button class="score-time-btn" onclick="scoreStepTime(1)">▶</button>
                    </div>
                    <div class="score-pgroup">
                        <button class="score-pb d-on" data-d="weekday" onclick="scoreSetDay('weekday')">平日</button>
                        <button class="score-pb" data-d="friday" onclick="scoreSetDay('friday')">金曜</button>
                        <button class="score-pb" data-d="weekend" onclick="scoreSetDay('weekend')">土日</button>
                        <button class="score-pb" data-d="event" onclick="scoreSetDay('event')">ｲﾍﾞﾝﾄ</button>
                    </div>
                    <div class="score-pgroup">
                        <button class="score-pb m-gem" id="scoreModeAnaba" onclick="scoreSetMode('anaba')">💎 穴場</button>
                        <button class="score-pb" id="scoreModeStd" onclick="scoreSetMode('std')">総合</button>
                    </div>
                </div>
                <!-- GPS button (bottom-left) -->
                <button class="score-location-btn" id="scoreLocationBtn" onclick="scoreGoGPS()" title="現在地">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#4285f4" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <line x1="12" y1="2" x2="12" y2="6"/>
                        <line x1="12" y1="18" x2="12" y2="22"/>
                        <line x1="2" y1="12" x2="6" y2="12"/>
                        <line x1="18" y1="12" x2="22" y2="12"/>
                    </svg>
                </button>
            </div>
            <div class="score-sidebar">
                <div class="score-sb-head">
                    <span class="ttl" id="scoreSbLabel">💎 穴場ランキング</span>
                    <span class="cnt" id="scoreSbCount">--</span>
                </div>
                <div class="score-sb-list" id="scoreSbList"></div>
            </div>
        </div>
    </div>

    <!-- Navi Tab Content -->
    <div class="content" id="long-content">
        <div class="navi-map-wrap">
            <div id="long-map" style="height: 100%;"></div>
            <!-- Filter buttons (top-left) -->
            <div class="navi-filter-group">
                <button class="navi-filter-btn event" id="navi-filter-event" onclick="toggleNaviFilter('event')">
                    <span class="navi-filter-dot"></span>イベント
                </button>
                <button class="navi-filter-btn hotel" id="navi-filter-hotel" onclick="toggleNaviFilter('hotel')">
                    🏨 ホテル
                </button>
                <button class="navi-filter-btn long" id="navi-filter-long" onclick="toggleNaviFilter('long')">
                    💰 ロング
                </button>
            </div>
            <!-- Current location button -->
            <div class="navi-location-btn" id="navi-location-btn" onclick="goToNaviCurrentLocation()">
                <svg viewBox="0 0 24 24" fill="none" stroke="#4285f4" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <line x1="12" y1="2" x2="12" y2="6"/>
                    <line x1="12" y1="18" x2="12" y2="22"/>
                    <line x1="2" y1="12" x2="6" y2="12"/>
                    <line x1="18" y1="12" x2="22" y2="12"/>
                </svg>
            </div>
        </div>
        <!-- Bottom Sheet -->
        <div class="navi-sheet" id="navi-sheet">
            <div class="navi-sheet-handle">
                <div class="navi-sheet-handle-bar"></div>
            </div>
            <!-- Optimal Position Card -->
            <div class="navi-optimal-wrap" id="navi-optimal-wrap">
                <!-- TOP1 Main Card -->
                <div class="navi-optimal-card" id="navi-optimal-top1">
                    <div class="navi-optimal-header">
                        <span class="navi-optimal-label">🎯 最適ポジション</span>
                        <span class="navi-optimal-badge hot" id="navi-optimal-badge">HOT</span>
                    </div>
                    <div class="navi-optimal-body">
                        <div class="navi-optimal-info">
                            <div class="navi-optimal-venue event" id="navi-optimal-venue">読み込み中...</div>
                            <div class="navi-optimal-reason" id="navi-optimal-reason">--</div>
                            <div class="navi-optimal-score-row">
                                <div class="navi-optimal-score-bar">
                                    <div class="navi-optimal-score-fill green" id="navi-optimal-score-fill" style="width: 0%"></div>
                                    <div class="navi-optimal-score-dot" id="navi-optimal-score-dot" style="left: 0%"></div>
                                </div>
                                <span class="navi-optimal-score-num" id="navi-optimal-score">--</span>
                            </div>
                            <div class="navi-optimal-meta">
                                <span class="navi-optimal-eta" id="navi-optimal-eta">--</span>
                                <span class="navi-optimal-countdown" id="navi-optimal-countdown">--</span>
                            </div>
                        </div>
                        <button class="navi-optimal-btn" id="navi-optimal-btn">
                            <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                        </button>
                    </div>
                </div>
                <!-- Empty state -->
                <div class="navi-optimal-empty" id="navi-optimal-empty" style="display: none;">
                    <div>📍 現在スポットなし</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">イベント・ホテル情報がありません</div>
                </div>
            </div>
            <!-- Tabs -->
            <div class="navi-sheet-tabs">
                <div class="navi-sheet-tab event" id="navi-tab-event" onclick="toggleNaviList('event')">
                    🔴 イベント <span id="navi-event-count">0</span>
                </div>
                <div class="navi-sheet-tab hotel" id="navi-tab-hotel" onclick="toggleNaviList('hotel')">
                    🟣 ホテル・ロング <span id="navi-hotel-count">0</span>
                </div>
            </div>
            <!-- Lists -->
            <div class="navi-list-wrap" id="navi-list-wrap-event">
                <div class="navi-list" id="navi-list-event"></div>
            </div>
            <div class="navi-list-wrap" id="navi-list-wrap-hotel">
                <div class="navi-list" id="navi-list-hotel"></div>
            </div>
        </div>
        <!-- Sidebar (tablet only) -->
        <div class="navi-sidebar" id="navi-sidebar">
            <!-- Optimal Position Card (Sidebar) -->
            <div class="navi-optimal-wrap" id="navi-sidebar-optimal-wrap">
                <div class="navi-optimal-card" id="navi-sidebar-optimal-top1">
                    <div class="navi-optimal-header">
                        <span class="navi-optimal-label">🎯 最適ポジション</span>
                        <span class="navi-optimal-badge hot" id="navi-sidebar-optimal-badge">HOT</span>
                    </div>
                    <div class="navi-optimal-body">
                        <div class="navi-optimal-info">
                            <div class="navi-optimal-venue event" id="navi-sidebar-optimal-venue">読み込み中...</div>
                            <div class="navi-optimal-reason" id="navi-sidebar-optimal-reason">--</div>
                            <div class="navi-optimal-score-row">
                                <div class="navi-optimal-score-bar">
                                    <div class="navi-optimal-score-fill green" id="navi-sidebar-optimal-score-fill" style="width: 0%"></div>
                                    <div class="navi-optimal-score-dot" id="navi-sidebar-optimal-score-dot" style="left: 0%"></div>
                                </div>
                                <span class="navi-optimal-score-num" id="navi-sidebar-optimal-score">--</span>
                            </div>
                            <div class="navi-optimal-meta">
                                <span class="navi-optimal-eta" id="navi-sidebar-optimal-eta">--</span>
                                <span class="navi-optimal-countdown" id="navi-sidebar-optimal-countdown">--</span>
                            </div>
                        </div>
                        <button class="navi-optimal-btn" id="navi-sidebar-optimal-btn">
                            <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="navi-optimal-empty" id="navi-sidebar-optimal-empty" style="display: none;">
                    <div>📍 現在スポットなし</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">イベント・ホテル情報がありません</div>
                </div>
            </div>
            <!-- Tabs -->
            <div class="navi-sidebar-tabs">
                <div class="navi-sidebar-tab event active" id="navi-sidebar-tab-event" onclick="toggleNaviSidebarTab('event')">
                    🔴 イベント <span id="navi-sidebar-event-count">0</span>
                </div>
                <div class="navi-sidebar-tab hotel" id="navi-sidebar-tab-hotel" onclick="toggleNaviSidebarTab('hotel')">
                    🟣 ホテル・ロング <span id="navi-sidebar-hotel-count">0</span>
                </div>
            </div>
            <!-- Event list -->
            <div class="navi-sidebar-list-wrap active" id="navi-sidebar-list-event"></div>
            <!-- Hotel/Long list -->
            <div class="navi-sidebar-list-wrap" id="navi-sidebar-list-hotel"></div>
        </div>
    </div>

    <!-- Dashboard Tab Content -->
    <div class="content" id="dashboard-content">
        <div class="dashboard-container">
            <!-- Period Tabs -->
            <div class="dashboard-period-tabs">
                <div class="period-tab active" data-period="daily">今日</div>
                <div class="period-tab" data-period="weekly">今週</div>
                <div class="period-tab" data-period="monthly">今月</div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards" id="summaryCards">
                <div class="summary-card highlight">
                    <div class="summary-card-label">売上</div>
                    <div class="summary-card-value teal" id="totalRevenue">¥0</div>
                    <div class="summary-card-sub" id="revenueCompare"></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">乗車回数</div>
                    <div class="summary-card-value" id="totalRides">0</div>
                    <div class="summary-card-sub" id="ridesCompare"></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">平均単価</div>
                    <div class="summary-card-value" id="avgFare">¥0</div>
                    <div class="summary-card-sub" id="avgCompare"></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">ロング率</div>
                    <div class="summary-card-value" id="longRate">0%</div>
                    <div class="summary-card-sub">¥3,000以上</div>
                </div>
            </div>

            <!-- Revenue Chart -->
            <div class="chart-section">
                <div class="chart-title">📈 売上推移</div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- App Breakdown -->
            <div class="chart-section">
                <div class="chart-title">📱 アプリ別内訳</div>
                <div class="breakdown-grid" id="appBreakdown">
                    <div class="breakdown-item">
                        <div class="breakdown-icon">🟢</div>
                        <div class="breakdown-label">Uber</div>
                        <div class="breakdown-value" id="uberRevenue">¥0</div>
                        <div class="breakdown-pct" id="uberPct">0%</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-icon">🟠</div>
                        <div class="breakdown-label">DiDi</div>
                        <div class="breakdown-value" id="didiRevenue">¥0</div>
                        <div class="breakdown-pct" id="didiPct">0%</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-icon">🚕</div>
                        <div class="breakdown-label">流し</div>
                        <div class="breakdown-value" id="nagashiRevenue">¥0</div>
                        <div class="breakdown-pct" id="nagashiPct">0%</div>
                    </div>
                </div>
            </div>

            <!-- Time Distribution Chart -->
            <div class="chart-section">
                <div class="chart-title">⏰ 時間帯別売上</div>
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>

            <!-- Area Ranking -->
            <div class="ranking-section">
                <div class="ranking-title">🏆 エリア別ランキング</div>
                <div class="ranking-list" id="areaRanking"></div>
            </div>
        </div>
    </div>

    <!-- FAB Button -->
    <button class="fab" id="fabBtn">+</button>

    <!-- Taxi Log Modal -->
    <div class="modal-overlay" id="taxiModalOverlay"></div>
    <div class="modal" id="taxiModal">
        <div class="modal-header">
            <div class="modal-title">🚕 乗車ログ追加</div>
            <button class="modal-close" id="taxiModalClose">×</button>
        </div>
        <div class="modal-section">
            <div class="modal-label">乗車時刻</div>
            <input type="time" class="modal-input" id="taxiTime" value="">
        </div>
        <div class="modal-section">
            <div class="modal-label">出発地</div>
            <input type="text" class="modal-input" id="taxiFrom" placeholder="例: 梅田、難波、北新地">
        </div>
        <div class="modal-section">
            <div class="modal-label">到着地（任意）</div>
            <input type="text" class="modal-input" id="taxiTo" placeholder="例: 新大阪、伊丹空港">
        </div>
        <div class="modal-section">
            <div class="modal-label">金額</div>
            <input type="number" class="modal-input" id="taxiFare" placeholder="例: 3500" inputmode="numeric">
        </div>
        <div class="modal-section">
            <div class="modal-label">アプリ</div>
            <div class="app-select-group">
                <button class="app-select-btn active" data-app="uber">🟢 Uber</button>
                <button class="app-select-btn" data-app="didi">🟠 DiDi</button>
                <button class="app-select-btn" data-app="nagashi">🚕 流し</button>
            </div>
        </div>
        <button class="modal-btn" id="saveTaxiBtn">保存する</button>
    </div>

    <!-- LINE Paste Modal -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="lineModal">
        <div class="modal-header">
            <div class="modal-title">📋 LINE貼り付け</div>
            <button class="modal-close" id="modalClose">×</button>
        </div>
        <div class="modal-section">
            <div class="modal-label">LINEのイベント情報を貼り付けてください</div>
            <textarea class="modal-textarea" id="lineTextarea" placeholder="例:&#10;明日の京セラドーム大阪でのライブ&#10;開演19:00、終演21:30予定&#10;参加者50名"></textarea>
        </div>
        <div class="parse-preview" id="parsePreview">
            <div class="preview-title">✨ 解析結果</div>
            <div class="preview-item"><div class="preview-label">会場</div><div class="preview-value" id="previewVenue">-</div></div>
            <div class="preview-item"><div class="preview-label">終了時刻</div><div class="preview-value" id="previewTime">-</div></div>
            <div class="preview-item"><div class="preview-label">人数</div><div class="preview-value" id="previewCount">-</div></div>
            <div class="preview-item"><div class="preview-label">ランク</div><div class="preview-value" id="previewRank">-</div></div>
        </div>
        <button class="modal-btn" id="parseBtn">解析する</button>
        <button class="modal-btn" id="addEventBtn" style="display:none;margin-top:12px">イベントを追加</button>
    </div>

    <script>
    // ========================================
    // Supabase Configuration
    // ========================================
    const SUPABASE_URL = 'https://jaxluazbsansigrboyhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpheGx1YXpic2Fuc2lncmJveWhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjc3ODUsImV4cCI6MjA4NTgwMzc4NX0.GpiPbUJpuc7BugaKgkDVS2igSDNp8QHRW4QvktVbQN0';

    let sb = null;
    try {
        if (window.supabase) {
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('✅ Supabase initialized');
        }
    } catch (e) {
        console.warn('⚠️ Supabase init failed:', e.message);
    }

    // Filter toggle
    function toggleFilter(bar) {
        bar.classList.toggle('open');
        const filters = bar.nextElementSibling;
        filters.classList.toggle('open');
    }

    // Venue coordinates for navigation
    const VENUE_COORDS = {
        '大阪城ホール': { lat: 34.6873, lng: 135.5320 },
        '京セラドーム': { lat: 34.6694, lng: 135.4762 },
        '京セラドーム大阪': { lat: 34.6694, lng: 135.4762 },
        'フェスティバルホール': { lat: 34.6914, lng: 135.4946 },
        'オリックス劇場': { lat: 34.6722, lng: 135.4986 },
        'Zeppなんば': { lat: 34.6597, lng: 135.5013 },
        'Zepp Namba': { lat: 34.6597, lng: 135.5013 },
        'Zepp大阪': { lat: 34.6597, lng: 135.5013 },
        'Zepp Osaka Bayside': { lat: 34.6550, lng: 135.4320 },
        'なんばHatch': { lat: 34.6601, lng: 135.5005 },
        'GORILLA HALL OSAKA': { lat: 34.6630, lng: 135.5010 },
        'GION ARENA神戸': { lat: 34.6900, lng: 135.1830 },
        'USJ': { lat: 34.6654, lng: 135.4324 },
        'ユニバーサル・スタジオ・ジャパン': { lat: 34.6654, lng: 135.4324 },
        '海遊館': { lat: 34.6545, lng: 135.4290 },
        'インテックス大阪': { lat: 34.6360, lng: 135.4190 },
        '天王寺動物園': { lat: 34.6481, lng: 135.5082 },
        '梅田スカイビル': { lat: 34.7052, lng: 135.4876 },
        'ホテルニューオータニ大阪': { lat: 34.6932, lng: 135.5199 },
        'ニューオータニ': { lat: 34.6932, lng: 135.5199 },
        'リーガロイヤルホテル': { lat: 34.6905, lng: 135.4849 },
        'リーガロイヤル': { lat: 34.6905, lng: 135.4849 },
        '帝国ホテル大阪': { lat: 34.6965, lng: 135.4897 },
        '帝国ホテル': { lat: 34.6965, lng: 135.4897 },
        '大阪国際会議場': { lat: 34.6910, lng: 135.4890 },
        'グランキューブ大阪': { lat: 34.6910, lng: 135.4890 },
        'NHK大阪ホール': { lat: 34.6868, lng: 135.5285 },
        '森ノ宮ピロティホール': { lat: 34.6835, lng: 135.5320 },
        'サンケイホールブリーゼ': { lat: 34.6985, lng: 135.4960 },
        'COOL JAPAN PARK OSAKA': { lat: 34.6850, lng: 135.5340 },
    };

    // ナビアプリ選択ダイアログ（Googleマップ or Apple標準マップ）
    function openYahooNavi(lat, lng, name) {
        const useGoogle = confirm('Googleマップで開きますか？\n\n[OK] → Googleマップ\n[キャンセル] → Apple標準マップ');

        if (useGoogle) {
            // Googleマップアプリを試行、なければWeb版にフォールバック
            const googleAppUrl = 'comgooglemaps://?daddr=' + lat + ',' + lng + '&directionsmode=driving';
            const googleWebUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lng + '&travelmode=driving';

            // アプリを試行、1.5秒後にWeb版にフォールバック
            let opened = false;
            window.location.href = googleAppUrl;
            setTimeout(function() {
                if (!opened && !document.hidden) {
                    window.location.href = googleWebUrl;
                }
            }, 1500);
            document.addEventListener('visibilitychange', function handler() {
                if (document.hidden) {
                    opened = true;
                    document.removeEventListener('visibilitychange', handler);
                }
            });
        } else {
            // Apple標準マップ
            const appleUrl = 'maps://maps.apple.com/?daddr=' + lat + ',' + lng + '&dirflg=d';
            window.location.href = appleUrl;
        }
    }

    function openNavi(venue) {
        const coords = VENUE_COORDS[venue];
        if (coords) {
            openYahooNavi(coords.lat, coords.lng, venue);
        } else {
            // 座標不明の場合はGoogle Maps検索
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venue + ' 大阪')}`, '_blank');
        }
    }

    // ========================================
    // Global State
    // ========================================
    let EVENTS = [];
    let currentFilter = 'all';

    // ========================================
    // Header Date
    // ========================================
    function updateHeaderDate() {
        const now = new Date();
        const wd = ['日','月','火','水','木','金','土'];
        document.getElementById('headerDate').textContent =
            `${now.getMonth()+1}/${now.getDate()}（${wd[now.getDay()]}）`;
    }

    // ========================================
    // Safe time sort helper
    // ========================================
    function timeToMinutes(t) {
        if (!t || typeof t !== 'string' || !t.includes(':')) return 9999;
        const parts = t.split(':').map(Number);
        return (parts[0] || 0) * 60 + (parts[1] || 0);
    }

    // ========================================
    // Fetch events from Supabase
    // ========================================
    async function fetchTodayEvents() {
        if (!sb) return [];
        try {
            const today = new Date().toISOString().split('T')[0];
            const allEvents = [];

            // flow_events (auto-scraped)
            const { data: fe } = await sb.from('flow_events').select('*').eq('event_date', today).order('estimated_end');
            if (fe) fe.forEach(e => {
                allEvents.push({
                    venue: e.venue, artist: e.artist, detail: e.title,
                    endTime: e.estimated_end || '21:00', startTime: e.start_time,
                    type: 'concert', rank: e.rank || 'B', people: null, memo: '', label: '終了予定', source: 'auto'
                });
            });

            // flow_facilities
            try {
                const { data: ff } = await sb.from('flow_facilities').select('*').lte('valid_from', today).gte('valid_to', today);
                if (ff) ff.forEach(f => {
                    allEvents.push({
                        venue: f.name, detail: '', endTime: f.close_time || '20:00',
                        type: 'facility', rank: 'B', label: f.close_label || '閉園', source: 'facility'
                    });
                });
            } catch (e) { console.warn('facilities fetch error:', e); }

            // flow_manual_events
            try {
                const { data: fm } = await sb.from('flow_manual_events').select('*').eq('event_date', today).order('end_time');
                if (fm) fm.forEach(m => {
                    allEvents.push({
                        venue: m.venue, detail: m.detail || '', endTime: m.end_time || '21:00',
                        type: m.event_type || 'hotel', rank: m.rank || 'B', people: m.people_count,
                        label: '終了予定', source: 'manual'
                    });
                });
            } catch (e) { console.warn('manual events fetch error:', e); }

            allEvents.sort((a, b) => timeToMinutes(a.endTime) - timeToMinutes(b.endTime));
            return allEvents;
        } catch (e) {
            console.error('fetchTodayEvents error:', e);
            return [];
        }
    }

    // ========================================
    // NEXT EVENT Banner
    // ========================================
    function updateNextBanner(events) {
        const banner = document.getElementById('nextBanner');
        if (!events || events.length === 0) {
            banner.style.display = 'none';
            return;
        }
        banner.style.display = 'block';

        const now = new Date();
        const nowMin = now.getHours() * 60 + now.getMinutes();
        const next = events.find(e => timeToMinutes(e.endTime) > nowMin) || events[events.length - 1];

        document.getElementById('nextTime').textContent = next.endTime || '--:--';
        document.getElementById('nextName').textContent = next.venue || '';
        document.getElementById('nextDetail').textContent = next.artist || next.detail || '';

        const diff = timeToMinutes(next.endTime) - nowMin;
        const cb = document.getElementById('nextCountdown');
        if (diff > 0) {
            const h = Math.floor(diff / 60), m = diff % 60;
            cb.textContent = h > 0 ? `🔥 あと ${h}時間${m}分` : `🔥 あと ${m}分`;
            cb.className = 'countdown-badge' + (diff <= 30 ? ' soon' : '');
        } else {
            cb.textContent = '終了済み';
            cb.className = 'countdown-badge';
        }
    }

    // ========================================
    // Render Timeline
    // ========================================
    function renderTimeline() {
        const timeline = document.getElementById('timeline');
        let events = EVENTS.slice();

        if (currentFilter !== 'all') {
            events = events.filter(e => e.type === currentFilter);
        }

        events.sort((a, b) => timeToMinutes(a.endTime) - timeToMinutes(b.endTime));

        if (events.length === 0) {
            timeline.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📅</div>
                    <div class="empty-state-text">今日のイベントはありません</div>
                    <div class="empty-state-sub">キョードー大阪からデータを取得するか、＋ボタンで手入力してください</div>
                </div>`;
            return;
        }

        const grouped = {};
        events.forEach(ev => {
            const hour = parseInt((ev.endTime || '21:00').split(':')[0]);
            if (!grouped[hour]) grouped[hour] = [];
            grouped[hour].push(ev);
        });

        let html = '';
        Object.keys(grouped).sort((a, b) => a - b).forEach(hour => {
            const isPeak = hour >= 19 && hour <= 21;
            html += `<div class="time-divider"><div class="time-divider-line"></div><div class="time-divider-label">${hour}:00 〜 ${isPeak ? '🔥' : ''}</div><div class="time-divider-line"></div></div>`;

            grouped[hour].forEach(ev => {
                const rankClass = ev.type === 'hotel' ? 'rank-a-hotel' : `rank-${(ev.rank||'b').toLowerCase()}`;
                const timeLabel = ev.label || '終了予定';

                let peopleHtml = '';
                if (ev.people) {
                    const pc = ev.people >= 2000 ? 'large' : ev.people >= 400 ? 'medium' : 'small';
                    peopleHtml = `<div class="people-badge ${pc}">👥 ${ev.people.toLocaleString()}名</div>`;
                }

                let rankBadge = '';
                if (ev.rank === 'S') {
                    rankBadge = `<span class="rank-badge rank-s">S</span>`;
                } else if (ev.rank === 'A') {
                    rankBadge = `<span class="rank-badge rank-a">A</span>`;
                }

                html += `
                    <div class="timeline-item ${rankClass}" data-type="${ev.type}" onclick="openNavi('${(ev.venue||'').replace(/'/g, "\\'")}')">
                        <div class="timeline-time ${rankClass}">
                            <div class="timeline-time-main">${ev.endTime || '21:00'}</div>
                            <div class="timeline-time-label">${timeLabel}</div>
                        </div>
                        <div class="timeline-dot ${ev.type}"></div>
                        <div class="timeline-content">
                            <div class="timeline-venue">${ev.venue} ${rankBadge}</div>
                            ${ev.artist ? `<div class="timeline-detail">${ev.artist}</div>` : ''}
                            ${ev.detail && ev.detail !== ev.artist ? `<div class="timeline-detail">${ev.detail}</div>` : ''}
                            ${peopleHtml}
                            ${ev.memo ? `<div class="demand-memo">📌 ${ev.memo}</div>` : ''}
                            ${ev.startTime ? `<div class="start-time">${ev.startTime} 開始</div>` : ''}
                            <div class="navi-hint">🚗 タップでナビ</div>
                        </div>
                    </div>`;
            });
        });

        timeline.innerHTML = html;
    }

    // ========================================
    // Tab Switching
    // ========================================
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const tabName = this.dataset.tab;
            document.getElementById(tabName + '-content').classList.add('active');

            // FABボタンはイベントタブでのみ表示
            const fabBtn = document.getElementById('fabBtn');
            if (fabBtn) {
                fabBtn.style.display = tabName === 'events' ? 'flex' : 'none';
            }

            if (tabName === 'apps') {
                setTimeout(() => {
                    initScoreMap();
                    if (scoreMap) {
                        scoreMap.invalidateSize();
                        setTimeout(() => scoreMap.invalidateSize(), 300);
                    }
                }, 100);
            } else if (tabName === 'long') {
                setTimeout(() => { initLongMap(); if (longMap) longMap.invalidateSize(); }, 200);
            } else if (tabName === 'dashboard') {
                setTimeout(() => initDashboard(), 100);
            }
        });
    });

    // Filter chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            renderTimeline();
        });
    });

    // ========================================
    // Sample Data
    // ========================================
    const SAMPLE_EVENTS = [
        { venue: '大阪城ホール', artist: 'YOASOBI LIVE TOUR 2026', endTime: '21:30', startTime: '18:00', type: 'concert', rank: 'S', memo: '城ホール前は車寄せ争奪戦' },
        { venue: 'フェスティバルホール', artist: '宝塚歌劇団 月組公演', endTime: '20:45', startTime: '13:00', type: 'concert', rank: 'A', memo: '年齢層高め→タクシー率◎' },
        { venue: 'USJ', detail: '', endTime: '20:00', type: 'facility', rank: 'B', label: '閉園' },
        { venue: '海遊館', detail: '', endTime: '20:00', type: 'facility', rank: 'B', label: '閉館' }
    ];

    // ========================================
    // HOTSPOT TAB - Map
    // ========================================
    const AREA_COORDS = {
        '梅田': { lat: 34.7010, lng: 135.4975 },
        '北新地': { lat: 34.7025, lng: 135.4950 },
        '難波': { lat: 34.6650, lng: 135.5015 },
        'なんば': { lat: 34.6650, lng: 135.5015 },
        '心斎橋': { lat: 34.6750, lng: 135.5010 },
        '天王寺': { lat: 34.6465, lng: 135.5133 },
        '福島': { lat: 34.6930, lng: 135.4830 },
        '本町': { lat: 34.6810, lng: 135.4960 },
        '淀屋橋': { lat: 34.6900, lng: 135.5020 },
        '天満': { lat: 34.7055, lng: 135.5120 },
        '京橋': { lat: 34.6970, lng: 135.5350 },
        '西成': { lat: 34.6350, lng: 135.5050 },
        '新大阪': { lat: 34.7330, lng: 135.5000 },
        '十三': { lat: 34.7200, lng: 135.4750 },
        '中之島': { lat: 34.6914, lng: 135.4946 },
        'OBP': { lat: 34.6932, lng: 135.5199 },
        '大阪城公園': { lat: 34.6873, lng: 135.5320 },
        '天保山': { lat: 34.6545, lng: 135.4290 },
        'USJ': { lat: 34.6654, lng: 135.4324 },
        '京セラドーム': { lat: 34.6694, lng: 135.4762 },
        '梅田スカイビル': { lat: 34.7052, lng: 135.4876 },
        'インテックス': { lat: 34.6360, lng: 135.4190 },
        '海遊館': { lat: 34.6545, lng: 135.4290 },
        '阿倍野': { lat: 34.6460, lng: 135.5140 },
        '堺筋本町': { lat: 34.6820, lng: 135.5050 },
        '肥後橋': { lat: 34.6880, lng: 135.4920 },
        '谷町': { lat: 34.6800, lng: 135.5180 },
        '上本町': { lat: 34.6700, lng: 135.5250 },
        '鶴橋': { lat: 34.6680, lng: 135.5300 },
        '江坂': { lat: 34.7510, lng: 135.5000 },
        '千里中央': { lat: 34.8070, lng: 135.4940 },
        '豊中': { lat: 34.7810, lng: 135.4700 },
        '吹田': { lat: 34.7640, lng: 135.5180 },
        '箕面': { lat: 34.8270, lng: 135.4700 },
        '伊丹空港': { lat: 34.7850, lng: 135.4380 }
    };

    const DAY_NAMES = ['日', '月', '火', '水', '木', '金', '土'];
    const TIME_PERIOD_LABELS = {
        '0-2': '深夜帯',
        '2-4': '深夜帯',
        '4-6': '早朝帯',
        '6-8': '朝帯',
        '8-10': '朝帯',
        '10-12': '昼帯',
        '12-14': '昼帯',
        '14-16': '昼帯',
        '16-18': '夕方帯',
        '18-20': '夕方帯',
        '20-22': '夜帯',
        '22-24': '深夜帯'
    };

    const LONG_RIDES = [
        { lat: 34.7010, lng: 135.4975, fare: 8200, from: '北新地', to: '箕面', time: '23:40', date: '2/5', app: 'uber' },
        { lat: 34.6873, lng: 135.5320, fare: 5400, from: '大阪城公園', to: '新大阪', time: '21:35', date: '2/5', app: 'uber' },
        { lat: 34.6914, lng: 135.4946, fare: 6800, from: '中之島', to: '豊中', time: '20:50', date: '2/6', app: 'didi' },
        { lat: 34.6932, lng: 135.5199, fare: 7200, from: 'OBP', to: '伊丹空港', time: '22:15', date: '2/6', app: 'uber' },
        { lat: 34.6360, lng: 135.4190, fare: 5900, from: 'インテックス', to: '新大阪', time: '18:20', date: '2/6', app: 'nagashi' },
        { lat: 34.6690, lng: 135.5020, fare: 4200, from: 'なんば', to: '吹田', time: '19:45', date: '2/7', app: 'didi' },
        { lat: 34.6654, lng: 135.4324, fare: 5600, from: 'USJ', to: '梅田', time: '20:30', date: '2/7', app: 'nagashi' },
        { lat: 34.7025, lng: 135.4950, fare: 9100, from: '北新地', to: '千里中央', time: '23:55', date: '2/7', app: 'uber' },
        { lat: 34.6905, lng: 135.4849, fare: 6500, from: 'リーガロイヤル', to: '新大阪', time: '21:10', date: '2/8', app: 'nagashi' },
        { lat: 34.6810, lng: 135.4960, fare: 4800, from: '本町', to: '豊中', time: '18:50', date: '2/8', app: 'didi' },
        { lat: 34.6545, lng: 135.4290, fare: 5200, from: '天保山', to: '梅田', time: '16:15', date: '2/8', app: 'uber' },
        { lat: 34.6694, lng: 135.4762, fare: 3800, from: '京セラドーム', to: '難波', time: '21:25', date: '2/8', app: 'nagashi' }
    ];

    const VENUES = [
        { lat: 34.6694, lng: 135.4762, name: '📍 京セラドーム', type: 'venue' },
        { lat: 34.6873, lng: 135.5320, name: '📍 大阪城ホール', type: 'venue' },
        { lat: 34.6654, lng: 135.4324, name: '📍 USJ', type: 'venue' },
        { lat: 34.6932, lng: 135.5199, name: '📍🏨 ニューオータニ', type: 'hotel' },
        { lat: 34.6905, lng: 135.4849, name: '📍🏨 リーガロイヤル', type: 'hotel' },
        { lat: 34.6965, lng: 135.4897, name: '📍🏨 帝国ホテル', type: 'hotel' }
    ];

    function getPeriod(time) {
        const h = parseInt(time.split(':')[0]);
        if (h >= 5 && h < 10) return 'morning';
        if (h >= 10 && h < 17) return 'day';
        if (h >= 17 && h < 22) return 'evening';
        return 'night';
    }
    LONG_RIDES.forEach(r => r.period = getPeriod(r.time));
    const PERIOD_LABELS = { morning: '🌅 朝', day: '☀️ 昼', evening: '🌆 夜', night: '🌙 深夜' };

    // ========================================
    // SCORE MAP (Spot Tab) - 穴場スコアリング
    // ========================================
    let scoreMap = null, scoreMarkerLayer = null, scoreMyPos = null, scoreWatchId = null;
    let scoreDay = 'weekday', scoreMode = 'anaba', scoreHour = 21, scoreSelId = null;
    let scoreRealData = {}; // ridesテーブルから取得した実績データ
    let scoreFollowing = true; // GPS追従モード

    // pickup名→SCORE_POINTS.idのマッピング（表記揺れ吸収）
    const PICKUP_ALIASES = {
        'kitashinchi': ['北新地', 'キタシンチ', '堂島'],
        'namba': ['難波', 'なんば', 'ナンバ', '南海難波', 'ミナミ'],
        'umeda': ['梅田', 'ウメダ', '大阪駅', '大阪', '茶屋町'],
        'shinsaibashi': ['心斎橋', 'シンサイバシ', 'アメ村', 'アメリカ村'],
        'fukushima': ['福島', 'フクシマ', '関テレ'],
        'nakanoshima': ['中之島', 'ナカノシマ', '渡辺橋'],
        'kyobashi': ['京橋', 'キョウバシ', 'OBP'],
        'honmachi': ['本町', 'ホンマチ', '堺筋本町'],
        'tennoji': ['天王寺', 'テンノウジ', 'あべの', '阿倍野'],
        'tanimachi': ['谷町', 'タニマチ', '谷町四丁目', '府庁'],
        'shin_osaka': ['新大阪', 'シンオオサカ', '西中島'],
        'juso': ['十三', 'ジュウソウ'],
        'temma': ['天満', 'テンマ', '天神橋', '扇町'],
        'usj': ['USJ', 'ユニバ', 'ユニバーサル', '桜島'],
        'bentencho': ['弁天町', 'ベンテンチョウ'],
        'taisho': ['大正', 'タイショウ', '京セラドーム', 'ドーム前'],
        'miyakojima': ['都島', 'ミヤコジマ'],
        'suminoe': ['住之江', 'スミノエ', 'インテックス'],
        'konohana': ['此花', 'コノハナ']
    };

    function pickupToScorePointId(pickupText) {
        if (!pickupText) return null;
        const text = pickupText.trim();
        for (const [id, aliases] of Object.entries(PICKUP_ALIASES)) {
            if (aliases.some(a => text.includes(a) || a.includes(text))) {
                return id;
            }
        }
        return null;
    }

    // ridesテーブルから実績データを取得
    async function fetchScoreRealData() {
        console.log('🔄 [rides連携] fetchScoreRealData開始...');
        if (!sb) {
            console.warn('❌ [rides連携] Supabaseクライアントが未初期化');
            return;
        }
        try {
            console.log('📡 [rides連携] ridesテーブルからデータ取得中...');
            const { data: rides, error } = await sb.from('rides').select('fare, ride_at, pickup');

            if (error) {
                console.error('❌ [rides連携] クエリエラー:', error);
                return;
            }
            if (!rides || rides.length === 0) {
                console.warn('⚠️ [rides連携] ridesテーブルにデータなし');
                return;
            }
            console.log('📊 [rides連携] 取得件数:', rides.length, '件');

            // マッピングできなかったpickup名を記録
            const unmapped = new Set();
            const stats = {};
            rides.forEach(r => {
                const id = pickupToScorePointId(r.pickup);
                if (!id) {
                    if (r.pickup) unmapped.add(r.pickup);
                    return;
                }

                if (!stats[id]) stats[id] = { rides: 0, totalFare: 0, hours: {} };
                stats[id].rides++;
                stats[id].totalFare += Number(r.fare) || 0;

                const hour = new Date(r.ride_at).getHours();
                stats[id].hours[hour] = (stats[id].hours[hour] || 0) + 1;
            });

            // 平均運賃計算
            Object.values(stats).forEach(s => {
                s.fare = s.rides > 0 ? Math.round(s.totalFare / s.rides) : 0;
            });

            scoreRealData = stats;
            console.log('✅ [rides連携] マッピング成功:', Object.keys(stats).length, 'エリア');
            console.table(Object.entries(stats).map(([id, s]) => ({
                エリアID: id,
                乗車数: s.rides,
                平均運賃: '¥' + s.fare.toLocaleString(),
                時間帯: Object.keys(s.hours).join(',') + '時'
            })));
            if (unmapped.size > 0) {
                console.warn('⚠️ [rides連携] マッピングできなかったpickup名:', Array.from(unmapped));
            }

            // スコア再計算
            if (scoreMap) renderScoreMap();
        } catch (err) {
            console.error('❌ [rides連携] 例外発生:', err);
        }
    }

    // エリアデータ（定番 k:true / 穴場 k:false）
    const SCORE_POINTS = [
        {id:'kitashinchi',lat:34.6963,lng:135.4983,name:'北新地',k:true,flow:{b:85,n:95,m:20},sup:85,pat:90,real:{rides:42,gap:35,fare:3057,h:{19:3,20:5,21:8,22:7,23:6,0:5,1:5,2:3}},tags:h=>h>=21||h<2?'流し激戦 / 高単価':'乗り場待ち',rsn:h=>h>=21?'高単価¥3,057だが待ち35分。供給過多。':'定番。競合多い。'},
        {id:'namba',lat:34.6685,lng:135.5013,name:'難波',k:true,flow:{b:80,n:88,m:25},sup:80,pat:82,real:{rides:12,gap:30,fare:2800,h:{19:2,20:2,21:3,22:2,23:2,0:1}},tags:()=>'観光客 / 競合多',rsn:()=>'外国人多いが供給も多い。短距離中心。'},
        {id:'umeda',lat:34.7006,lng:135.496,name:'梅田',k:true,flow:{b:90,n:85,m:40},sup:88,pat:88,real:{rides:35,gap:32,fare:2357,h:{18:4,19:5,20:3,21:4,22:5,23:4,0:4,1:3,2:3}},tags:h=>h>=23?'終電後ﾛﾝｸﾞ':'競合最多',rsn:h=>h>=23?'終電後ﾛﾝｸﾞ需要。供給最多。':'大阪最大需要。競合も最大。'},
        {id:'shinsaibashi',lat:34.677,lng:135.506,name:'心斎橋',k:true,flow:{b:70,n:78,m:22},sup:65,pat:72,real:{rides:22,gap:28,fare:1936,h:{20:3,21:5,22:4,23:3,0:3,1:2,2:2}},tags:()=>'短距離多',rsn:()=>'需要あるが供給多い。単価¥1,936低め。'},
        {id:'fukushima',lat:34.6912,lng:135.4865,name:'福島',k:false,flow:{b:45,n:55,m:35},sup:18,pat:55,real:{rides:6,gap:18,fare:2367,h:{19:1,20:2,21:2,22:1}},tags:h=>h>=19&&h<23?'💎供給薄 / ｱﾌﾟﾘ33%':'💎関テレ法人',rsn:h=>h>=19?'梅田隣接で供給薄。空き18分。ｱﾌﾟﾘ率33%最高。':'関テレ・ABCの法人配車。'},
        {id:'nakanoshima',lat:34.692,lng:135.502,name:'中之島',k:false,flow:{b:48,n:42,m:50},sup:10,pat:52,real:{rides:7,gap:15,fare:4000,h:{19:3,20:2,21:1,22:1}},tags:h=>h>=19&&h<21?'💎¥4,000 / 空き15分':'💎供給ゼロ / 法人',rsn:h=>h>=19?'¥4,000×空き15分。法人ﾁｹｯﾄ。最高効率。':'関電・朝日・日銀。供給ゼロ。'},
        {id:'kyobashi',lat:34.6953,lng:135.526,name:'京橋',k:false,flow:{b:52,n:48,m:55},sup:22,pat:55,real:{rides:5,gap:12,fare:3960,h:{1:2,2:2,23:1}},tags:h=>h>=1&&h<3?'💎深夜ﾛﾝｸﾞ¥3,960':'💎OBP / 飲食街',rsn:h=>h>=1?'深夜ﾛﾝｸﾞ¥3,960。空き12分。':'OBP+京橋飲食街。'},
        {id:'honmachi',lat:34.686,lng:135.5005,name:'本町',k:false,flow:{b:60,n:50,m:55},sup:30,pat:62,real:{rides:14,gap:28,fare:3450,h:{19:2,20:2,21:3,22:2,0:2,1:2,2:1}},tags:h=>h>=19?'💎法人ﾁｹｯﾄ¥3,450':'💎堺筋裏道',rsn:h=>h>=19?'法人ﾁｹｯﾄ客。単価¥3,450。':'堺筋裏道で配車独占。'},
        {id:'tennoji',lat:34.653,lng:135.5133,name:'天王寺',k:false,flow:{b:58,n:45,m:42},sup:25,pat:52,real:{rides:8,gap:25,fare:1800,h:{16:2,17:2,18:2,19:1,20:1}},tags:h=>h>=9&&h<14?'💎病院独占':'堺方面ﾛﾝｸﾞ',rsn:h=>h>=9&&h<14?'赤十字・市大病院。乗り場なし→ｱﾌﾟﾘ独占。':'堺方面ﾛﾝｸﾞ。供給少なめ。'},
        {id:'tanimachi',lat:34.683,lng:135.519,name:'谷町',k:false,flow:{b:42,n:35,m:48},sup:12,pat:48,real:{rides:4,gap:22,fare:1550,h:{21:2,22:1,23:1}},tags:()=>'💎供給極薄 / ﾀﾜﾏﾝ',rsn:()=>'府庁・NHK周辺。ﾀﾜﾏﾝ配車。奈良ﾛﾝｸﾞも。'},
        {id:'shin_osaka',lat:34.733,lng:135.5,name:'新大阪',k:false,flow:{b:50,n:45,m:58},sup:20,pat:55,real:{rides:2,gap:20,h:{19:1,20:1}},tags:h=>h>=6&&h<10?'💎新幹線 / ﾎﾃﾙ':'💎西中島飲食',rsn:h=>h>=6&&h<10?'ﾎﾃﾙ→新幹線の朝需要。':'西中島飲食街。供給少ない。'},
        {id:'juso',lat:34.72,lng:135.48,name:'十三',k:false,flow:{b:35,n:38,m:30},sup:15,pat:35,real:{rides:6,gap:22,h:{19:1,20:2,21:1,22:1,1:1}},tags:h=>h>=20?'💎飲み屋街':'住宅配車',rsn:h=>h>=20?'十三飲食街。梅田ほど供給なし。':'住宅地のｱﾌﾟﾘ配車。'},
        {id:'temma',lat:34.705,lng:135.512,name:'天満',k:false,flow:{b:42,n:40,m:35},sup:20,pat:42,real:{rides:5,gap:25,h:{22:2,23:1,0:1,1:1}},tags:h=>h>=22?'💎天神橋筋':'裁判所 / 官公庁',rsn:h=>h>=22?'天神橋筋飲食街。競合少ない。':'裁判所・官公庁。'},
        {id:'usj',lat:34.6655,lng:135.432,name:'USJ方面',k:false,flow:{b:55,n:45,m:20},sup:15,pat:50,real:{rides:0},tags:h=>h>=17&&h<21?'💎逆張り / 競合ゼロ':'USJ観光',rsn:h=>h>=17?'USJ帰り→桜島で北港通り独占。':'USJ観光客需要。'},
        {id:'bentencho',lat:34.674,lng:135.463,name:'弁天町',k:false,flow:{b:32,n:22,m:35},sup:8,pat:35,real:{rides:1,h:{18:1}},tags:()=>'💎供給ゼロ / 高齢者',rsn:()=>'弁天町駅以外は交通手段なし。競合ゼロ。'},
        {id:'taisho',lat:34.6555,lng:135.4695,name:'大正区',k:false,flow:{b:28,n:20,m:30},sup:5,pat:30,real:{rides:0},tags:(h,d)=>d==='event'?'💎ﾄﾞｰﾑ特需':'💎陸の孤島 / 競合ゼロ',rsn:(h,d)=>d==='event'?'京セラﾄﾞｰﾑ試合日特需。':'橋の向こう。鳴れば100%自分。'},
        {id:'miyakojima',lat:34.71,lng:135.523,name:'都島',k:false,flow:{b:35,n:25,m:40},sup:10,pat:38,real:{rides:2,gap:20,h:{1:1,19:1}},tags:h=>h>=9&&h<14?'💎病院集中':'💎住宅ﾛﾝｸﾞ',rsn:()=>'市立総合医療ｾﾝﾀｰ。守口・門真ﾛﾝｸﾞ。'},
        {id:'suminoe',lat:34.632,lng:135.442,name:'住之江',k:false,flow:{b:25,n:15,m:30},sup:5,pat:28,real:{rides:0},tags:h=>h>=10&&h<16?'💎ｲﾝﾃｯｸｽ / 供給ゼロ':'💎交通空白',rsn:()=>'ﾆｭｰﾄﾗﾑのみ。ｲﾝﾃｯｸｽ展示会特需。'},
        {id:'konohana',lat:34.679,lng:135.443,name:'此花',k:false,flow:{b:22,n:15,m:28},sup:3,pat:25,real:{rides:0},tags:()=>'💎ﾀｸｼｰ砂漠 / 工場',rsn:()=>'24時間ﾀｸｼｰゼロ。工場配車。USJ連携。'},
    ];

    // 時間帯係数
    function scoreTimeMod(h) {
        if (h >= 21 && h < 24) return { n: 1, m: 0.1 };
        if (h >= 19 && h < 21) return { n: 0.8, m: 0.15 };
        if (h >= 0 && h < 3) return { n: 0.7, m: 0.05 };
        if (h >= 3 && h < 6) return { n: 0.1, m: 0.05 };
        if (h >= 6 && h < 10) return { n: 0.1, m: 1 };
        if (h >= 10 && h < 14) return { n: 0.15, m: 0.7 };
        if (h >= 14 && h < 17) return { n: 0.2, m: 0.5 };
        return { n: 0.5, m: 0.3 };
    }

    // 曜日係数
    function scoreDayMod(d) {
        return d === 'friday' ? 1.15 : d === 'weekend' ? 0.7 : d === 'event' ? 1.3 : 1;
    }

    // スコア計算
    function scoreCalc(p) {
        const t = scoreTimeMod(scoreHour), d = scoreDayMod(scoreDay), hh = Math.floor(scoreHour) % 24;
        const fl = Math.min(100, (p.flow.b * 0.3 + p.flow.n * t.n * 0.4 + p.flow.m * t.m * 0.3) * d);
        const si = Math.max(0, 100 - p.sup * (t.n * 0.7 + 0.3));
        const pt = Math.min(100, p.pat * (t.n * 0.6 + t.m * 0.4) * d);
        let rl = 50, rc = 0, rL = '未検証';

        // ridesテーブルのデータを優先、なければハードコードのp.realを使用
        const dbReal = scoreRealData[p.id];
        const realData = dbReal || p.real;

        if (realData && realData.rides > 0) {
            const hr = (realData.hours && realData.hours[hh]) || (realData.h && realData.h[hh]) || 0;
            rc = Math.min(1, realData.rides / 15); rl = 40;
            if (hr >= 5) rl += 35; else if (hr >= 3) rl += 25; else if (hr >= 1) rl += 15; else rl -= 10;
            const gap = realData.gap || (p.real && p.real.gap);
            if (gap) { if (gap <= 15) rl += 20; else if (gap <= 25) rl += 10; else if (gap >= 35) rl -= 5; }
            const fare = realData.fare || (p.real && p.real.fare);
            if (fare) { if (fare >= 3500) rl += 10; else if (fare >= 2500) rl += 5; }
            rl = Math.min(100, Math.max(0, rl));
            rL = hr >= 3 ? '実績◎' + hr + '回/月' : hr >= 1 ? '実績△' + hr + '回/月' : '他時間帯(計' + realData.rides + ')';
            // DBデータの場合は「🔄」を付与
            if (dbReal) rL = '🔄' + rL;
        }
        const rw = 0.15 * rc, rem = 1 - rw;
        let tot;
        if (scoreMode === 'anaba') {
            const pen = p.k && p.sup > 50 ? (p.sup - 50) * 0.7 : 0;
            tot = si * (0.35 * rem / 0.85) + fl * (0.25 * rem / 0.85) + pt * (0.15 * rem / 0.85) + rl * rw - pen;
        } else {
            tot = fl * (0.35 * rem / 0.85) + pt * (0.25 * rem / 0.85) + si * (0.15 * rem / 0.85) + rl * rw;
        }
        if (scoreDay === 'event') tot = Math.min(100, tot * 1.08);
        tot = tot > 50 ? 50 + (tot - 50) * 1.8 : 50 - (50 - tot) * 1.8;
        tot = Math.min(100, Math.max(0, Math.round(tot)));
        return { total: tot, fl: Math.round(fl), si: Math.round(si), pt: Math.round(pt), rl: Math.round(rl), rc, rL, tags: p.tags(hh, scoreDay), rsn: p.rsn(hh, scoreDay) };
    }

    // スコア→色（80↑HOT赤、60↑WARMオレンジ、40↑MID紫、40未満COOL青）
    function scoreColor(s) {
        return s >= 80 ? '#ef4444' : s >= 60 ? '#f97316' : s >= 40 ? '#8b5cf6' : '#3b82f6';
    }

    let scoreLocationMarker = null; // 現在地マーカー

    // GPS共通オプション（iPad Safari対応）
    const SCORE_GPS_OPTIONS = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000  // 5分間キャッシュ
    };

    // GPSエラーハンドリング
    function handleScoreGPSError(err) {
        console.warn('[ScoreMap GPS Error]', err.code, err.message);
        const messages = {
            1: '位置情報を許可してください（設定 > Safari > 位置情報）',
            2: '位置情報を取得できませんでした',
            3: '位置情報の取得がタイムアウトしました'
        };
        alert(messages[err.code] || '位置情報エラー');
    }

    // 距離計算（メートル）
    function scoreCalcDist(lat1, lng1, lat2, lng2) {
        const dlat = (lat2 - lat1) * 111000;
        const dlng = (lng2 - lng1) * 91000;
        return Math.sqrt(dlat * dlat + dlng * dlng);
    }

    // 距離フォーマット
    function scoreFormatDist(m) {
        return m >= 1000 ? (m / 1000).toFixed(1) + 'km' : Math.round(m) + 'm';
    }

    // 地図初期化
    function initScoreMap() {
        if (scoreMap) return;
        scoreMap = L.map('score-map', { center: [34.693, 135.502], zoom: 13, zoomControl: false, attributionControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(scoreMap);
        L.control.zoom({ position: 'topright' }).addTo(scoreMap);
        scoreMarkerLayer = L.layerGroup().addTo(scoreMap);

        // ridesテーブルから実績データを取得
        fetchScoreRealData();

        // 現在時刻を初期値に
        const now = new Date();
        scoreHour = now.getHours();
        const dayIdx = now.getDay();
        scoreDay = dayIdx === 5 ? 'friday' : dayIdx === 0 || dayIdx === 6 ? 'weekend' : 'weekday';
        document.getElementById('scoreTimeVal').textContent = String(scoreHour).padStart(2, '0') + ':00';
        document.querySelectorAll('.score-pb[data-d]').forEach(b => b.className = b.dataset.d === scoreDay ? 'score-pb d-on' : 'score-pb');

        scoreMap.on('moveend zoomend', () => { clearTimeout(scoreMap._renderTimeout); scoreMap._renderTimeout = setTimeout(renderScoreMap, 200); });

        // ドラッグ時にGPS追従を停止
        scoreMap.on('dragstart', () => { scoreFollowing = false; });

        // GPS自動取得（初回は静かに失敗）+ 常時追従
        if (navigator.geolocation) {
            // 現在地マーカー更新用関数（divIcon + pulse）
            const updateLocationMarker = () => {
                if (!scoreMap || !scoreMyPos) return;
                if (scoreLocationMarker) scoreMap.removeLayer(scoreLocationMarker);
                const icon = L.divIcon({
                    className: '',
                    html: '<div class="current-location-marker"></div>',
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                });
                scoreLocationMarker = L.marker(scoreMyPos, { icon, interactive: false }).addTo(scoreMap);
            };

            // 初回取得
            scoreFollowing = true;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    scoreMyPos = [pos.coords.latitude, pos.coords.longitude];
                    scoreMap.setView(scoreMyPos, 14);
                    updateLocationMarker();
                    renderScoreMap();
                    scoreMap.invalidateSize();
                },
                (err) => {
                    console.warn('[ScoreMap GPS Error]', err.code, err.message);
                    renderScoreMap();
                    scoreMap.invalidateSize();
                },
                SCORE_GPS_OPTIONS
            );

            // 常時追従（watchPosition）
            if (scoreWatchId) navigator.geolocation.clearWatch(scoreWatchId);
            scoreWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    scoreMyPos = [pos.coords.latitude, pos.coords.longitude];
                    updateLocationMarker();
                    // 追従モード時は自動センタリング
                    if (scoreFollowing) scoreMap.setView(scoreMyPos, scoreMap.getZoom());
                },
                () => {},
                { enableHighAccuracy: true, timeout: 30000, maximumAge: 60000 }
            );
        } else {
            renderScoreMap();
        }
    }

    // 描画
    function renderScoreMap() {
        const items = SCORE_POINTS.map(p => ({ ...p, s: scoreCalc(p) }));
        const gems = items.filter(i => !i.k).sort((a, b) => b.s.total - a.s.total);
        const knowns = items.filter(i => i.k).sort((a, b) => b.s.total - a.s.total);
        const ordered = scoreMode === 'anaba' ? [...gems, ...knowns] : items.sort((a, b) => b.s.total - a.s.total);

        // マップピン
        scoreMarkerLayer.clearLayers();
        const zoom = scoreMap.getZoom();
        items.forEach(it => {
            if (scoreMode === 'anaba' && it.k) {
                if (zoom < 14) return;
                const icon = L.divIcon({ className: '', html: '<div class="score-pin p-known" style="background:#334155"></div>', iconSize: [0, 0], iconAnchor: [0, 0] });
                scoreMarkerLayer.addLayer(L.marker([it.lat, it.lng], { icon, interactive: false }));
                return;
            }
            const c = scoreColor(it.s.total);
            const gemRank = gems.findIndex(g => g.id === it.id);
            // サイズはスコアベース: 80↑p1、60↑p2、40↑p3、40未満p4
            const sz = it.s.total >= 80 ? 'p1' : it.s.total >= 60 ? 'p2' : it.s.total >= 40 ? 'p3' : 'p4';
            const sel = it.id === scoreSelId ? 'sel' : '';
            const showName = zoom >= 12 && (gemRank < 5 || it.s.total >= 50);
            const icon = L.divIcon({
                className: '',
                html: '<div class="score-pin ' + sz + ' ' + sel + '" style="background:' + c + '">' + it.s.total + (showName ? '<span class="score-plbl">' + it.name + '</span>' : '') + '</div>',
                iconSize: [0, 0], iconAnchor: [0, 0]
            });
            const mk = L.marker([it.lat, it.lng], { icon });
            mk.on('click', () => { scoreSelId = it.id; renderScoreMap(); scoreMap.panTo([it.lat, it.lng]); scrollToScoreItem(it.id); });
            scoreMarkerLayer.addLayer(mk);
        });

        // サイドバー
        document.getElementById('scoreSbLabel').textContent = scoreMode === 'anaba' ? '💎 穴場ランキング' : '📊 総合ランキング';
        document.getElementById('scoreSbCount').textContent = gems.length + '件';

        let h = '';
        let gemsDone = false;
        ordered.forEach((it, idx) => {
            const isGem = !it.k;
            const gemIdx = isGem ? gems.findIndex(g => g.id === it.id) : -1;
            const rk = scoreMode === 'anaba' ? (isGem ? gemIdx + 1 : '-') : idx + 1;
            if (scoreMode === 'anaba' && it.k && !gemsDone) { gemsDone = true; h += '<div class="score-sep">── 定番エリア ──</div>'; }
            const c = scoreColor(it.s.total);
            const sel = it.id === scoreSelId;
            const dim = scoreMode === 'anaba' && it.k ? 'opacity:0.4;' : '';
            let rkHtml;
            if (isGem && gemIdx < 3) {
                const mc = ['#ef4444', '#f97316', '#fbbf24'][gemIdx];
                rkHtml = '<div class="rk top"><div class="medal" style="background:' + mc + '">' + (gemIdx + 1) + '</div></div>';
            } else {
                rkHtml = '<div class="rk"><span style="color:var(--gray-400)">' + rk + '</span></div>';
            }
            // 距離計算
            let distStr = '';
            if (scoreMyPos) {
                const dist = scoreCalcDist(scoreMyPos[0], scoreMyPos[1], it.lat, it.lng);
                distStr = '<span class="dst">' + scoreFormatDist(dist) + '</span>';
            }
            // rides実績表示
            const dbReal = scoreRealData[it.id];
            const ridesInfo = dbReal ? '<div class="rides-info">📈実績' + dbReal.rides + '件 平均¥' + dbReal.fare.toLocaleString() + '</div>' : '';

            h += '<div class="score-li' + (sel ? ' sel' : '') + '" style="' + dim + '" onclick="scoreSelect(\'' + it.id + '\')">' + rkHtml;
            h += '<div class="mid"><div class="nm">' + it.name + distStr + '</div>';
            h += '<div class="tg">' + it.s.tags + '</div>' + ridesInfo + '</div>';
            h += '<div class="sv"><div class="n" style="color:' + c + '">' + it.s.total + '</div>';
            h += '<button class="navi-btn" onclick="event.stopPropagation();scoreNavi(' + it.lat + ',' + it.lng + ',\'' + it.name.replace(/'/g, "\\'") + '\')">🚗</button></div></div>';
            if (sel) {
                const rCol = it.s.rc >= 0.5 ? 'var(--amber)' : it.s.rc > 0 ? 'var(--gray-400)' : '#475569';
                h += '<div class="score-dtl show"><div class="rs">' + it.s.rsn + '</div>';
                h += '<div class="bdr"><span class="bd" style="background:rgba(34,211,238,0.1);color:#22d3ee">人流' + it.s.fl + '</span>';
                h += '<span class="bd" style="background:rgba(52,211,153,0.1);color:#34d399">供給↓' + it.s.si + '</span>';
                h += '<span class="bd" style="background:rgba(167,139,250,0.1);color:#a78bfa">営業' + it.s.pt + '</span>';
                h += '<span class="bd" style="background:rgba(251,146,60,0.1);color:#fb923c">実績' + it.s.rl + '</span></div>';
                h += '<div class="rl" style="color:' + rCol + '">' + (it.s.rc > 0 ? '📊' : '🔍') + ' ' + it.s.rL + '</div></div>';
            }
        });
        document.getElementById('scoreSbList').innerHTML = h;
    }

    function scrollToScoreItem(id) {
        setTimeout(() => { const el = document.querySelector('.score-li.sel'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 50);
    }

    // コントロール
    window.scoreSelect = function(id) { scoreSelId = scoreSelId === id ? null : id; const it = SCORE_POINTS.find(p => p.id === id); if (it) scoreMap.panTo([it.lat, it.lng], { animate: true, duration: 0.3 }); renderScoreMap(); };
    window.scoreStepTime = function(dir) { scoreHour = Math.max(0, Math.min(23, Math.round(scoreHour) + dir)); document.getElementById('scoreTimeVal').textContent = String(scoreHour).padStart(2, '0') + ':00'; renderScoreMap(); };
    window.scoreSetDay = function(d) { scoreDay = d; document.querySelectorAll('.score-pb[data-d]').forEach(b => b.className = b.dataset.d === d ? 'score-pb d-on' : 'score-pb'); renderScoreMap(); };
    window.scoreSetMode = function(m) { scoreMode = m; document.getElementById('scoreModeAnaba').className = m === 'anaba' ? 'score-pb m-gem' : 'score-pb'; document.getElementById('scoreModeStd').className = m === 'std' ? 'score-pb m-std' : 'score-pb'; renderScoreMap(); };

    // デバッグ用: rides連携の状態を確認
    window.debugRidesData = function() {
        console.log('========== 🔍 rides連携デバッグ ==========');
        console.log('📦 scoreRealData (ridesテーブルから取得したデータ):');
        if (Object.keys(scoreRealData).length === 0) {
            console.warn('⚠️ scoreRealDataは空です。ridesテーブルからのデータ取得に失敗している可能性があります。');
        } else {
            console.table(Object.entries(scoreRealData).map(([id, s]) => ({
                エリアID: id,
                乗車数: s.rides,
                平均運賃: '¥' + s.fare.toLocaleString(),
                時間帯: Object.keys(s.hours).join(',') + '時'
            })));
        }
        console.log('\n📊 各エリアのスコア計算（rides実績反映状況）:');
        const hh = Math.floor(scoreHour) % 24;
        SCORE_POINTS.forEach(p => {
            const dbReal = scoreRealData[p.id];
            const s = scoreCalc(p);
            const source = dbReal ? '🔄 ridesテーブル' : (p.real && p.real.rides > 0 ? '📝 ハードコード' : '❌ なし');
            console.log(p.name + ' [' + p.id + ']: スコア=' + s.total + ', 実績スコア=' + s.rl + ', 実績ラベル="' + s.rL + '", データソース=' + source);
        });
        console.log('==========================================');
    };
    console.log('💡 デバッグ: コンソールで debugRidesData() を実行するとrides連携の状態を確認できます');

    window.scoreGoGPS = function() {
        if (!navigator.geolocation) return;
        scoreFollowing = true; // 追従再開
        navigator.geolocation.getCurrentPosition(
            (p) => {
                scoreMyPos = [p.coords.latitude, p.coords.longitude];
                scoreMap.setView(scoreMyPos, 14);
                // 現在地マーカー更新（divIcon）
                if (scoreLocationMarker) scoreMap.removeLayer(scoreLocationMarker);
                const icon = L.divIcon({
                    className: '',
                    html: '<div class="current-location-marker"></div>',
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                });
                scoreLocationMarker = L.marker(scoreMyPos, { icon, interactive: false }).addTo(scoreMap);
                renderScoreMap();
            },
            handleScoreGPSError,
            SCORE_GPS_OPTIONS
        );
    };
    window.scoreNavi = function(lat, lng, name) {
        openYahooNavi(lat, lng, name);
    };

    // ========================================
    // NAVI TAB - Map with Events, Hotels, Long Spots
    // ========================================
    let longMap = null, naviMarkers = [], naviCurrentLocation = null;
    let naviFilters = { event: true, hotel: true, long: true };
    let naviEvents = [];
    let naviOpenList = null; // 'event' or 'hotel' or null
    let naviUpdateInterval = null;
    let naviSheetStartY = 0, naviSheetDragging = false;
    let naviSidebarTab = 'event'; // Sidebar active tab
    const naviTabletQuery = window.matchMedia('(min-width: 768px)');

    // Optimal position state
    let naviWatchId = null;
    let naviUserLat = null, naviUserLng = null;
    let naviOptimalMarker = null;
    let naviOptimalLine = null;
    let naviFollowing = true; // GPS追従モード

    // Calculate distance in km using Haversine formula
    function getDistanceKm(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Calculate score for a spot (0-100)
    function calculateSpotScore(spot, userLat, userLng) {
        let score = 0;
        const now = new Date();

        if (spot.type === 'event') {
            // Event scoring: time remaining + people + distance
            const mins = getEventMinutesRemaining(spot.endTime);
            // Time factor: best at 15-30 mins before end (max 40 points)
            if (mins >= 10 && mins <= 45) {
                score += 40 - Math.abs(mins - 25);
            } else if (mins >= 0 && mins < 10) {
                score += 25 - (10 - mins) * 2;
            } else if (mins > 45 && mins <= 90) {
                score += 20;
            }
            // People factor (max 30 points)
            if (spot.people) {
                score += Math.min(30, spot.people / 500);
            }
            // Distance factor (max 30 points, closer is better)
            if (userLat && userLng && spot.lat && spot.lng) {
                const dist = getDistanceKm(userLat, userLng, spot.lat, spot.lng);
                score += Math.max(0, 30 - dist * 3);
            } else {
                score += 15; // Default if no location
            }
        } else if (spot.type === 'hotel') {
            // Hotel scoring: checkout time proximity + rooms + distance
            const checkoutMins = getMinutesToTime(spot.checkout || '11:00');
            // Best timing: 30 mins before checkout (max 35 points)
            if (checkoutMins >= 0 && checkoutMins <= 60) {
                score += 35 - Math.abs(checkoutMins - 20);
            } else if (checkoutMins > 60 && checkoutMins <= 120) {
                score += 15;
            }
            // Rooms factor (max 35 points)
            if (spot.rooms) {
                score += Math.min(35, spot.rooms / 30);
            }
            // Distance factor (max 30 points)
            if (userLat && userLng && spot.lat && spot.lng) {
                const dist = getDistanceKm(userLat, userLng, spot.lat, spot.lng);
                score += Math.max(0, 30 - dist * 3);
            } else {
                score += 15;
            }
        } else if (spot.type === 'long') {
            // Long spot scoring: time of day + average fare + frequency + distance
            const hour = now.getHours();
            // Time factor (max 30 points) - better at night
            if (hour >= 22 || hour < 4) {
                score += 30;
            } else if (hour >= 18 && hour < 22) {
                score += 20;
            } else {
                score += 10;
            }
            // Fare factor (max 35 points)
            if (spot.avgFare) {
                score += Math.min(35, spot.avgFare / 300);
            }
            // Frequency factor (max 15 points)
            if (spot.freq === '高') score += 15;
            else if (spot.freq === '中') score += 10;
            else score += 5;
            // Distance factor (max 20 points)
            if (userLat && userLng && spot.lat && spot.lng) {
                const dist = getDistanceKm(userLat, userLng, spot.lat, spot.lng);
                score += Math.max(0, 20 - dist * 2);
            } else {
                score += 10;
            }
        }

        return Math.max(0, Math.min(100, Math.round(score)));
    }

    // Get minutes until a specific time (HH:MM format)
    function getMinutesToTime(timeStr) {
        if (!timeStr) return 999;
        const [h, m] = timeStr.split(':').map(Number);
        const now = new Date();
        const target = new Date(now);
        target.setHours(h, m, 0, 0);
        return Math.round((target - now) / 60000);
    }

    // Check if tablet layout
    function isNaviTablet() {
        return naviTabletQuery.matches;
    }

    // Initialize tablet layout handling
    function initNaviTablet() {
        // Handle layout changes
        naviTabletQuery.addEventListener('change', onNaviLayoutChange);
        updateNaviTabletHeader();
        // Update header clock every second
        setInterval(updateNaviTabletHeader, 1000);
    }

    // Handle layout change (rotation/resize)
    function onNaviLayoutChange() {
        if (longMap) {
            setTimeout(() => longMap.invalidateSize(), 100);
        }
        updateNaviLocationBtnPosition();
        renderNaviList();
        updateNaviRecommend();
    }

    // Update tablet header time
    function updateNaviTabletHeader() {
        const tabletTime = document.getElementById('headerTabletTime');
        const tabletDate = document.getElementById('headerTabletDate');
        const tabletClock = document.getElementById('headerTabletClock');
        if (!tabletTime) return;

        if (isNaviTablet()) {
            tabletTime.style.display = 'flex';
            const now = new Date();
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            tabletDate.textContent = `${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
            tabletClock.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        } else {
            tabletTime.style.display = 'none';
        }
    }

    // Toggle sidebar tab (tablet only)
    function toggleNaviSidebarTab(tab) {
        naviSidebarTab = tab;
        const eventTab = document.getElementById('navi-sidebar-tab-event');
        const hotelTab = document.getElementById('navi-sidebar-tab-hotel');
        const eventList = document.getElementById('navi-sidebar-list-event');
        const hotelList = document.getElementById('navi-sidebar-list-hotel');

        eventTab?.classList.toggle('active', tab === 'event');
        hotelTab?.classList.toggle('active', tab === 'hotel');
        eventList?.classList.toggle('active', tab === 'event');
        hotelList?.classList.toggle('active', tab === 'hotel');
    }

    // Hotel data for navi tab
    const NAVI_HOTELS = [
        { lat: 34.6932, lng: 135.5199, name: 'ニューオータニ', checkout: '11:00', rooms: 525, avgFare: 4500 },
        { lat: 34.6905, lng: 135.4849, name: 'リーガロイヤル', checkout: '11:00', rooms: 1039, avgFare: 5200 },
        { lat: 34.6965, lng: 135.4897, name: '帝国ホテル', checkout: '12:00', rooms: 381, avgFare: 6800 },
        { lat: 34.7005, lng: 135.4955, name: 'インターコンチネンタル', checkout: '11:00', rooms: 272, avgFare: 5500 },
        { lat: 34.6988, lng: 135.4903, name: 'ウェスティン大阪', checkout: '12:00', rooms: 303, avgFare: 5000 }
    ];

    // Long spot data for navi tab
    const NAVI_LONG_SPOTS = [
        { lat: 34.7025, lng: 135.4950, name: '北新地', desc: '終電後/繁華街', avgFare: 7500, freq: '高' },
        { lat: 34.6650, lng: 135.5015, name: '難波', desc: '繁華街/観光地', avgFare: 4500, freq: '高' },
        { lat: 34.7010, lng: 135.4975, name: '梅田', desc: '駅周辺/ビジネス', avgFare: 5000, freq: '中' },
        { lat: 34.6654, lng: 135.4324, name: 'USJ', desc: '閉園後', avgFare: 5500, freq: '中' },
        { lat: 34.6873, lng: 135.5320, name: '大阪城公園', desc: 'イベント後', avgFare: 4800, freq: '低' }
    ];

    function initLongMap() {
        if (longMap) return;
        longMap = L.map('long-map', { center: [34.6937, 135.5023], zoom: 13, zoomControl: false });
        L.control.zoom({ position: 'topright' }).addTo(longMap);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '© CartoDB', maxZoom: 18
        }).addTo(longMap);
        // ドラッグ時にGPS追従を停止
        longMap.on('dragstart', () => { naviFollowing = false; });
        fetchNaviEvents();
        initNaviSheetSwipe();
        initNaviTablet();
        initNaviGeolocation();
        updateNaviLocationBtnPosition();
        // Update every minute
        if (naviUpdateInterval) clearInterval(naviUpdateInterval);
        naviUpdateInterval = setInterval(() => {
            if (document.getElementById('long-content').classList.contains('active')) {
                renderNaviMap();
                renderNaviList();
                updateNaviRecommend();
            }
        }, 60000);
    }

    // Initialize sheet swipe handling
    function initNaviSheetSwipe() {
        const handle = document.querySelector('.navi-sheet-handle');
        if (!handle) return;

        handle.addEventListener('touchstart', onNaviSheetTouchStart, { passive: false });
        handle.addEventListener('touchmove', onNaviSheetTouchMove, { passive: false });
        handle.addEventListener('touchend', onNaviSheetTouchEnd, { passive: false });
        handle.addEventListener('click', onNaviSheetHandleClick);
    }

    function onNaviSheetTouchStart(e) {
        naviSheetDragging = true;
        naviSheetStartY = e.touches[0].clientY;
    }

    function onNaviSheetTouchMove(e) {
        if (!naviSheetDragging) return;
        e.preventDefault();
    }

    function onNaviSheetTouchEnd(e) {
        if (!naviSheetDragging) return;
        naviSheetDragging = false;

        const endY = e.changedTouches[0].clientY;
        const deltaY = endY - naviSheetStartY;

        if (deltaY > 50) {
            // Swiped down - close list and minimize sheet
            closeNaviList();
        } else if (deltaY < -50) {
            // Swiped up - expand list (event tab if none active)
            if (!naviOpenList) {
                toggleNaviList('event');
            }
        }
    }

    function onNaviSheetHandleClick() {
        // Toggle: if open, close; if closed, open event tab
        if (naviOpenList) {
            closeNaviList();
        } else {
            toggleNaviList('event');
        }
    }

    // Close all lists
    function closeNaviList() {
        naviOpenList = null;
        const eventWrap = document.getElementById('navi-list-wrap-event');
        const hotelWrap = document.getElementById('navi-list-wrap-hotel');
        const eventTab = document.getElementById('navi-tab-event');
        const hotelTab = document.getElementById('navi-tab-hotel');

        eventWrap?.classList.remove('open');
        hotelWrap?.classList.remove('open');
        eventTab?.classList.remove('active');
        hotelTab?.classList.remove('active');

        setTimeout(updateNaviLocationBtnPosition, 350);
    }

    // Update location button position based on sheet state
    function updateNaviLocationBtnPosition() {
        const btn = document.getElementById('navi-location-btn');
        const sheet = document.getElementById('navi-sheet');
        if (!btn || !sheet) return;
        const sheetHeight = sheet.offsetHeight;
        btn.style.bottom = (sheetHeight + 12) + 'px';
    }

    // Fetch today's events from Supabase
    async function fetchNaviEvents() {
        naviEvents = [];
        const now = new Date();
        const today = now.toISOString().split('T')[0];

        if (sb) {
            try {
                // Fetch from flow_events
                const { data: events } = await sb
                    .from('flow_events')
                    .select('*')
                    .eq('event_date', today);

                // Fetch from flow_manual_events
                const { data: manualEvents } = await sb
                    .from('flow_manual_events')
                    .select('*')
                    .eq('event_date', today);

                if (events) {
                    events.forEach(e => {
                        if (e.end_time) {
                            naviEvents.push({
                                venue: e.venue,
                                artist: e.artist || e.event_name || '',
                                endTime: e.end_time,
                                people: e.capacity || e.people || 0,
                                lat: VENUE_COORDS[e.venue]?.lat || AREA_COORDS[e.venue]?.lat,
                                lng: VENUE_COORDS[e.venue]?.lng || AREA_COORDS[e.venue]?.lng
                            });
                        }
                    });
                }

                if (manualEvents) {
                    manualEvents.forEach(e => {
                        if (e.end_time) {
                            naviEvents.push({
                                venue: e.venue,
                                artist: e.artist || e.event_name || '',
                                endTime: e.end_time,
                                people: e.capacity || e.people || 0,
                                lat: VENUE_COORDS[e.venue]?.lat || AREA_COORDS[e.venue]?.lat,
                                lng: VENUE_COORDS[e.venue]?.lng || AREA_COORDS[e.venue]?.lng
                            });
                        }
                    });
                }
            } catch (e) {
                console.warn('fetchNaviEvents error:', e);
            }
        }

        // Also use EVENTS from events tab if available
        if (EVENTS && EVENTS.length > 0) {
            EVENTS.forEach(e => {
                if (e.endTime && !naviEvents.find(n => n.venue === e.venue && n.endTime === e.endTime)) {
                    const coords = VENUE_COORDS[e.venue] || AREA_COORDS[e.venue];
                    if (coords) {
                        naviEvents.push({
                            venue: e.venue,
                            artist: e.artist || '',
                            endTime: e.endTime,
                            people: e.people || 0,
                            lat: coords.lat,
                            lng: coords.lng
                        });
                    }
                }
            });
        }

        renderNaviMap();
        renderNaviList();
        updateNaviRecommend();
    }

    // Get remaining minutes until event end
    function getEventMinutesRemaining(endTime) {
        const now = new Date();
        const [h, m] = endTime.split(':').map(Number);
        const endDate = new Date();
        endDate.setHours(h, m, 0, 0);
        const diff = (endDate - now) / 1000 / 60;
        return Math.round(diff);
    }

    // Toggle navi filter (map markers)
    function toggleNaviFilter(type) {
        naviFilters[type] = !naviFilters[type];
        const btn = document.getElementById(`navi-filter-${type}`);
        if (btn) {
            btn.classList.toggle('off', !naviFilters[type]);
        }
        renderNaviMap();
    }

    // Toggle navi list (tab tap to expand/collapse)
    function toggleNaviList(type) {
        const eventWrap = document.getElementById('navi-list-wrap-event');
        const hotelWrap = document.getElementById('navi-list-wrap-hotel');
        const eventTab = document.getElementById('navi-tab-event');
        const hotelTab = document.getElementById('navi-tab-hotel');

        if (naviOpenList === type) {
            // Close if same tab tapped
            naviOpenList = null;
            eventWrap?.classList.remove('open');
            hotelWrap?.classList.remove('open');
            eventTab?.classList.remove('active');
            hotelTab?.classList.remove('active');
        } else {
            // Open the tapped tab, close the other
            naviOpenList = type;
            eventWrap?.classList.toggle('open', type === 'event');
            hotelWrap?.classList.toggle('open', type === 'hotel');
            eventTab?.classList.toggle('active', type === 'event');
            hotelTab?.classList.toggle('active', type === 'hotel');
        }

        // Update location button position after a short delay
        setTimeout(updateNaviLocationBtnPosition, 350);
    }

    // Render navi map markers
    function renderNaviMap() {
        if (!longMap) return;

        // Clear existing markers
        naviMarkers.forEach(m => longMap.removeLayer(m));
        naviMarkers = [];

        // Event markers
        if (naviFilters.event) {
            naviEvents.forEach(e => {
                if (!e.lat || !e.lng) return;
                const mins = getEventMinutesRemaining(e.endTime);
                if (mins < 0) return; // Already ended

                let markerClass = 'later';
                if (mins <= 30) markerClass = 'urgent';
                else if (mins <= 60) markerClass = 'soon';

                const label = mins <= 60 ? `${mins}分 ${e.venue}` : e.venue;
                const icon = L.divIcon({
                    className: '',
                    html: `<div class="navi-marker ${markerClass}">${label}</div>`,
                    iconSize: [100, 32],
                    iconAnchor: [50, 32]
                });
                const marker = L.marker([e.lat, e.lng], { icon }).addTo(longMap);
                marker.bindPopup(`<div><div class="popup-area">${e.venue}</div><div class="popup-datetime">${e.artist}</div><div class="popup-datetime">終了: ${e.endTime} (${mins}分後)</div><button class="popup-navi-btn" onclick="openYahooNavi(${e.lat},${e.lng},'${e.venue.replace(/'/g, "\\'")}')">🚗 ナビで行く</button></div>`);
                naviMarkers.push(marker);
            });
        }

        // Hotel markers
        if (naviFilters.hotel) {
            NAVI_HOTELS.forEach(h => {
                const icon = L.divIcon({
                    className: '',
                    html: `<div class="navi-marker hotel">🏨 ${h.name}</div>`,
                    iconSize: [100, 32],
                    iconAnchor: [50, 32]
                });
                const marker = L.marker([h.lat, h.lng], { icon }).addTo(longMap);
                marker.bindPopup(`<div><div class="popup-area">🏨 ${h.name}</div><div class="popup-datetime">C/O ${h.checkout} / ${h.rooms}室</div><div class="popup-datetime">平均 ¥${h.avgFare.toLocaleString()}</div><button class="popup-navi-btn" onclick="openYahooNavi(${h.lat},${h.lng},'${h.name.replace(/'/g, "\\'")}')">🚗 ナビで行く</button></div>`);
                naviMarkers.push(marker);
            });
        }

        // Long spot markers
        if (naviFilters.long) {
            NAVI_LONG_SPOTS.forEach(s => {
                const icon = L.divIcon({
                    className: '',
                    html: `<div class="navi-marker long">💰 ${s.name}</div>`,
                    iconSize: [100, 32],
                    iconAnchor: [50, 32]
                });
                const marker = L.marker([s.lat, s.lng], { icon }).addTo(longMap);
                marker.bindPopup(`<div><div class="popup-area">💰 ${s.name}</div><div class="popup-datetime">${s.desc}</div><div class="popup-datetime">平均 ¥${s.avgFare.toLocaleString()} / 頻度: ${s.freq}</div><button class="popup-navi-btn" onclick="openYahooNavi(${s.lat},${s.lng},'${s.name.replace(/'/g, "\\'")}')">🚗 ナビで行く</button></div>`);
                naviMarkers.push(marker);
            });
        }
    }

    // Go to current location for navi map
    function goToNaviCurrentLocation() {
        if (!navigator.geolocation) {
            alert('位置情報がサポートされていません');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                if (longMap) {
                    longMap.setView([lat, lng], 14);

                    // Remove existing marker
                    if (naviCurrentLocation) {
                        longMap.removeLayer(naviCurrentLocation);
                    }

                    // Add current location marker
                    const icon = L.divIcon({
                        className: '',
                        html: '<div class="current-location-marker"></div>',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });
                    naviCurrentLocation = L.marker([lat, lng], { icon }).addTo(longMap);
                }
            },
            (error) => {
                console.warn('Geolocation error:', error);
                alert('位置情報を取得できませんでした');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    // Render navi list (both bottom sheet and sidebar)
    function renderNaviList() {
        renderNaviEventList();
        renderNaviHotelList();
        // Also render sidebar if tablet
        if (isNaviTablet()) {
            renderNaviSidebarEventList();
            renderNaviSidebarHotelList();
        }
    }

    // Render event list (bottom sheet)
    function renderNaviEventList() {
        const container = document.getElementById('navi-list-event');
        if (!container) return;

        const activeEvents = naviEvents
            .map(e => ({ ...e, mins: getEventMinutesRemaining(e.endTime) }))
            .filter(e => e.mins >= 0)
            .sort((a, b) => a.mins - b.mins);

        const countEl = document.getElementById('navi-event-count');
        if (countEl) countEl.textContent = activeEvents.length;

        if (activeEvents.length === 0) {
            container.innerHTML = '<div class="navi-empty">現在開催中のイベントはありません</div>';
            return;
        }

        let html = '';
        activeEvents.forEach(e => {
            let cardClass = '';
            let numClass = 'normal';
            if (e.mins <= 30) { cardClass = 'urgent'; numClass = 'urgent'; }
            else if (e.mins <= 60) { cardClass = 'soon'; numClass = 'soon'; }

            html += `
                <div class="navi-card ${cardClass}">
                    <div class="navi-card-countdown">
                        <div class="navi-card-countdown-num ${numClass}">${e.mins}</div>
                        <div class="navi-card-countdown-label">分後</div>
                    </div>
                    <div class="navi-card-info">
                        <div class="navi-card-venue">${e.venue}</div>
                        <div class="navi-card-detail">${e.artist || ''} ${e.endTime}終了</div>
                        <div class="navi-card-tags">
                            ${e.people ? `<span class="navi-card-tag people">👥 ${e.people.toLocaleString()}人</span>` : ''}
                        </div>
                    </div>
                    <button class="navi-card-btn" onclick="openYahooNavi(${e.lat},${e.lng},'${e.venue.replace(/'/g, "\\'")}')">
                        <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Render hotel/long list (bottom sheet)
    function renderNaviHotelList() {
        const container = document.getElementById('navi-list-hotel');
        if (!container) return;

        const totalCount = NAVI_HOTELS.length + NAVI_LONG_SPOTS.length;
        const countEl = document.getElementById('navi-hotel-count');
        if (countEl) countEl.textContent = totalCount;

        let html = '';

        NAVI_HOTELS.forEach(h => {
            html += `
                <div class="navi-card hotel">
                    <div class="navi-card-icon hotel">🏨</div>
                    <div class="navi-card-info">
                        <div class="navi-card-venue">${h.name}</div>
                        <div class="navi-card-detail">C/O ${h.checkout} / ${h.rooms}室</div>
                        <div class="navi-card-tags">
                            <span class="navi-card-tag fare">平均 ¥${h.avgFare.toLocaleString()}</span>
                        </div>
                    </div>
                    <button class="navi-card-btn" onclick="openYahooNavi(${h.lat},${h.lng},'${h.name.replace(/'/g, "\\'")}')">
                        <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    </button>
                </div>
            `;
        });

        NAVI_LONG_SPOTS.forEach(s => {
            html += `
                <div class="navi-card long">
                    <div class="navi-card-icon long">💰</div>
                    <div class="navi-card-info">
                        <div class="navi-card-venue">${s.name}</div>
                        <div class="navi-card-detail">${s.desc}</div>
                        <div class="navi-card-tags">
                            <span class="navi-card-tag fare">平均 ¥${s.avgFare.toLocaleString()}</span>
                            <span class="navi-card-tag freq">頻度: ${s.freq}</span>
                        </div>
                    </div>
                    <button class="navi-card-btn" onclick="openYahooNavi(${s.lat},${s.lng},'${s.name.replace(/'/g, "\\'")}')">
                        <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Render sidebar event list (tablet)
    function renderNaviSidebarEventList() {
        const container = document.getElementById('navi-sidebar-list-event');
        if (!container) return;

        const activeEvents = naviEvents
            .map(e => ({ ...e, mins: getEventMinutesRemaining(e.endTime) }))
            .filter(e => e.mins >= 0)
            .sort((a, b) => a.mins - b.mins);

        const countEl = document.getElementById('navi-sidebar-event-count');
        if (countEl) countEl.textContent = activeEvents.length;

        if (activeEvents.length === 0) {
            container.innerHTML = '<div class="navi-sidebar-empty">現在開催中のイベントはありません</div>';
            return;
        }

        let html = '';
        activeEvents.forEach(e => {
            let cardClass = '';
            let numClass = 'normal';
            if (e.mins <= 30) { cardClass = 'urgent'; numClass = 'urgent'; }
            else if (e.mins <= 60) { cardClass = 'soon'; numClass = 'soon'; }

            html += `
                <div class="navi-sidebar-card ${cardClass}">
                    <div class="navi-sidebar-card-countdown">
                        <div class="navi-sidebar-card-countdown-num ${numClass}">${e.mins}</div>
                        <div class="navi-sidebar-card-countdown-label">分後</div>
                    </div>
                    <div class="navi-sidebar-card-info">
                        <div class="navi-sidebar-card-venue">${e.venue}</div>
                        <div class="navi-sidebar-card-detail">${e.artist || ''} ${e.endTime}終了</div>
                        <div class="navi-sidebar-card-tags">
                            ${e.people ? `<span class="navi-sidebar-card-tag people">👥 ${e.people.toLocaleString()}人</span>` : ''}
                        </div>
                    </div>
                    <button class="navi-sidebar-card-btn" onclick="openYahooNavi(${e.lat},${e.lng},'${e.venue.replace(/'/g, "\\'")}')">
                        <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Render sidebar hotel/long list (tablet)
    function renderNaviSidebarHotelList() {
        const container = document.getElementById('navi-sidebar-list-hotel');
        if (!container) return;

        const totalCount = NAVI_HOTELS.length + NAVI_LONG_SPOTS.length;
        const countEl = document.getElementById('navi-sidebar-hotel-count');
        if (countEl) countEl.textContent = totalCount;

        let html = '<div class="navi-sidebar-section">🏨 ホテル</div>';

        NAVI_HOTELS.forEach(h => {
            html += `
                <div class="navi-sidebar-card hotel">
                    <div class="navi-sidebar-card-icon hotel">🏨</div>
                    <div class="navi-sidebar-card-info">
                        <div class="navi-sidebar-card-venue">${h.name}</div>
                        <div class="navi-sidebar-card-detail">C/O ${h.checkout} / ${h.rooms}室</div>
                        <div class="navi-sidebar-card-tags">
                            <span class="navi-sidebar-card-tag fare">平均 ¥${h.avgFare.toLocaleString()}</span>
                        </div>
                    </div>
                    <button class="navi-sidebar-card-btn" onclick="openYahooNavi(${h.lat},${h.lng},'${h.name.replace(/'/g, "\\'")}')">
                        <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    </button>
                </div>
            `;
        });

        html += '<div class="navi-sidebar-section">💰 ロングスポット</div>';

        NAVI_LONG_SPOTS.forEach(s => {
            html += `
                <div class="navi-sidebar-card long">
                    <div class="navi-sidebar-card-icon long">💰</div>
                    <div class="navi-sidebar-card-info">
                        <div class="navi-sidebar-card-venue">${s.name}</div>
                        <div class="navi-sidebar-card-detail">${s.desc}</div>
                        <div class="navi-sidebar-card-tags">
                            <span class="navi-sidebar-card-tag fare">平均 ¥${s.avgFare.toLocaleString()}</span>
                            <span class="navi-sidebar-card-tag freq">頻度: ${s.freq}</span>
                        </div>
                    </div>
                    <button class="navi-sidebar-card-btn" onclick="openYahooNavi(${s.lat},${s.lng},'${s.name.replace(/'/g, "\\'")}')">
                        <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Update optimal position card (both bottom sheet and sidebar)
    function updateOptimalPosition() {
        // Collect all scorable spots
        const allSpots = [];

        // Add active events
        naviEvents.forEach(e => {
            const mins = getEventMinutesRemaining(e.endTime);
            if (mins >= -30 && mins <= 120) { // Include events ending soon or in next 2 hours
                allSpots.push({
                    type: 'event',
                    name: e.venue,
                    lat: e.lat,
                    lng: e.lng,
                    endTime: e.endTime,
                    people: e.people,
                    mins: mins
                });
            }
        });

        // Add hotels (during checkout hours)
        const now = new Date();
        const hour = now.getHours();
        if (hour >= 9 && hour <= 13) {
            NAVI_HOTELS.forEach(h => {
                allSpots.push({
                    type: 'hotel',
                    name: h.name,
                    lat: h.lat,
                    lng: h.lng,
                    checkout: h.checkout,
                    rooms: h.rooms,
                    avgFare: h.avgFare
                });
            });
        }

        // Add long spots (evening/night or when few events)
        if (hour >= 18 || hour < 6 || allSpots.length < 2) {
            NAVI_LONG_SPOTS.forEach(s => {
                allSpots.push({
                    type: 'long',
                    name: s.name,
                    lat: s.lat,
                    lng: s.lng,
                    desc: s.desc,
                    avgFare: s.avgFare,
                    freq: s.freq
                });
            });
        }

        // Score and sort
        const scored = allSpots.map(spot => ({
            ...spot,
            score: calculateSpotScore(spot, naviUserLat, naviUserLng)
        })).sort((a, b) => b.score - a.score);

        // Get top spot
        const top = scored[0];

        // Update both mobile and sidebar cards
        updateOptimalCard('navi-', top, scored);
        updateOptimalCard('navi-sidebar-', top, scored);

        // Update map marker for top spot
        updateOptimalMarker(top);
    }

    // Update a single optimal card (prefix: '' for mobile, 'navi-sidebar-' for sidebar)
    function updateOptimalCard(prefix, top, scored) {
        const wrapEl = document.getElementById(prefix + 'optimal-wrap');
        const cardEl = document.getElementById(prefix + 'optimal-top1');
        const emptyEl = document.getElementById(prefix + 'optimal-empty');
        const venueEl = document.getElementById(prefix + 'optimal-venue');
        const reasonEl = document.getElementById(prefix + 'optimal-reason');
        const badgeEl = document.getElementById(prefix + 'optimal-badge');
        const scoreFillEl = document.getElementById(prefix + 'optimal-score-fill');
        const scoreDotEl = document.getElementById(prefix + 'optimal-score-dot');
        const scoreNumEl = document.getElementById(prefix + 'optimal-score');
        const etaEl = document.getElementById(prefix + 'optimal-eta');
        const countdownEl = document.getElementById(prefix + 'optimal-countdown');
        const btnEl = document.getElementById(prefix + 'optimal-btn');

        if (!top) {
            if (cardEl) cardEl.style.display = 'none';
            if (emptyEl) emptyEl.style.display = 'flex';
            return;
        }

        if (cardEl) cardEl.style.display = 'block';
        if (emptyEl) emptyEl.style.display = 'none';

        // Venue name with type styling
        if (venueEl) {
            venueEl.textContent = top.name;
            venueEl.className = 'navi-optimal-venue ' + top.type;
        }

        // Reason text
        if (reasonEl) {
            let reason = '';
            if (top.type === 'event') {
                reason = `${top.mins}分後終了`;
                if (top.people) reason += ` / ${top.people.toLocaleString()}人`;
            } else if (top.type === 'hotel') {
                const checkoutMins = getMinutesToTime(top.checkout);
                reason = `C/O ${top.checkout}`;
                if (checkoutMins > 0) reason += ` (${checkoutMins}分後)`;
                if (top.rooms) reason += ` / ${top.rooms}室`;
            } else if (top.type === 'long') {
                reason = top.desc || '高需要エリア';
                if (top.avgFare) reason += ` / 平均¥${top.avgFare.toLocaleString()}`;
            }
            reasonEl.textContent = reason;
        }

        // Badge
        if (badgeEl) {
            if (top.score >= 70) {
                badgeEl.textContent = 'HOT';
                badgeEl.className = 'navi-optimal-badge hot';
            } else if (top.score >= 50) {
                badgeEl.textContent = '高';
                badgeEl.className = 'navi-optimal-badge high';
            } else {
                badgeEl.textContent = '中';
                badgeEl.className = 'navi-optimal-badge mid';
            }
        }

        // Score bar
        if (scoreFillEl) {
            scoreFillEl.style.width = top.score + '%';
            if (top.score >= 70) scoreFillEl.className = 'navi-optimal-score-fill green';
            else if (top.score >= 50) scoreFillEl.className = 'navi-optimal-score-fill orange';
            else if (top.score >= 30) scoreFillEl.className = 'navi-optimal-score-fill yellow';
            else scoreFillEl.className = 'navi-optimal-score-fill gray';
        }
        if (scoreDotEl) {
            scoreDotEl.style.left = top.score + '%';
        }
        if (scoreNumEl) {
            scoreNumEl.textContent = top.score;
        }

        // ETA (distance)
        if (etaEl) {
            if (naviUserLat && naviUserLng && top.lat && top.lng) {
                const dist = getDistanceKm(naviUserLat, naviUserLng, top.lat, top.lng);
                const eta = Math.round(dist * 3); // Roughly 3 min per km
                etaEl.textContent = `📍 ${dist.toFixed(1)}km / 約${eta}分`;
            } else {
                etaEl.textContent = '📍 --';
            }
        }

        // Countdown
        if (countdownEl) {
            if (top.type === 'event' && top.mins !== undefined) {
                countdownEl.textContent = `⏱ ${top.mins}分`;
            } else if (top.type === 'hotel') {
                const mins = getMinutesToTime(top.checkout);
                if (mins > 0 && mins < 180) {
                    countdownEl.textContent = `⏱ ${mins}分`;
                } else {
                    countdownEl.textContent = '';
                }
            } else {
                countdownEl.textContent = '';
            }
        }

        // Navi button (Yahoo!カーナビ優先)
        if (btnEl && top.lat && top.lng) {
            btnEl.onclick = () => openYahooNavi(top.lat, top.lng, top.name || '');
        }
    }

    // Update map marker for optimal spot
    function updateOptimalMarker(top) {
        if (!longMap) return;

        // Remove existing marker and line
        if (naviOptimalMarker) {
            longMap.removeLayer(naviOptimalMarker);
            naviOptimalMarker = null;
        }
        if (naviOptimalLine) {
            longMap.removeLayer(naviOptimalLine);
            naviOptimalLine = null;
        }

        if (!top || !top.lat || !top.lng) return;

        // Add pulse marker for top spot
        const pulseIcon = L.divIcon({
            className: '',
            html: `<div class="optimal-pulse-marker ${top.type}"></div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        naviOptimalMarker = L.marker([top.lat, top.lng], { icon: pulseIcon }).addTo(longMap);

        // Add dashed line from user to spot
        if (naviUserLat && naviUserLng) {
            naviOptimalLine = L.polyline(
                [[naviUserLat, naviUserLng], [top.lat, top.lng]],
                { color: '#00e676', weight: 2, dashArray: '8, 8', opacity: 0.7 }
            ).addTo(longMap);
        }
    }

    // Start watching user location for optimal position
    function initNaviGeolocation() {
        if (!navigator.geolocation) return;

        // 現在地マーカー更新用関数
        const updateNaviLocationMarker = () => {
            if (!longMap || !naviUserLat || !naviUserLng) return;
            if (naviCurrentLocation) longMap.removeLayer(naviCurrentLocation);
            const icon = L.divIcon({
                className: '',
                html: '<div class="current-location-marker"></div>',
                iconSize: [26, 26],
                iconAnchor: [13, 13]
            });
            naviCurrentLocation = L.marker([naviUserLat, naviUserLng], { icon, interactive: false }).addTo(longMap);
        };

        // Initial position
        naviFollowing = true;
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                naviUserLat = pos.coords.latitude;
                naviUserLng = pos.coords.longitude;
                longMap.setView([naviUserLat, naviUserLng], 14);
                updateNaviLocationMarker();
                updateOptimalPosition();
            },
            () => {
                // Use default location (Osaka center)
                naviUserLat = 34.6937;
                naviUserLng = 135.5023;
                updateOptimalPosition();
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );

        // Watch position updates
        naviWatchId = navigator.geolocation.watchPosition(
            (pos) => {
                naviUserLat = pos.coords.latitude;
                naviUserLng = pos.coords.longitude;
                updateNaviLocationMarker();
                // 追従モード時は自動センタリング
                if (naviFollowing) longMap.setView([naviUserLat, naviUserLng], longMap.getZoom());
                updateOptimalPosition();
            },
            () => {},
            { enableHighAccuracy: true, timeout: 30000, maximumAge: 60000 }
        );
    }

    // Legacy function name for compatibility
    function updateNaviRecommend() {
        updateOptimalPosition();
    }

    // Go to current location (navi tab)
    function goToNaviCurrentLocation() {
        if (!navigator.geolocation) {
            alert('位置情報がサポートされていません');
            return;
        }

        naviFollowing = true; // 追従再開
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                naviUserLat = lat;
                naviUserLng = lng;

                if (longMap) {
                    longMap.setView([lat, lng], 14);

                    if (naviCurrentLocation) {
                        longMap.removeLayer(naviCurrentLocation);
                    }

                    const icon = L.divIcon({
                        className: '',
                        html: '<div class="current-location-marker"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    });
                    naviCurrentLocation = L.marker([lat, lng], { icon, interactive: false }).addTo(longMap);
                }
            },
            (error) => {
                console.warn('Geolocation error:', error);
                alert('位置情報を取得できませんでした');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    // ========================================
    // DASHBOARD TAB
    // ========================================
    let revenueChart = null, timeChart = null;
    let dashboardPeriod = 'daily';
    let TAXI_LOGS = [];

    // Sample data (fallback when Supabase is unavailable)
    const SAMPLE_TAXI_LOGS = [
        { ride_date: '2026-02-11', ride_time: '07:20', app: 'uber', fare: 2400, area: '梅田' },
        { ride_date: '2026-02-11', ride_time: '09:45', app: 'didi', fare: 1800, area: 'なんば' },
        { ride_date: '2026-02-11', ride_time: '12:30', app: 'uber', fare: 3200, area: '北新地' },
        { ride_date: '2026-02-11', ride_time: '14:20', app: 'nagashi', fare: 2100, area: '天王寺' },
        { ride_date: '2026-02-11', ride_time: '19:30', app: 'uber', fare: 5400, area: '大阪城公園' },
        { ride_date: '2026-02-11', ride_time: '21:15', app: 'didi', fare: 4800, area: '中之島' },
        { ride_date: '2026-02-11', ride_time: '23:40', app: 'uber', fare: 7200, area: '北新地' },
        { ride_date: '2026-02-10', ride_time: '08:00', app: 'uber', fare: 3100, area: '梅田' },
        { ride_date: '2026-02-10', ride_time: '11:30', app: 'didi', fare: 2200, area: 'USJ' },
        { ride_date: '2026-02-10', ride_time: '18:45', app: 'uber', fare: 6200, area: '京セラドーム' },
        { ride_date: '2026-02-10', ride_time: '22:00', app: 'nagashi', fare: 4500, area: '北新地' },
        { ride_date: '2026-02-09', ride_time: '07:30', app: 'uber', fare: 2800, area: '新大阪' },
        { ride_date: '2026-02-09', ride_time: '13:00', app: 'didi', fare: 1900, area: '天王寺' },
        { ride_date: '2026-02-09', ride_time: '20:30', app: 'uber', fare: 5800, area: '大阪城公園' },
        { ride_date: '2026-02-08', ride_time: '09:00', app: 'nagashi', fare: 3500, area: '梅田' },
        { ride_date: '2026-02-08', ride_time: '15:30', app: 'uber', fare: 2600, area: 'なんば' },
        { ride_date: '2026-02-08', ride_time: '21:00', app: 'didi', fare: 7100, area: '中之島' },
        { ride_date: '2026-02-07', ride_time: '10:00', app: 'uber', fare: 2200, area: '天王寺' },
        { ride_date: '2026-02-07', ride_time: '19:00', app: 'uber', fare: 8500, area: '北新地' },
        { ride_date: '2026-02-06', ride_time: '08:30', app: 'didi', fare: 2900, area: '新大阪' },
        { ride_date: '2026-02-06', ride_time: '17:00', app: 'nagashi', fare: 4200, area: 'USJ' },
        { ride_date: '2026-02-05', ride_time: '12:00', app: 'uber', fare: 3300, area: '梅田' },
        { ride_date: '2026-02-05', ride_time: '20:00', app: 'uber', fare: 6800, area: '京セラドーム' }
    ];

    // Fetch taxi logs from Supabase (always fetch 30 days)
    async function fetchTaxiLogs() {
        if (!sb) return [];
        try {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const monthAgo = new Date(today);
            monthAgo.setDate(monthAgo.getDate() - 30);
            const fromDate = monthAgo.toISOString().split('T')[0];

            const { data: logs } = await sb
                .from('flow_taxi_logs')
                .select('*')
                .gte('ride_date', fromDate)
                .lte('ride_date', todayStr)
                .order('ride_date', { ascending: false })
                .order('ride_time', { ascending: false });

            if (logs && logs.length > 0) {
                console.log(`✅ Loaded ${logs.length} taxi logs from Supabase`);
                return logs;
            }
            return [];
        } catch (e) {
            console.warn('fetchTaxiLogs error:', e);
            return [];
        }
    }

    // Get time period from ride_time
    function getTimePeriod(time) {
        if (!time) return 'day';
        const h = parseInt(time.split(':')[0]);
        if (h >= 5 && h < 10) return 'morning';
        if (h >= 10 && h < 17) return 'day';
        if (h >= 17 && h < 22) return 'evening';
        return 'night';
    }

    // Process logs for dashboard display
    function processDashboardData(logs) {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        let filteredLogs = logs;

        if (dashboardPeriod === 'daily') {
            filteredLogs = logs.filter(l => l.ride_date === todayStr);
        } else if (dashboardPeriod === 'weekly') {
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            filteredLogs = logs.filter(l => l.ride_date >= weekAgoStr);
        }
        // monthly uses all logs

        // Build chart labels and data
        let labels = [];
        let chartData = [];

        if (dashboardPeriod === 'daily') {
            labels = ['6時', '9時', '12時', '15時', '18時', '21時', '24時'];
            const hourBuckets = [0, 0, 0, 0, 0, 0, 0];
            filteredLogs.forEach(l => {
                const h = parseInt((l.ride_time || '12:00').split(':')[0]);
                if (h < 9) hourBuckets[0] += l.fare;
                else if (h < 12) hourBuckets[1] += l.fare;
                else if (h < 15) hourBuckets[2] += l.fare;
                else if (h < 18) hourBuckets[3] += l.fare;
                else if (h < 21) hourBuckets[4] += l.fare;
                else if (h < 24) hourBuckets[5] += l.fare;
                else hourBuckets[6] += l.fare;
            });
            chartData = hourBuckets;
        } else if (dashboardPeriod === 'weekly') {
            labels = ['月', '火', '水', '木', '金', '土', '日'];
            const dayBuckets = [0, 0, 0, 0, 0, 0, 0];
            filteredLogs.forEach(l => {
                const d = new Date(l.ride_date);
                const dayIndex = (d.getDay() + 6) % 7; // Monday = 0
                dayBuckets[dayIndex] += l.fare;
            });
            chartData = dayBuckets;
        } else {
            labels = ['第1週', '第2週', '第3週', '第4週'];
            const weekBuckets = [0, 0, 0, 0];
            filteredLogs.forEach(l => {
                const d = new Date(l.ride_date);
                const dayOfMonth = d.getDate();
                const weekIndex = Math.min(3, Math.floor((dayOfMonth - 1) / 7));
                weekBuckets[weekIndex] += l.fare;
            });
            chartData = weekBuckets;
        }

        // Time period data
        const timeBuckets = { morning: 0, day: 0, evening: 0, night: 0 };
        filteredLogs.forEach(l => {
            const period = getTimePeriod(l.ride_time);
            timeBuckets[period] += l.fare;
        });
        const timeData = {
            labels: ['朝', '昼', '夕', '夜'],
            data: [timeBuckets.morning, timeBuckets.day, timeBuckets.evening, timeBuckets.night]
        };

        return {
            labels,
            data: chartData,
            rides: filteredLogs.map(l => ({
                app: l.app || 'nagashi',
                fare: l.fare || 0,
                area: l.area || '不明',
                time: l.ride_time || ''
            })),
            timeData
        };
    }

    async function initDashboard() {
        // Fetch from Supabase or use sample data
        const fetched = await fetchTaxiLogs();
        if (fetched && fetched.length > 0) {
            TAXI_LOGS = fetched;
        } else {
            TAXI_LOGS = SAMPLE_TAXI_LOGS;
            console.log('📊 Using sample taxi logs');
        }
        renderDashboard();
    }

    function renderDashboard() {
        const processed = processDashboardData(TAXI_LOGS);
        const data = processed;
        const timeData = processed.timeData;

        // Calculate totals
        const totalRevenue = data.data.reduce((s, v) => s + v, 0);
        const totalRides = data.rides.length;
        const avgFare = totalRides > 0 ? Math.round(totalRevenue / totalRides) : 0;
        const longRides = data.rides.filter(r => r.fare >= 3000).length;
        const longRate = totalRides > 0 ? Math.round((longRides / totalRides) * 100) : 0;

        // App breakdown
        const uberTotal = data.rides.filter(r => r.app === 'uber').reduce((s, r) => s + r.fare, 0);
        const didiTotal = data.rides.filter(r => r.app === 'didi').reduce((s, r) => s + r.fare, 0);
        const nagashiTotal = data.rides.filter(r => r.app === 'nagashi').reduce((s, r) => s + r.fare, 0);

        // Update summary cards
        document.getElementById('totalRevenue').textContent = `¥${totalRevenue.toLocaleString()}`;
        document.getElementById('totalRides').textContent = totalRides;
        document.getElementById('avgFare').textContent = `¥${avgFare.toLocaleString()}`;
        document.getElementById('longRate').textContent = `${longRate}%`;

        // Comparison text (show period label only, actual comparison requires more historical data)
        const periodLabel = dashboardPeriod === 'daily' ? '今日' : dashboardPeriod === 'weekly' ? '過去7日間' : '過去30日間';
        document.getElementById('revenueCompare').textContent = periodLabel;
        document.getElementById('ridesCompare').textContent = periodLabel;
        document.getElementById('avgCompare').textContent = periodLabel;

        // App breakdown
        document.getElementById('uberRevenue').textContent = `¥${(uberTotal/1000).toFixed(0)}k`;
        document.getElementById('didiRevenue').textContent = `¥${(didiTotal/1000).toFixed(0)}k`;
        document.getElementById('nagashiRevenue').textContent = `¥${(nagashiTotal/1000).toFixed(0)}k`;
        document.getElementById('uberPct').textContent = totalRevenue > 0 ? `${Math.round(uberTotal/totalRevenue*100)}%` : '0%';
        document.getElementById('didiPct').textContent = totalRevenue > 0 ? `${Math.round(didiTotal/totalRevenue*100)}%` : '0%';
        document.getElementById('nagashiPct').textContent = totalRevenue > 0 ? `${Math.round(nagashiTotal/totalRevenue*100)}%` : '0%';

        // Revenue Chart
        if (revenueChart) revenueChart.destroy();
        const ctx1 = document.getElementById('revenueChart').getContext('2d');
        revenueChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '売上',
                    data: data.data,
                    borderColor: '#14b8a6',
                    backgroundColor: 'rgba(20, 184, 166, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#14b8a6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 10 }, callback: v => `¥${(v/1000).toFixed(0)}k` } }
                }
            }
        });

        // Time Chart
        if (timeChart) timeChart.destroy();
        const ctx2 = document.getElementById('timeChart').getContext('2d');
        timeChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: timeData.labels,
                datasets: [{
                    label: '売上',
                    data: timeData.data,
                    backgroundColor: ['#f59e0b', '#0ea5e9', '#f97316', '#6366f1'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 11 } } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 10 }, callback: v => `¥${(v/1000).toFixed(0)}k` } }
                }
            }
        });

        // Area Ranking
        const areaMap = {};
        data.rides.forEach(r => {
            if (!areaMap[r.area]) areaMap[r.area] = { total: 0, count: 0 };
            areaMap[r.area].total += r.fare;
            areaMap[r.area].count += r.count || 1;
        });
        const areaRanking = Object.entries(areaMap)
            .map(([area, data]) => ({ area, ...data }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);

        const rankClasses = ['gold', 'silver', 'bronze', 'normal', 'normal'];
        document.getElementById('areaRanking').innerHTML = areaRanking.map((item, i) => `
            <div class="ranking-item">
                <div class="ranking-rank ${rankClasses[i]}">${i + 1}</div>
                <div class="ranking-info">
                    <div class="ranking-name">${item.area}</div>
                    <div class="ranking-detail">${item.count}件</div>
                </div>
                <div class="ranking-value">¥${item.total.toLocaleString()}</div>
            </div>
        `).join('');
    }

    // Dashboard period tabs
    document.querySelectorAll('.period-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            dashboardPeriod = this.dataset.period;
            renderDashboard();
        });
    });

    // ========================================
    // LINE Paste Modal
    // ========================================
    const VENUE_KEYWORDS = {
        '城ホール': { category: 'concert', rank: 'S', fullName: '大阪城ホール' },
        '京セラドーム': { category: 'concert', rank: 'S', fullName: '京セラドーム大阪' },
        'フェスティバルホール': { category: 'concert', rank: 'A', fullName: 'フェスティバルホール' },
        'USJ': { category: 'facility', rank: 'B', fullName: 'USJ' },
        '海遊館': { category: 'facility', rank: 'B', fullName: '海遊館' },
        'ニューオータニ': { category: 'hotel', rank: 'A', fullName: 'ホテルニューオータニ大阪' },
        'リーガロイヤル': { category: 'hotel', rank: 'A', fullName: 'リーガロイヤルホテル' },
        '帝国ホテル': { category: 'hotel', rank: 'A', fullName: '帝国ホテル大阪' },
        'オリックス劇場': { category: 'concert', rank: 'A', fullName: 'オリックス劇場' },
        'ZEPP': { category: 'concert', rank: 'A', fullName: 'Zepp Namba' },
        'インテックス': { category: 'facility', rank: 'A', fullName: 'インテックス大阪' },
        'スカイビル': { category: 'facility', rank: 'B', fullName: '梅田スカイビル' },
        '天王寺動物': { category: 'facility', rank: 'B', fullName: '天王寺動物園' }
    };

    const fabBtn = document.getElementById('fabBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const lineModal = document.getElementById('lineModal');

    // LINE Modal functions
    function openLineModal() { modalOverlay.classList.add('active'); setTimeout(() => lineModal.classList.add('active'), 10); }
    function closeLineModal() {
        lineModal.classList.remove('active');
        setTimeout(() => {
            modalOverlay.classList.remove('active');
            document.getElementById('lineTextarea').value = '';
            document.getElementById('parsePreview').classList.remove('active');
            document.getElementById('addEventBtn').style.display = 'none';
            document.getElementById('parseBtn').style.display = 'block';
            parsedEvents = [];
        }, 300);
    }

    // Taxi Log Modal
    const taxiModalOverlay = document.getElementById('taxiModalOverlay');
    const taxiModal = document.getElementById('taxiModal');
    let selectedApp = 'uber';

    function openTaxiModal() {
        // Set current time as default
        const now = new Date();
        document.getElementById('taxiTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        document.getElementById('taxiFrom').value = '';
        document.getElementById('taxiTo').value = '';
        document.getElementById('taxiFare').value = '';
        selectedApp = 'uber';
        document.querySelectorAll('.app-select-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.app-select-btn[data-app="uber"]').classList.add('active');

        taxiModalOverlay.classList.add('active');
        setTimeout(() => taxiModal.classList.add('active'), 10);
    }

    function closeTaxiModal() {
        taxiModal.classList.remove('active');
        setTimeout(() => taxiModalOverlay.classList.remove('active'), 300);
    }

    // App select buttons
    document.querySelectorAll('.app-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.app-select-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedApp = this.dataset.app;
        });
    });

    // Save taxi log
    document.getElementById('saveTaxiBtn').addEventListener('click', async () => {
        const time = document.getElementById('taxiTime').value;
        const from = document.getElementById('taxiFrom').value.trim();
        const fare = parseInt(document.getElementById('taxiFare').value);

        // Validation
        if (!time) { alert('乗車時刻を入力してください'); return; }
        if (!from) { alert('出発地を入力してください'); return; }
        if (!fare || fare <= 0) { alert('金額を入力してください'); return; }

        const today = new Date().toISOString().split('T')[0];
        const record = {
            ride_date: today,
            ride_time: time,
            area: from,
            fare: fare,
            app: selectedApp
        };

        // Save to Supabase
        if (sb) {
            try {
                const { error } = await sb.from('flow_taxi_logs').insert([record]);
                if (error) {
                    console.error('Save error:', error);
                    if (error.code === '42501') {
                        alert('保存に失敗しました。\nRLSポリシーの設定が必要です。');
                    } else {
                        alert('保存に失敗しました: ' + error.message);
                    }
                    return;
                }
                console.log('✅ Taxi log saved');
            } catch (e) {
                console.error('Save error:', e);
                alert('保存に失敗しました');
                return;
            }
        } else {
            console.log('📝 Taxi log (offline):', record);
        }

        // Close modal and refresh dashboard
        closeTaxiModal();

        // Add to local cache and refresh
        TAXI_LOGS.unshift(record);
        renderDashboard();

        // Show success feedback
        const btn = document.getElementById('saveTaxiBtn');
        btn.textContent = '✅ 保存しました';
        btn.style.background = '#22c55e';
        setTimeout(() => {
            btn.textContent = '保存する';
            btn.style.background = '';
        }, 1500);
    });

    // Taxi modal event listeners
    document.getElementById('taxiModalClose').addEventListener('click', closeTaxiModal);
    taxiModalOverlay.addEventListener('click', closeTaxiModal);
    taxiModal.addEventListener('click', e => e.stopPropagation());

    // FAB button - open different modal based on current tab
    function getCurrentTab() {
        const activeTab = document.querySelector('.tab.active');
        return activeTab ? activeTab.dataset.tab : 'events';
    }

    fabBtn.addEventListener('click', () => {
        if (getCurrentTab() === 'dashboard') {
            openTaxiModal();
        } else {
            openLineModal();
        }
    });

    document.getElementById('modalClose').addEventListener('click', closeLineModal);
    modalOverlay.addEventListener('click', closeLineModal);
    lineModal.addEventListener('click', e => e.stopPropagation());

    // Parse multiple events from text
    function parseEventsFromText(text) {
        const events = [];
        const lines = text.split('\n');
        let currentEvent = null;

        for (const line of lines) {
            // Check for venue keywords
            for (const [kw, info] of Object.entries(VENUE_KEYWORDS)) {
                if (line.includes(kw)) {
                    // Save previous event if exists
                    if (currentEvent && currentEvent.venue) {
                        events.push(currentEvent);
                    }
                    // Start new event
                    currentEvent = {
                        venue: kw,
                        venueFull: info.fullName,
                        category: info.category,
                        rank: info.rank,
                        endTime: null,
                        count: null,
                        detail: line.trim()
                    };
                    break;
                }
            }

            // Extract time for current event
            if (currentEvent) {
                const tm = line.match(/(\d{1,2}):(\d{2})/g);
                if (tm) currentEvent.endTime = tm[tm.length - 1];
                const cm = line.match(/(\d+)名/);
                if (cm) currentEvent.count = parseInt(cm[1]);
            }
        }

        // Don't forget last event
        if (currentEvent && currentEvent.venue) {
            events.push(currentEvent);
        }

        // If no events found by line parsing, try single event parse
        if (events.length === 0) {
            for (const [kw, info] of Object.entries(VENUE_KEYWORDS)) {
                if (text.includes(kw)) {
                    const tm = text.match(/(\d{1,2}):(\d{2})/g);
                    const cm = text.match(/(\d+)名/);
                    events.push({
                        venue: kw,
                        venueFull: info.fullName,
                        category: info.category,
                        rank: info.rank,
                        endTime: tm ? tm[tm.length - 1] : null,
                        count: cm ? parseInt(cm[1]) : null,
                        detail: text.trim().substring(0, 100)
                    });
                    break;
                }
            }
        }

        return events;
    }

    let parsedEvents = [];

    document.getElementById('parseBtn').addEventListener('click', () => {
        const text = document.getElementById('lineTextarea').value;
        if (!text.trim()) return;

        parsedEvents = parseEventsFromText(text);

        if (parsedEvents.length === 0) {
            alert('会場情報が見つかりませんでした');
            return;
        }

        // Show preview
        if (parsedEvents.length === 1) {
            const e = parsedEvents[0];
            document.getElementById('previewVenue').textContent = e.venueFull || e.venue;
            document.getElementById('previewTime').textContent = e.endTime || '未検出';
            document.getElementById('previewCount').textContent = e.count ? `${e.count}名` : '未検出';
            document.getElementById('previewRank').textContent = e.rank || '-';
        } else {
            document.getElementById('previewVenue').textContent = `${parsedEvents.length}件のイベント`;
            document.getElementById('previewTime').textContent = parsedEvents.map(e => e.endTime || '?').join(', ');
            document.getElementById('previewCount').textContent = '-';
            document.getElementById('previewRank').textContent = '-';
        }

        document.getElementById('parsePreview').classList.add('active');
        document.getElementById('parseBtn').style.display = 'none';
        document.getElementById('addEventBtn').style.display = 'block';
    });

    document.getElementById('addEventBtn').addEventListener('click', async () => {
        if (!parsedEvents || parsedEvents.length === 0) return;

        const btn = document.getElementById('addEventBtn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '保存中...';

        const today = new Date().toISOString().split('T')[0];
        let addedCount = 0;
        let skippedCount = 0;
        let errorCount = 0;

        for (const parsed of parsedEvents) {
            const newEvent = {
                venue: parsed.venueFull, type: parsed.category, rank: parsed.rank,
                endTime: parsed.endTime || '21:00', label: '終了予定', people: parsed.count,
                artist: null, detail: parsed.detail || null, startTime: null, memo: null, source: 'manual'
            };

            if (sb) {
                try {
                    // Check for duplicate (same date, venue, end_time, AND detail)
                    const { data: existing, error: selectError } = await sb
                        .from('flow_manual_events')
                        .select('id')
                        .eq('event_date', today)
                        .eq('venue', newEvent.venue)
                        .eq('end_time', newEvent.endTime)
                        .eq('detail', newEvent.detail || '')
                        .limit(1);

                    if (selectError) {
                        console.warn('Duplicate check failed:', selectError);
                        errorCount++;
                        continue;
                    }

                    if (existing && existing.length > 0) {
                        console.log('⚠️ Duplicate event skipped:', newEvent.venue);
                        skippedCount++;
                        continue;
                    }

                    // Insert new event
                    const { error } = await sb.from('flow_manual_events').insert([{
                        event_date: today, venue: newEvent.venue, detail: newEvent.detail || '',
                        event_type: newEvent.type, rank: newEvent.rank, end_time: newEvent.endTime,
                        people_count: newEvent.people || null
                    }]);

                    if (error) {
                        console.warn('Save failed:', error);
                        errorCount++;
                        continue;
                    }

                    addedCount++;
                    EVENTS.push(newEvent);
                    console.log('✅ Event saved:', newEvent.venue);

                } catch (e) {
                    console.warn('Save failed:', e);
                    errorCount++;
                }
            } else {
                // Supabase未接続の場合はローカルのみ
                addedCount++;
                EVENTS.push(newEvent);
            }
        }

        // Show result
        renderTimeline();
        updateNextBanner(EVENTS);

        if (addedCount > 0 && skippedCount === 0 && errorCount === 0) {
            btn.textContent = `✅ ${addedCount}件追加しました`;
            btn.style.background = '#22c55e';
        } else if (addedCount > 0) {
            btn.textContent = `✅ ${addedCount}件追加、${skippedCount}件スキップ`;
            btn.style.background = '#22c55e';
        } else if (skippedCount > 0) {
            btn.textContent = `⚠️ ${skippedCount}件すべて登録済み`;
            btn.style.background = '#f59e0b';
        } else {
            btn.textContent = '❌ 保存に失敗しました';
            btn.style.background = '#ef4444';
        }

        // Close modal after brief delay to show success message
        setTimeout(() => {
            closeLineModal();
            btn.textContent = originalText;
            btn.style.background = '';
            btn.disabled = false;

            // Switch to events tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="events"]').classList.add('active');
            document.getElementById('events-content').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 2000);
    });

    // ========================================
    // Initialize
    // ========================================
    async function initializeApp() {
        try {
            updateHeaderDate();
            const fetched = await fetchTodayEvents();
            EVENTS = (fetched && fetched.length > 0) ? fetched : SAMPLE_EVENTS;
            console.log(`✅ Loaded ${EVENTS.length} events` + (fetched.length > 0 ? ' from Supabase' : ' (sample data)'));
            renderTimeline();
            updateNextBanner(EVENTS);
        } catch (e) {
            console.error('Init error:', e);
            EVENTS = SAMPLE_EVENTS;
            renderTimeline();
            updateNextBanner(EVENTS);
        }
    }

    initializeApp();

    // Auto-refresh every 60s
    setInterval(() => updateNextBanner(EVENTS), 60000);

    // ========================================
    // Data Refresh Functions
    // ========================================
    let dataRefreshInterval = null;
    const DATA_REFRESH_INTERVAL = 15 * 60 * 1000; // 15 minutes

    // Show refresh toast notification
    function showRefreshToast(text, isSuccess = false) {
        const toast = document.getElementById('refreshToast');
        const textEl = document.getElementById('refreshToastText');
        const spinner = toast.querySelector('.spinner');

        textEl.textContent = text;
        toast.classList.remove('success');

        if (isSuccess) {
            toast.classList.add('success');
            spinner.style.display = 'none';
        } else {
            spinner.style.display = 'block';
        }

        toast.classList.add('show');

        // Auto-hide after showing
        setTimeout(() => {
            toast.classList.remove('show');
            spinner.style.display = 'block';
        }, isSuccess ? 1500 : 10000);
    }

    // Refresh Spot tab data (keep map position)
    async function refreshSpotData() {
        console.log('🔄 [Refresh] Spot data refresh started...');
        try {
            await fetchScoreRealData();
            if (scoreMap) {
                renderScoreMap();
            }
            console.log('✅ [Refresh] Spot data refreshed');
            return true;
        } catch (e) {
            console.error('❌ [Refresh] Spot refresh error:', e);
            return false;
        }
    }

    // Refresh Navi tab data (keep map position)
    async function refreshNaviData() {
        console.log('🔄 [Refresh] Navi data refresh started...');
        try {
            await fetchNaviEvents();
            if (longMap) {
                renderNaviMap();
                renderNaviList();
                updateNaviRecommend();
            }
            console.log('✅ [Refresh] Navi data refreshed');
            return true;
        } catch (e) {
            console.error('❌ [Refresh] Navi refresh error:', e);
            return false;
        }
    }

    // Combined refresh for both tabs
    async function refreshAllData(showToast = true) {
        if (showToast) showRefreshToast('🔄 更新中...');

        const results = await Promise.all([
            refreshSpotData(),
            refreshNaviData()
        ]);

        const success = results.every(r => r);

        if (showToast) {
            setTimeout(() => {
                showRefreshToast(success ? '✅ 更新完了' : '⚠️ 一部更新失敗', success);
            }, 300);
        }

        return success;
    }

    // Start auto-refresh interval (15 minutes)
    function startDataRefreshInterval() {
        if (dataRefreshInterval) clearInterval(dataRefreshInterval);
        dataRefreshInterval = setInterval(() => {
            const appsActive = document.getElementById('apps-content')?.classList.contains('active');
            const longActive = document.getElementById('long-content')?.classList.contains('active');

            // Only refresh if on relevant tab, show toast
            if (appsActive || longActive) {
                console.log('🕐 [Auto-Refresh] 15-minute interval triggered');
                refreshAllData(true);
            }
        }, DATA_REFRESH_INTERVAL);
        console.log('✅ [Auto-Refresh] Interval started (15 min)');
    }

    // ========================================
    // Pull-to-Refresh for Lists
    // ========================================
    function initPullToRefresh() {
        // Spot tab - score sidebar list
        const scoreSidebar = document.querySelector('.score-sidebar');
        const scoreSbList = document.getElementById('scoreSbList');

        // Navi tab - navi sheet
        const naviSheet = document.getElementById('navi-sheet');

        // Setup for each pullable area
        if (scoreSidebar && scoreSbList) {
            setupPullToRefresh(scoreSidebar, scoreSbList, 'spot');
        }
        if (naviSheet) {
            setupPullToRefresh(naviSheet, naviSheet, 'navi');
        }
    }

    function setupPullToRefresh(container, scrollableEl, tabType) {
        let startY = 0;
        let currentY = 0;
        let pulling = false;
        let indicator = null;

        // Create indicator
        indicator = document.createElement('div');
        indicator.className = 'pull-indicator';
        indicator.innerHTML = '<span class="pull-arrow">↓</span>';
        container.style.position = 'relative';
        container.insertBefore(indicator, container.firstChild);

        const onTouchStart = (e) => {
            // Only start if scrolled to top
            const scrollTop = scrollableEl.scrollTop || 0;
            if (scrollTop > 5) return;

            startY = e.touches[0].clientY;
            pulling = true;
        };

        const onTouchMove = (e) => {
            if (!pulling) return;

            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;

            // Only trigger on downward pull
            if (deltaY < 0) {
                pulling = false;
                indicator.classList.remove('visible', 'ready');
                return;
            }

            // Show indicator
            if (deltaY > 10) {
                e.preventDefault();
                indicator.classList.add('visible');

                // Calculate pull progress (max 80px)
                const progress = Math.min(deltaY / 80, 1);
                indicator.style.top = (-50 + deltaY * 0.5) + 'px';

                // Ready state when pulled enough
                if (deltaY > 60) {
                    indicator.classList.add('ready');
                } else {
                    indicator.classList.remove('ready');
                }
            }
        };

        const onTouchEnd = async (e) => {
            if (!pulling) return;

            const deltaY = currentY - startY;
            pulling = false;

            // Trigger refresh if pulled enough
            if (deltaY > 60) {
                indicator.classList.add('refreshing');

                // Refresh based on tab type
                if (tabType === 'spot') {
                    await refreshSpotData();
                } else if (tabType === 'navi') {
                    await refreshNaviData();
                }

                showRefreshToast('✅ 更新完了', true);
            }

            // Reset indicator
            setTimeout(() => {
                indicator.classList.remove('visible', 'ready', 'refreshing');
                indicator.style.top = '-50px';
            }, 200);
        };

        // Add passive: false to allow preventDefault
        container.addEventListener('touchstart', onTouchStart, { passive: true });
        container.addEventListener('touchmove', onTouchMove, { passive: false });
        container.addEventListener('touchend', onTouchEnd, { passive: true });
    }

    // Initialize refresh features
    startDataRefreshInterval();

    // Init pull-to-refresh after DOM is ready
    setTimeout(() => {
        initPullToRefresh();
    }, 1000);

    // Unregister any existing Service Workers
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
                registration.unregister().then(() => {
                    console.log('✅ Service Worker unregistered');
                });
            });
        });
    }
    </script>
</body>
</html>
