<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FLOW - Demand Flow Navigator</title>

    <!-- CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&family=Inter:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#0f172a">

    <style>
        :root {
            --navy: #0f172a;
            --navy-light: #1e293b;
            --teal: #0d9488;
            --teal-light: #14b8a6;
            --teal-dim: rgba(13, 148, 136, 0.15);
            --red: #ef4444;
            --orange: #f59e0b;
            --hot-pink: #f43f5e;
            --amber: #d97706;
            --hotel-purple: #8b5cf6;
            --uber-green: #22c55e;
            --didi-orange: #f97316;
            --nagashi-gray: #94a3b8;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--navy);
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: var(--navy);
            padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header-left { display: flex; flex-direction: column; gap: 2px; }
        .app-name { font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 900; letter-spacing: 0.5px; }
        .app-name .o { color: var(--teal-light); }
        .app-subtitle { font-family: 'Inter', sans-serif; font-size: 10px; color: var(--gray-400); letter-spacing: 0.5px; }
        .header-date { font-family: 'Inter', sans-serif; font-size: 12px; color: var(--gray-400); }

        /* Tab Bar */
        .tab-bar { background: var(--navy-light); display: flex; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tab {
            flex: 1; padding: 14px 12px; text-align: center; cursor: pointer;
            color: var(--gray-400); font-size: 13px; font-weight: 600;
            border-bottom: 2.5px solid transparent; transition: all 0.2s;
        }
        .tab.active { color: var(--teal-light); border-bottom-color: var(--teal); }
        .tab-icon { font-size: 18px; display: block; margin-bottom: 4px; }

        /* Content Area */
        .content { display: none; padding-bottom: 100px; }
        .content.active { display: block; }
        .content-padded { padding: 20px; }

        /* NEXT EVENT Banner */
        .next-event-banner {
            background: linear-gradient(135deg, #1a0a1e 0%, #2d1035 50%, #1a2040 100%);
            border: 1px solid rgba(244, 63, 94, 0.2);
            border-radius: 14px; padding: 20px; margin-bottom: 20px;
            position: relative; overflow: hidden;
        }
        .next-event-banner::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(244, 63, 94, 0.3) 0%, transparent 70%);
            pointer-events: none;
        }
        .next-label { font-family: 'Inter', sans-serif; font-size: 10px; color: var(--hot-pink); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .next-time { font-family: 'Inter', sans-serif; font-size: 32px; font-weight: 900; color: white; margin-bottom: 4px; }
        .next-time-label { font-size: 10px; color: var(--gray-400); margin-bottom: 12px; }
        .next-event-name { font-size: 17px; font-weight: 900; color: white; margin-bottom: 6px; }
        .next-event-detail { font-size: 12px; color: var(--gray-300); margin-bottom: 12px; }
        .countdown-badge { display: inline-block; background: var(--hot-pink); color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .countdown-badge.soon { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Filter Chips */
        .filter-chips { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .filter-chips::-webkit-scrollbar { display: none; }
        .filter-chip {
            padding: 8px 16px; border-radius: 20px; border: 1.5px solid var(--gray-700);
            background: transparent; color: var(--gray-400); font-size: 13px; font-weight: 600;
            white-space: nowrap; cursor: pointer; transition: all 0.2s;
        }
        .filter-chip.active { border-color: var(--teal); background: var(--teal-dim); color: var(--teal-light); }

        /* Timeline */
        .timeline { display: flex; flex-direction: column; gap: 16px; }
        .time-divider { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
        .time-divider-line { flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1); }
        .time-divider-label { font-family: 'Inter', sans-serif; font-size: 10px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }

        /* Timeline Item */
        .timeline-item { display: flex; gap: 12px; padding: 16px; background: var(--navy-light); border-radius: 12px; border-left: 3px solid transparent; }
        .timeline-item.rank-s {
            border-left: 4px solid var(--hot-pink);
            background: linear-gradient(135deg, rgba(244,63,94,0.15) 0%, var(--navy-light) 100%);
            box-shadow: 0 0 12px rgba(244,63,94,0.2);
        }
        .timeline-item.rank-a {
            border-left: 4px solid var(--amber);
            background: linear-gradient(135deg, rgba(217,119,6,0.1) 0%, var(--navy-light) 100%);
        }
        .timeline-item.rank-a-hotel {
            border-left: 4px solid var(--hotel-purple);
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, var(--navy-light) 100%);
        }
        .timeline-item.rank-b {
            border-left: 3px solid var(--gray-700);
            opacity: 0.7;
        }

        .timeline-time { width: 52px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; }
        .timeline-time-main { font-family: 'Inter', sans-serif; font-size: 18px; font-weight: 900; line-height: 1; }
        .timeline-time.rank-s .timeline-time-main { color: var(--hot-pink); font-size: 22px; }
        .timeline-time.rank-a .timeline-time-main { color: var(--amber); }
        .timeline-time.rank-a-hotel .timeline-time-main { color: var(--hotel-purple); }
        .timeline-time.rank-b .timeline-time-main { color: var(--gray-400); font-size: 16px; }
        .timeline-time-label { font-size: 9px; color: var(--gray-400); margin-top: 2px; }

        .timeline-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
        .timeline-dot.concert { background: var(--red); }
        .timeline-dot.hotel { background: var(--hotel-purple); }
        .timeline-dot.facility { background: var(--teal); }

        .timeline-content { flex: 1; }
        .timeline-venue { font-size: 14px; font-weight: 700; color: white; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .timeline-item.rank-s .timeline-venue { font-size: 17px; font-weight: 900; }
        .timeline-item.rank-a .timeline-venue, .timeline-item.rank-a-hotel .timeline-venue { font-size: 15px; }
        .timeline-item.rank-b .timeline-venue { font-size: 13px; color: var(--gray-300); }

        .rank-badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 800; color: white; letter-spacing: 1px; }
        .rank-badge.rank-s { background: var(--hot-pink); box-shadow: 0 0 8px rgba(244,63,94,0.5); }
        .rank-badge.rank-a { background: var(--amber); }
        .type-tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 9px; font-weight: 700; color: white; }
        .type-tag.banquet { background: var(--hotel-purple); }
        .type-tag.conference { background: var(--teal); }

        .timeline-detail { font-size: 12px; color: var(--gray-500); margin-bottom: 6px; }
        .people-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-bottom: 6px; }
        .people-badge.large { background: rgba(244, 63, 94, 0.2); color: var(--hot-pink); }
        .people-badge.medium { background: rgba(139, 92, 246, 0.2); color: var(--hotel-purple); }
        .people-badge.small { background: rgba(148, 163, 184, 0.2); color: var(--gray-400); }
        .demand-memo { font-size: 10px; color: var(--gray-400); margin-bottom: 4px; }
        .start-time { font-size: 10px; color: var(--gray-400); }
        .navi-hint { font-size: 9px; color: var(--teal); margin-top: 4px; opacity: 0.6; }
        .timeline-item { cursor: pointer; transition: transform 0.1s; }
        .timeline-item:active { transform: scale(0.98); }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-400); }
        .empty-state-icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state-text { font-size: 14px; margin-bottom: 4px; }
        .empty-state-sub { font-size: 12px; color: var(--gray-500); }

        /* Map Tabs */
        .map-container { display: flex; flex-direction: column; height: calc(100vh - 140px); min-height: 500px; position: relative; }
        .map-filters {
            padding: 0; background: var(--navy-light); border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .map-filters.open { max-height: 300px; padding: 10px 16px; }
        .filter-toggle-bar {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 8px; background: var(--navy-light); cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px; color: var(--gray-400); font-weight: 600;
        }
        .filter-toggle-bar .arrow { transition: transform 0.3s; display: inline-block; }
        .filter-toggle-bar.open .arrow { transform: rotate(180deg); }
        .filter-section { margin-bottom: 6px; }
        .filter-section:last-child { margin-bottom: 0; }
        .filter-label { font-size: 9px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; font-weight: 600; }
        .toggle-group { display: flex; gap: 6px; }
        .toggle-btn {
            flex: 1; padding: 5px 10px; border-radius: 6px; border: 1.5px solid var(--gray-700);
            background: transparent; color: var(--gray-400); font-size: 11px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .toggle-btn.active { background: white; color: var(--navy); border-color: white; box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2); }
        .filter-group { display: flex; gap: 4px; flex-wrap: wrap; }
        .filter-btn {
            padding: 4px 10px; border-radius: 14px; border: 1.5px solid var(--gray-700);
            background: transparent; color: var(--gray-400); font-size: 10px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .filter-btn.active { border-color: var(--teal); background: var(--teal-dim); color: var(--teal-light); }
        .filter-btn.active.uber { border-color: var(--uber-green); background: rgba(34,197,94,0.15); color: var(--uber-green); }
        .filter-btn.active.didi { border-color: var(--didi-orange); background: rgba(249,115,22,0.15); color: var(--didi-orange); }

        #map, #long-map { flex: 1; min-height: 400px; background: #f0f0f0; }
        .leaflet-container { height: 100% !important; width: 100% !important; }
        .leaflet-control-zoom { border: none !important; box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important; }
        .leaflet-control-zoom a { background: var(--navy-light) !important; color: white !important; border: none !important; }
        .leaflet-control-zoom a:hover { background: var(--gray-700) !important; }

        .map-legend {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(15,23,42,0.9); backdrop-filter: blur(10px);
            padding: 12px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); z-index: 1000;
        }
        .legend-title { font-size: 10px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 11px; color: var(--gray-300); }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .legend-dot.uber { background: var(--uber-green); }
        .legend-dot.didi { background: var(--didi-orange); }
        .legend-box { width: 16px; height: 16px; border-radius: 4px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .legend-box.high { background: rgba(239,68,68,0.9); }
        .legend-box.medium { background: rgba(245,158,11,0.9); }
        .legend-box.venue { background: #6366f1; }
        .legend-box.hotel { background: var(--hotel-purple); }
        .legend-gradient { width: 100px; height: 12px; border-radius: 6px; background: linear-gradient(to right, #0066ff, #00ccaa, #44dd00, #ffaa00, #cc0000); }

        .map-stats {
            position: absolute; top: 20px; right: 20px;
            background: rgba(15,23,42,0.9); backdrop-filter: blur(10px);
            padding: 12px 16px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); z-index: 1000; min-width: 140px;
        }
        .stats-label { font-size: 10px; color: var(--gray-400); margin-bottom: 4px; }
        .stats-value { font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 900; color: var(--teal-light); margin-bottom: 6px; }
        .stats-detail { font-size: 11px; color: var(--gray-400); }

        /* Custom Markers */
        .app-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .app-dot.uber { background: var(--uber-green); }
        .app-dot.didi { background: var(--didi-orange); }
        .app-dot.high { background: #ef4444; }
        .app-dot.medium { background: #f59e0b; }
        .fare-pin {
            padding: 2px 6px; border-radius: 12px; border: 2px solid white;
            font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 700; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); white-space: nowrap;
            line-height: 1.2;
        }
        .fare-pin.high { background: rgba(239,68,68,0.85); }
        .fare-pin.medium { background: rgba(245,158,11,0.85); }
        .venue-pin {
            padding: 2px 6px; border-radius: 12px; border: 2px solid white;
            font-size: 9px; font-weight: 700; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); white-space: nowrap;
            line-height: 1.2;
        }
        .venue-pin.venue { background: #6366f1; }
        .venue-pin.hotel { background: var(--hotel-purple); }

        /* Popup */
        .leaflet-popup-content-wrapper { background: var(--navy-light) !important; color: white !important; border-radius: 10px !important; padding: 0 !important; }
        .leaflet-popup-content { margin: 12px 14px !important; font-family: 'Noto Sans JP', sans-serif !important; }
        .leaflet-popup-tip { background: var(--navy-light) !important; }
        .popup-tag { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-bottom: 6px; margin-right: 4px; }
        .popup-tag.uber { background: var(--uber-green); color: white; }
        .popup-tag.didi { background: var(--didi-orange); color: white; }
        .popup-tag.morning { background: rgba(245,158,11,0.2); color: var(--orange); }
        .popup-tag.day { background: rgba(14,165,233,0.2); color: #0ea5e9; }
        .popup-tag.evening { background: rgba(249,115,22,0.2); color: var(--didi-orange); }
        .popup-tag.night { background: rgba(99,102,241,0.2); color: #6366f1; }
        .popup-area { font-size: 13px; font-weight: 700; color: white; margin-bottom: 4px; }
        .popup-route { font-size: 13px; font-weight: 700; color: white; margin-bottom: 4px; }
        .popup-fare { font-family: 'Inter', sans-serif; font-size: 18px; font-weight: 900; margin-bottom: 4px; }
        .popup-fare.high { color: var(--red); }
        .popup-fare.medium { color: var(--orange); }
        .popup-datetime { font-size: 10px; color: var(--gray-400); margin-bottom: 8px; }
        .popup-navi-btn { display: block; width: 100%; padding: 8px 12px; background: var(--teal); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; text-align: center; }

        /* FAB */
        .fab {
            position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
            background: var(--teal); border-radius: 50%; border: none;
            box-shadow: 0 4px 12px rgba(13,148,136,0.4);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; font-weight: 300; transition: all 0.3s; z-index: 1000;
        }
        .fab:active { transform: scale(0.95); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; z-index: 2000; }
        .modal-overlay.active { display: block; }
        .modal {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--navy-light);
            border-radius: 20px 20px 0 0; padding: 24px; max-height: 80vh; overflow-y: auto;
            z-index: 2001; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.active { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; color: white; }
        .modal-close { background: none; border: none; color: var(--gray-400); font-size: 28px; cursor: pointer; }
        .modal-section { margin-bottom: 20px; }
        .modal-label { font-size: 12px; color: var(--gray-400); margin-bottom: 8px; font-weight: 600; }
        .modal-textarea {
            width: 100%; min-height: 150px; background: var(--navy);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
            padding: 12px; color: white; font-size: 14px; font-family: 'Noto Sans JP', sans-serif; resize: vertical;
        }
        .modal-textarea:focus { outline: none; border-color: var(--teal); }
        .modal-textarea::placeholder { color: var(--gray-500); }
        .modal-btn { width: 100%; padding: 14px; background: var(--teal); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
        .modal-btn:disabled { background: var(--gray-700); cursor: not-allowed; opacity: 0.5; }
        .parse-preview { background: var(--navy); border: 1px solid rgba(13,148,136,0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px; display: none; }
        .parse-preview.active { display: block; }
        .preview-title { font-size: 13px; color: var(--teal); margin-bottom: 12px; font-weight: 600; }
        .preview-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .preview-item:last-child { border-bottom: none; }
        .preview-label { font-size: 12px; color: var(--gray-400); }
        .preview-value { font-size: 13px; color: white; font-weight: 600; }

        /* Modal Input */
        .modal-input {
            width: 100%; padding: 12px 14px; background: var(--navy);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 8px;
            color: white; font-size: 15px; font-family: 'Noto Sans JP', sans-serif;
        }
        .modal-input:focus { outline: none; border-color: var(--teal); }
        .modal-input::placeholder { color: var(--gray-500); }

        /* App Select Buttons */
        .app-select-group { display: flex; gap: 8px; }
        .app-select-btn {
            flex: 1; padding: 12px 8px; border-radius: 8px;
            border: 1.5px solid var(--gray-700); background: transparent;
            color: var(--gray-400); font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .app-select-btn.active { border-color: var(--teal); background: var(--teal-dim); color: var(--teal-light); }
        .app-select-btn[data-app="uber"].active { border-color: var(--uber-green); background: rgba(34,197,94,0.15); color: var(--uber-green); }
        .app-select-btn[data-app="didi"].active { border-color: var(--didi-orange); background: rgba(249,115,22,0.15); color: var(--didi-orange); }

        /* Dashboard Styles */
        .dashboard-container { padding: 16px; }
        .dashboard-header { margin-bottom: 16px; }
        .dashboard-period-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .period-tab {
            flex: 1; padding: 10px; text-align: center; border-radius: 8px;
            background: var(--navy-light); border: 1.5px solid var(--gray-700);
            color: var(--gray-400); font-size: 12px; font-weight: 600; cursor: pointer;
        }
        .period-tab.active { background: var(--teal-dim); border-color: var(--teal); color: var(--teal-light); }

        .summary-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .summary-card {
            background: var(--navy-light); border-radius: 12px; padding: 16px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .summary-card.highlight {
            background: linear-gradient(135deg, rgba(13,148,136,0.15) 0%, var(--navy-light) 100%);
            border-color: rgba(13,148,136,0.3);
        }
        .summary-card-label { font-size: 11px; color: var(--gray-400); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card-value { font-family: 'Inter', sans-serif; font-size: 24px; font-weight: 900; color: white; }
        .summary-card-value.teal { color: var(--teal-light); }
        .summary-card-sub { font-size: 11px; color: var(--gray-500); margin-top: 4px; }
        .summary-card-trend { display: inline-block; font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .summary-card-trend.up { background: rgba(34,197,94,0.2); color: #22c55e; }
        .summary-card-trend.down { background: rgba(239,68,68,0.2); color: #ef4444; }

        .chart-section { background: var(--navy-light); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .chart-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .chart-container { position: relative; height: 200px; }
        .chart-container.tall { height: 250px; }

        .ranking-section { background: var(--navy-light); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .ranking-title { font-size: 14px; font-weight: 700; color: white; margin-bottom: 12px; }
        .ranking-list { display: flex; flex-direction: column; gap: 8px; }
        .ranking-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--navy); border-radius: 8px; }
        .ranking-rank { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800; color: white; }
        .ranking-rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .ranking-rank.silver { background: linear-gradient(135deg, #94a3b8, #64748b); }
        .ranking-rank.bronze { background: linear-gradient(135deg, #d97706, #b45309); }
        .ranking-rank.normal { background: var(--gray-700); }
        .ranking-info { flex: 1; }
        .ranking-name { font-size: 13px; font-weight: 600; color: white; }
        .ranking-detail { font-size: 11px; color: var(--gray-400); }
        .ranking-value { font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 700; color: var(--teal-light); }

        .breakdown-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .breakdown-item { background: var(--navy); border-radius: 8px; padding: 12px; text-align: center; }
        .breakdown-icon { font-size: 20px; margin-bottom: 4px; }
        .breakdown-label { font-size: 10px; color: var(--gray-400); margin-bottom: 4px; }
        .breakdown-value { font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 700; color: white; }
        .breakdown-pct { font-size: 10px; color: var(--gray-500); }

        /* Hotspot Tab Styles */
        .hotspot-filter-bar {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 16px; background: var(--navy-light);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .hotspot-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
        }
        .hotspot-badge.time {
            background: rgba(0,230,118,0.15); color: #00e676;
            border: 1px solid rgba(0,230,118,0.3);
        }
        .hotspot-badge.day {
            background: rgba(148,163,184,0.15); color: var(--gray-300);
            border: 1px solid rgba(148,163,184,0.2);
        }
        .hotspot-pulse-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #00e676;
            animation: hotspotPulse 1.5s ease-in-out infinite;
        }
        @keyframes hotspotPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        .hotspot-count {
            margin-left: auto; font-size: 11px; color: var(--gray-400);
        }
        .hotspot-recommend {
            position: absolute; top: 16px; right: 16px; z-index: 1000;
            background: rgba(10,10,20,0.88); backdrop-filter: blur(12px);
            border-radius: 12px; padding: 14px 18px;
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 160px;
        }
        .hotspot-recommend-label {
            font-size: 11px; color: #00e676; font-weight: 600;
            margin-bottom: 6px; display: flex; align-items: center; gap: 4px;
        }
        .hotspot-recommend-area {
            font-size: 20px; font-weight: 900; color: white; margin-bottom: 4px;
        }
        .hotspot-recommend-detail {
            font-size: 11px; color: var(--gray-400);
        }
        .hotspot-insight {
            background: var(--navy-light);
            border: 1px solid rgba(0,230,118,0.3);
            border-radius: 12px; padding: 14px 16px;
            margin: 12px 16px;
        }
        .hotspot-insight-header {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: #00e676; font-weight: 600; margin-bottom: 8px;
        }
        .hotspot-insight-text {
            font-size: 13px; color: var(--gray-300); line-height: 1.6;
        }
        .hotspot-empty {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 300px; color: var(--gray-400);
            text-align: center; padding: 20px;
        }
        .hotspot-empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .hotspot-empty-text { font-size: 14px; margin-bottom: 8px; }
        .hotspot-empty-sub { font-size: 12px; color: var(--gray-500); }
        .hotspot-circle-label {
            font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 900;
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .hotspot-area-label {
            font-size: 10px; font-weight: 600; color: white;
            background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px;
            white-space: nowrap;
        }
        .hotspot-legend {
            position: absolute; bottom: 20px; left: 16px; z-index: 1000;
            background: rgba(10,10,20,0.88); backdrop-filter: blur(12px);
            border-radius: 10px; padding: 12px 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .hotspot-legend-title {
            font-size: 10px; color: var(--gray-400); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 8px; font-weight: 600;
        }
        .hotspot-legend-item {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 6px; font-size: 11px; color: var(--gray-300);
        }
        .hotspot-legend-item:last-child { margin-bottom: 0; }
        .hotspot-legend-circle {
            width: 14px; height: 14px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
        }
        .hotspot-legend-circle.high { background: rgba(0,230,118,0.4); border-color: #00e676; }
        .hotspot-legend-circle.medium { background: rgba(255,183,77,0.3); border-color: #ffb74d; }
        .hotspot-legend-circle.low { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4); }
        .hotspot-location-btn {
            position: absolute; bottom: 85px; right: 16px; z-index: 1000;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(10,10,20,0.88); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .hotspot-location-btn:active { transform: scale(0.95); }
        .hotspot-location-btn svg { width: 22px; height: 22px; }
        .current-location-marker {
            width: 16px; height: 16px; border-radius: 50%;
            background: #4285f4; border: 3px solid white;
            box-shadow: 0 0 0 2px rgba(66,133,244,0.3), 0 2px 8px rgba(0,0,0,0.3);
            animation: currentLocationPulse 2s ease-in-out infinite;
        }
        @keyframes currentLocationPulse {
            0%, 100% { box-shadow: 0 0 0 2px rgba(66,133,244,0.3), 0 2px 8px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 0 0 8px rgba(66,133,244,0.15), 0 2px 8px rgba(0,0,0,0.3); }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="app-name">FL<span class="o">O</span>W</div>
            <div class="app-subtitle">demand flow navigator</div>
        </div>
        <div class="header-date" id="headerDate"></div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
        <div class="tab active" data-tab="events"><span class="tab-icon">üìÖ</span>„Ç§„Éô„É≥„Éà</div>
        <div class="tab" data-tab="apps"><span class="tab-icon">üî•</span>„Çπ„Éù„ÉÉ„Éà</div>
        <div class="tab" data-tab="long"><span class="tab-icon">üó∫</span>„É≠„É≥„Ç∞</div>
        <div class="tab" data-tab="dashboard"><span class="tab-icon">üìä</span>ÂèéÁõä</div>
    </div>

    <!-- Events Tab Content -->
    <div class="content active" id="events-content">
        <div class="content-padded">
            <div class="next-event-banner" id="nextBanner">
                <div class="next-label">‚ö° NEXT</div>
                <div class="next-time" id="nextTime">--:--</div>
                <div class="next-time-label">ÁµÇ‰∫Ü‰∫àÂÆö</div>
                <div class="next-event-name" id="nextName">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                <div class="next-event-detail" id="nextDetail"></div>
                <div class="countdown-badge" id="nextCountdown"></div>
            </div>
            <div class="filter-chips">
                <button class="filter-chip active" data-filter="all">ÂÖ®„Å¶</button>
                <button class="filter-chip" data-filter="concert">üé§ „Ç≥„É≥„Çµ„Éº„Éà</button>
                <button class="filter-chip" data-filter="hotel">üè® „Éõ„ÉÜ„É´ÂÆ¥‰ºö</button>
                <button class="filter-chip" data-filter="facility">üé¢ ÊñΩË®≠</button>
            </div>
            <div class="timeline" id="timeline"></div>
        </div>
    </div>

    <!-- Hotspot Tab Content -->
    <div class="content" id="apps-content">
        <div class="map-container">
            <div class="hotspot-filter-bar" id="hotspot-filter-bar">
                <div class="hotspot-badge time">
                    <div class="hotspot-pulse-dot"></div>
                    <span id="hotspot-time-range">--:-- „Äú --:--</span>
                </div>
                <div class="hotspot-badge day" id="hotspot-day">--Êõú</div>
                <div class="hotspot-count" id="hotspot-count">ÈÅéÂéª„ÅÆÂêåÊù°‰ª∂ 0‰ª∂</div>
            </div>
            <div style="position: relative; flex: 1;">
                <div id="map"></div>
                <div class="hotspot-recommend" id="hotspot-recommend" style="display: none;">
                    <div class="hotspot-recommend-label">üéØ ‰ªä„ÅÆ„Åä„Åô„Åô„ÇÅ</div>
                    <div class="hotspot-recommend-area" id="hotspot-recommend-area">--</div>
                    <div class="hotspot-recommend-detail" id="hotspot-recommend-detail">-- ‰ª∂</div>
                </div>
                <div class="hotspot-legend">
                    <div class="hotspot-legend-title">‰πóËªäÂÆüÁ∏æ</div>
                    <div class="hotspot-legend-item"><div class="hotspot-legend-circle high"></div><span>3Âõû‰ª•‰∏ä</span></div>
                    <div class="hotspot-legend-item"><div class="hotspot-legend-circle medium"></div><span>2Âõû</span></div>
                    <div class="hotspot-legend-item"><div class="hotspot-legend-circle low"></div><span>1Âõû</span></div>
                </div>
                <div class="hotspot-location-btn" id="hotspot-location-btn" onclick="goToCurrentLocation()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#4285f4" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <line x1="12" y1="2" x2="12" y2="6"/>
                        <line x1="12" y1="18" x2="12" y2="22"/>
                        <line x1="2" y1="12" x2="6" y2="12"/>
                        <line x1="18" y1="12" x2="22" y2="12"/>
                    </svg>
                </div>
            </div>
            <div class="hotspot-insight" id="hotspot-insight" style="display: none;">
                <div class="hotspot-insight-header">üí° „Ç§„É≥„Çµ„Ç§„Éà</div>
                <div class="hotspot-insight-text" id="hotspot-insight-text"></div>
            </div>
        </div>
    </div>

    <!-- Long Tab Content -->
    <div class="content" id="long-content">
        <div class="map-container">
            <div class="filter-toggle-bar" onclick="toggleFilter(this)">üîß „Éï„Ç£„É´„Çø„Éº <span class="arrow">‚ñº</span></div>
            <div class="map-filters" id="long-filters">
                <div class="filter-section">
                    <div class="filter-label">Ë°®Á§∫ÂàáÊõø</div>
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-view="pin">üìç „Éî„É≥Ë°®Á§∫</button>
                        <button class="toggle-btn" data-view="heat">üî• „Éí„Éº„Éà„Éû„ÉÉ„Éó</button>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="filter-label">ÊôÇÈñìÂ∏Ø</div>
                    <div class="filter-group">
                        <button class="filter-btn active" data-period="all">ÂÖ®„Å¶</button>
                        <button class="filter-btn" data-period="morning">üåÖ Êúù</button>
                        <button class="filter-btn" data-period="day">‚òÄÔ∏è Êòº</button>
                        <button class="filter-btn" data-period="evening">üåÜ Â§ú</button>
                        <button class="filter-btn" data-period="night">üåô Ê∑±Â§ú</button>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="filter-label">ÈáëÈ°ç</div>
                    <div class="filter-group">
                        <button class="filter-btn active" data-fare="all">ÂÖ®„Å¶</button>
                        <button class="filter-btn" data-fare="3000">¬•3,000+</button>
                        <button class="filter-btn" data-fare="5000">¬•5,000+</button>
                        <button class="filter-btn" data-fare="8000">¬•8,000+</button>
                    </div>
                </div>
            </div>
            <div style="position: relative; flex: 1;">
                <div id="long-map"></div>
                <div class="map-legend" id="long-legend"></div>
                <div class="map-stats" id="long-stats"></div>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab Content -->
    <div class="content" id="dashboard-content">
        <div class="dashboard-container">
            <!-- Period Tabs -->
            <div class="dashboard-period-tabs">
                <div class="period-tab active" data-period="daily">‰ªäÊó•</div>
                <div class="period-tab" data-period="weekly">‰ªäÈÄ±</div>
                <div class="period-tab" data-period="monthly">‰ªäÊúà</div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards" id="summaryCards">
                <div class="summary-card highlight">
                    <div class="summary-card-label">Â£≤‰∏ä</div>
                    <div class="summary-card-value teal" id="totalRevenue">¬•0</div>
                    <div class="summary-card-sub" id="revenueCompare"></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">‰πóËªäÂõûÊï∞</div>
                    <div class="summary-card-value" id="totalRides">0</div>
                    <div class="summary-card-sub" id="ridesCompare"></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Âπ≥ÂùáÂçò‰æ°</div>
                    <div class="summary-card-value" id="avgFare">¬•0</div>
                    <div class="summary-card-sub" id="avgCompare"></div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">„É≠„É≥„Ç∞Áéá</div>
                    <div class="summary-card-value" id="longRate">0%</div>
                    <div class="summary-card-sub">¬•3,000‰ª•‰∏ä</div>
                </div>
            </div>

            <!-- Revenue Chart -->
            <div class="chart-section">
                <div class="chart-title">üìà Â£≤‰∏äÊé®Áßª</div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- App Breakdown -->
            <div class="chart-section">
                <div class="chart-title">üì± „Ç¢„Éó„É™Âà•ÂÜÖË®≥</div>
                <div class="breakdown-grid" id="appBreakdown">
                    <div class="breakdown-item">
                        <div class="breakdown-icon">üü¢</div>
                        <div class="breakdown-label">Uber</div>
                        <div class="breakdown-value" id="uberRevenue">¬•0</div>
                        <div class="breakdown-pct" id="uberPct">0%</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-icon">üü†</div>
                        <div class="breakdown-label">DiDi</div>
                        <div class="breakdown-value" id="didiRevenue">¬•0</div>
                        <div class="breakdown-pct" id="didiPct">0%</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-icon">üöï</div>
                        <div class="breakdown-label">ÊµÅ„Åó</div>
                        <div class="breakdown-value" id="nagashiRevenue">¬•0</div>
                        <div class="breakdown-pct" id="nagashiPct">0%</div>
                    </div>
                </div>
            </div>

            <!-- Time Distribution Chart -->
            <div class="chart-section">
                <div class="chart-title">‚è∞ ÊôÇÈñìÂ∏ØÂà•Â£≤‰∏ä</div>
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>

            <!-- Area Ranking -->
            <div class="ranking-section">
                <div class="ranking-title">üèÜ „Ç®„É™„Ç¢Âà•„É©„É≥„Ç≠„É≥„Ç∞</div>
                <div class="ranking-list" id="areaRanking"></div>
            </div>
        </div>
    </div>

    <!-- FAB Button -->
    <button class="fab" id="fabBtn">+</button>

    <!-- Taxi Log Modal -->
    <div class="modal-overlay" id="taxiModalOverlay"></div>
    <div class="modal" id="taxiModal">
        <div class="modal-header">
            <div class="modal-title">üöï ‰πóËªä„É≠„Ç∞ËøΩÂä†</div>
            <button class="modal-close" id="taxiModalClose">√ó</button>
        </div>
        <div class="modal-section">
            <div class="modal-label">‰πóËªäÊôÇÂàª</div>
            <input type="time" class="modal-input" id="taxiTime" value="">
        </div>
        <div class="modal-section">
            <div class="modal-label">Âá∫Áô∫Âú∞</div>
            <input type="text" class="modal-input" id="taxiFrom" placeholder="‰æã: Ê¢ÖÁî∞„ÄÅÈõ£Ê≥¢„ÄÅÂåóÊñ∞Âú∞">
        </div>
        <div class="modal-section">
            <div class="modal-label">Âà∞ÁùÄÂú∞Ôºà‰ªªÊÑèÔºâ</div>
            <input type="text" class="modal-input" id="taxiTo" placeholder="‰æã: Êñ∞Â§ßÈò™„ÄÅ‰ºä‰∏πÁ©∫Ê∏Ø">
        </div>
        <div class="modal-section">
            <div class="modal-label">ÈáëÈ°ç</div>
            <input type="number" class="modal-input" id="taxiFare" placeholder="‰æã: 3500" inputmode="numeric">
        </div>
        <div class="modal-section">
            <div class="modal-label">„Ç¢„Éó„É™</div>
            <div class="app-select-group">
                <button class="app-select-btn active" data-app="uber">üü¢ Uber</button>
                <button class="app-select-btn" data-app="didi">üü† DiDi</button>
                <button class="app-select-btn" data-app="nagashi">üöï ÊµÅ„Åó</button>
            </div>
        </div>
        <button class="modal-btn" id="saveTaxiBtn">‰øùÂ≠ò„Åô„Çã</button>
    </div>

    <!-- LINE Paste Modal -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="lineModal">
        <div class="modal-header">
            <div class="modal-title">üìã LINEË≤º„Çä‰ªò„Åë</div>
            <button class="modal-close" id="modalClose">√ó</button>
        </div>
        <div class="modal-section">
            <div class="modal-label">LINE„ÅÆ„Ç§„Éô„É≥„ÉàÊÉÖÂ†±„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <textarea class="modal-textarea" id="lineTextarea" placeholder="‰æã:&#10;ÊòéÊó•„ÅÆ‰∫¨„Çª„É©„Éâ„Éº„É†Â§ßÈò™„Åß„ÅÆ„É©„Ç§„Éñ&#10;ÈñãÊºî19:00„ÄÅÁµÇÊºî21:30‰∫àÂÆö&#10;ÂèÇÂä†ËÄÖ50Âêç"></textarea>
        </div>
        <div class="parse-preview" id="parsePreview">
            <div class="preview-title">‚ú® Ëß£ÊûêÁµêÊûú</div>
            <div class="preview-item"><div class="preview-label">‰ºöÂ†¥</div><div class="preview-value" id="previewVenue">-</div></div>
            <div class="preview-item"><div class="preview-label">ÁµÇ‰∫ÜÊôÇÂàª</div><div class="preview-value" id="previewTime">-</div></div>
            <div class="preview-item"><div class="preview-label">‰∫∫Êï∞</div><div class="preview-value" id="previewCount">-</div></div>
            <div class="preview-item"><div class="preview-label">„É©„É≥„ÇØ</div><div class="preview-value" id="previewRank">-</div></div>
        </div>
        <button class="modal-btn" id="parseBtn">Ëß£Êûê„Åô„Çã</button>
        <button class="modal-btn" id="addEventBtn" style="display:none;margin-top:12px">„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†</button>
    </div>

    <script>
    // ========================================
    // Supabase Configuration
    // ========================================
    const SUPABASE_URL = 'https://jaxluazbsansigrboyhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpheGx1YXpic2Fuc2lncmJveWhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjc3ODUsImV4cCI6MjA4NTgwMzc4NX0.GpiPbUJpuc7BugaKgkDVS2igSDNp8QHRW4QvktVbQN0';

    let sb = null;
    try {
        if (window.supabase) {
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase initialized');
        }
    } catch (e) {
        console.warn('‚ö†Ô∏è Supabase init failed:', e.message);
    }

    // Filter toggle
    function toggleFilter(bar) {
        bar.classList.toggle('open');
        const filters = bar.nextElementSibling;
        filters.classList.toggle('open');
    }

    // Venue coordinates for navigation
    const VENUE_COORDS = {
        'Â§ßÈò™Âüé„Éõ„Éº„É´': { lat: 34.6873, lng: 135.5320 },
        '‰∫¨„Çª„É©„Éâ„Éº„É†': { lat: 34.6694, lng: 135.4762 },
        '‰∫¨„Çª„É©„Éâ„Éº„É†Â§ßÈò™': { lat: 34.6694, lng: 135.4762 },
        '„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´„Éõ„Éº„É´': { lat: 34.6914, lng: 135.4946 },
        '„Ç™„É™„ÉÉ„ÇØ„ÇπÂäáÂ†¥': { lat: 34.6722, lng: 135.4986 },
        'Zepp„Å™„Çì„Å∞': { lat: 34.6597, lng: 135.5013 },
        'Zepp Namba': { lat: 34.6597, lng: 135.5013 },
        'ZeppÂ§ßÈò™': { lat: 34.6597, lng: 135.5013 },
        'Zepp Osaka Bayside': { lat: 34.6550, lng: 135.4320 },
        '„Å™„Çì„Å∞Hatch': { lat: 34.6601, lng: 135.5005 },
        'GORILLA HALL OSAKA': { lat: 34.6630, lng: 135.5010 },
        'GION ARENAÁ•ûÊà∏': { lat: 34.6900, lng: 135.1830 },
        'USJ': { lat: 34.6654, lng: 135.4324 },
        '„É¶„Éã„Éê„Éº„Çµ„É´„Éª„Çπ„Çø„Ç∏„Ç™„Éª„Ç∏„É£„Éë„É≥': { lat: 34.6654, lng: 135.4324 },
        'Êµ∑ÈÅäÈ§®': { lat: 34.6545, lng: 135.4290 },
        '„Ç§„É≥„ÉÜ„ÉÉ„ÇØ„ÇπÂ§ßÈò™': { lat: 34.6360, lng: 135.4190 },
        'Â§©ÁéãÂØ∫ÂãïÁâ©Âúí': { lat: 34.6481, lng: 135.5082 },
        'Ê¢ÖÁî∞„Çπ„Ç´„Ç§„Éì„É´': { lat: 34.7052, lng: 135.4876 },
        '„Éõ„ÉÜ„É´„Éã„É•„Éº„Ç™„Éº„Çø„ÉãÂ§ßÈò™': { lat: 34.6932, lng: 135.5199 },
        '„Éã„É•„Éº„Ç™„Éº„Çø„Éã': { lat: 34.6932, lng: 135.5199 },
        '„É™„Éº„Ç¨„É≠„Ç§„É§„É´„Éõ„ÉÜ„É´': { lat: 34.6905, lng: 135.4849 },
        '„É™„Éº„Ç¨„É≠„Ç§„É§„É´': { lat: 34.6905, lng: 135.4849 },
        'Â∏ùÂõΩ„Éõ„ÉÜ„É´Â§ßÈò™': { lat: 34.6965, lng: 135.4897 },
        'Â∏ùÂõΩ„Éõ„ÉÜ„É´': { lat: 34.6965, lng: 135.4897 },
        'Â§ßÈò™ÂõΩÈöõ‰ºöË≠∞Â†¥': { lat: 34.6910, lng: 135.4890 },
        '„Ç∞„É©„É≥„Ç≠„É•„Éº„ÉñÂ§ßÈò™': { lat: 34.6910, lng: 135.4890 },
        'NHKÂ§ßÈò™„Éõ„Éº„É´': { lat: 34.6868, lng: 135.5285 },
        'Ê£Æ„ÉéÂÆÆ„Éî„É≠„ÉÜ„Ç£„Éõ„Éº„É´': { lat: 34.6835, lng: 135.5320 },
        '„Çµ„É≥„Ç±„Ç§„Éõ„Éº„É´„Éñ„É™„Éº„Çº': { lat: 34.6985, lng: 135.4960 },
        'COOL JAPAN PARK OSAKA': { lat: 34.6850, lng: 135.5340 },
    };

    function openNavi(venue) {
        const coords = VENUE_COORDS[venue];
        if (coords) {
            // Google Maps directions (works on any device, opens app if installed)
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${coords.lat},${coords.lng}&destination_place_id=&travelmode=driving`, '_blank');
        } else {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venue + ' Â§ßÈò™')}`, '_blank');
        }
    }

    // ========================================
    // Global State
    // ========================================
    let EVENTS = [];
    let currentFilter = 'all';

    // ========================================
    // Header Date
    // ========================================
    function updateHeaderDate() {
        const now = new Date();
        const wd = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
        document.getElementById('headerDate').textContent =
            `${now.getMonth()+1}/${now.getDate()}Ôºà${wd[now.getDay()]}Ôºâ`;
    }

    // ========================================
    // Safe time sort helper
    // ========================================
    function timeToMinutes(t) {
        if (!t || typeof t !== 'string' || !t.includes(':')) return 9999;
        const parts = t.split(':').map(Number);
        return (parts[0] || 0) * 60 + (parts[1] || 0);
    }

    // ========================================
    // Fetch events from Supabase
    // ========================================
    async function fetchTodayEvents() {
        if (!sb) return [];
        try {
            const today = new Date().toISOString().split('T')[0];
            const allEvents = [];

            // flow_events (auto-scraped)
            const { data: fe } = await sb.from('flow_events').select('*').eq('event_date', today).order('estimated_end');
            if (fe) fe.forEach(e => {
                allEvents.push({
                    venue: e.venue, artist: e.artist, detail: e.title,
                    endTime: e.estimated_end || '21:00', startTime: e.start_time,
                    type: 'concert', rank: e.rank || 'B', people: null, memo: '', label: 'ÁµÇ‰∫Ü‰∫àÂÆö', source: 'auto'
                });
            });

            // flow_facilities
            try {
                const { data: ff } = await sb.from('flow_facilities').select('*').lte('valid_from', today).gte('valid_to', today);
                if (ff) ff.forEach(f => {
                    allEvents.push({
                        venue: f.name, detail: '', endTime: f.close_time || '20:00',
                        type: 'facility', rank: 'B', label: f.close_label || 'ÈñâÂúí', source: 'facility'
                    });
                });
            } catch (e) { console.warn('facilities fetch error:', e); }

            // flow_manual_events
            try {
                const { data: fm } = await sb.from('flow_manual_events').select('*').eq('event_date', today).order('end_time');
                if (fm) fm.forEach(m => {
                    allEvents.push({
                        venue: m.venue, detail: m.detail || '', endTime: m.end_time || '21:00',
                        type: m.event_type || 'hotel', rank: m.rank || 'B', people: m.people_count,
                        label: 'ÁµÇ‰∫Ü‰∫àÂÆö', source: 'manual'
                    });
                });
            } catch (e) { console.warn('manual events fetch error:', e); }

            allEvents.sort((a, b) => timeToMinutes(a.endTime) - timeToMinutes(b.endTime));
            return allEvents;
        } catch (e) {
            console.error('fetchTodayEvents error:', e);
            return [];
        }
    }

    // ========================================
    // NEXT EVENT Banner
    // ========================================
    function updateNextBanner(events) {
        const banner = document.getElementById('nextBanner');
        if (!events || events.length === 0) {
            banner.style.display = 'none';
            return;
        }
        banner.style.display = 'block';

        const now = new Date();
        const nowMin = now.getHours() * 60 + now.getMinutes();
        const next = events.find(e => timeToMinutes(e.endTime) > nowMin) || events[events.length - 1];

        document.getElementById('nextTime').textContent = next.endTime || '--:--';
        document.getElementById('nextName').textContent = next.venue || '';
        document.getElementById('nextDetail').textContent = next.artist || next.detail || '';

        const diff = timeToMinutes(next.endTime) - nowMin;
        const cb = document.getElementById('nextCountdown');
        if (diff > 0) {
            const h = Math.floor(diff / 60), m = diff % 60;
            cb.textContent = h > 0 ? `üî• „ÅÇ„Å® ${h}ÊôÇÈñì${m}ÂàÜ` : `üî• „ÅÇ„Å® ${m}ÂàÜ`;
            cb.className = 'countdown-badge' + (diff <= 30 ? ' soon' : '');
        } else {
            cb.textContent = 'ÁµÇ‰∫ÜÊ∏à„Åø';
            cb.className = 'countdown-badge';
        }
    }

    // ========================================
    // Render Timeline
    // ========================================
    function renderTimeline() {
        const timeline = document.getElementById('timeline');
        let events = EVENTS.slice();

        if (currentFilter !== 'all') {
            events = events.filter(e => e.type === currentFilter);
        }

        events.sort((a, b) => timeToMinutes(a.endTime) - timeToMinutes(b.endTime));

        if (events.length === 0) {
            timeline.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <div class="empty-state-text">‰ªäÊó•„ÅÆ„Ç§„Éô„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    <div class="empty-state-sub">„Ç≠„Éß„Éº„Éâ„ÉºÂ§ßÈò™„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„Çã„Åã„ÄÅÔºã„Éú„Çø„É≥„ÅßÊâãÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                </div>`;
            return;
        }

        const grouped = {};
        events.forEach(ev => {
            const hour = parseInt((ev.endTime || '21:00').split(':')[0]);
            if (!grouped[hour]) grouped[hour] = [];
            grouped[hour].push(ev);
        });

        let html = '';
        Object.keys(grouped).sort((a, b) => a - b).forEach(hour => {
            const isPeak = hour >= 19 && hour <= 21;
            html += `<div class="time-divider"><div class="time-divider-line"></div><div class="time-divider-label">${hour}:00 „Äú ${isPeak ? 'üî•' : ''}</div><div class="time-divider-line"></div></div>`;

            grouped[hour].forEach(ev => {
                const rankClass = ev.type === 'hotel' ? 'rank-a-hotel' : `rank-${(ev.rank||'b').toLowerCase()}`;
                const timeLabel = ev.label || 'ÁµÇ‰∫Ü‰∫àÂÆö';

                let peopleHtml = '';
                if (ev.people) {
                    const pc = ev.people >= 2000 ? 'large' : ev.people >= 400 ? 'medium' : 'small';
                    peopleHtml = `<div class="people-badge ${pc}">üë• ${ev.people.toLocaleString()}Âêç</div>`;
                }

                let rankBadge = '';
                if (ev.rank === 'S') {
                    rankBadge = `<span class="rank-badge rank-s">S</span>`;
                } else if (ev.rank === 'A') {
                    rankBadge = `<span class="rank-badge rank-a">A</span>`;
                }

                html += `
                    <div class="timeline-item ${rankClass}" data-type="${ev.type}" onclick="openNavi('${(ev.venue||'').replace(/'/g, "\\'")}')">
                        <div class="timeline-time ${rankClass}">
                            <div class="timeline-time-main">${ev.endTime || '21:00'}</div>
                            <div class="timeline-time-label">${timeLabel}</div>
                        </div>
                        <div class="timeline-dot ${ev.type}"></div>
                        <div class="timeline-content">
                            <div class="timeline-venue">${ev.venue} ${rankBadge}</div>
                            ${ev.artist ? `<div class="timeline-detail">${ev.artist}</div>` : ''}
                            ${ev.detail && ev.detail !== ev.artist ? `<div class="timeline-detail">${ev.detail}</div>` : ''}
                            ${peopleHtml}
                            ${ev.memo ? `<div class="demand-memo">üìå ${ev.memo}</div>` : ''}
                            ${ev.startTime ? `<div class="start-time">${ev.startTime} ÈñãÂßã</div>` : ''}
                            <div class="navi-hint">üöó „Çø„ÉÉ„Éó„Åß„Éä„Éì</div>
                        </div>
                    </div>`;
            });
        });

        timeline.innerHTML = html;
    }

    // ========================================
    // Tab Switching
    // ========================================
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const tabName = this.dataset.tab;
            document.getElementById(tabName + '-content').classList.add('active');

            // FAB„Éú„Çø„É≥„ÅØ„Ç§„Éô„É≥„Éà„Çø„Éñ„Åß„ÅÆ„ÅøË°®Á§∫
            const fabBtn = document.getElementById('fabBtn');
            if (fabBtn) {
                fabBtn.style.display = tabName === 'events' ? 'flex' : 'none';
            }

            if (tabName === 'apps') {
                setTimeout(() => { initAppMap(); if (appMap) appMap.invalidateSize(); }, 200);
            } else if (tabName === 'long') {
                setTimeout(() => { initLongMap(); if (longMap) longMap.invalidateSize(); }, 200);
            } else if (tabName === 'dashboard') {
                setTimeout(() => initDashboard(), 100);
            }
        });
    });

    // Filter chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            renderTimeline();
        });
    });

    // ========================================
    // Sample Data
    // ========================================
    const SAMPLE_EVENTS = [
        { venue: 'Â§ßÈò™Âüé„Éõ„Éº„É´', artist: 'YOASOBI LIVE TOUR 2026', endTime: '21:30', startTime: '18:00', type: 'concert', rank: 'S', memo: 'Âüé„Éõ„Éº„É´Ââç„ÅØËªäÂØÑ„Åõ‰∫âÂ•™Êà¶' },
        { venue: '„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´„Éõ„Éº„É´', artist: 'ÂÆùÂ°öÊ≠åÂäáÂõ£ ÊúàÁµÑÂÖ¨Êºî', endTime: '20:45', startTime: '13:00', type: 'concert', rank: 'A', memo: 'Âπ¥ÈΩ¢Â±§È´ò„ÇÅ‚Üí„Çø„ÇØ„Ç∑„ÉºÁéá‚óé' },
        { venue: 'USJ', detail: '', endTime: '20:00', type: 'facility', rank: 'B', label: 'ÈñâÂúí' },
        { venue: 'Êµ∑ÈÅäÈ§®', detail: '', endTime: '20:00', type: 'facility', rank: 'B', label: 'ÈñâÈ§®' }
    ];

    // ========================================
    // HOTSPOT TAB - Map
    // ========================================
    const AREA_COORDS = {
        'Ê¢ÖÁî∞': { lat: 34.7010, lng: 135.4975 },
        'ÂåóÊñ∞Âú∞': { lat: 34.7025, lng: 135.4950 },
        'Èõ£Ê≥¢': { lat: 34.6650, lng: 135.5015 },
        '„Å™„Çì„Å∞': { lat: 34.6650, lng: 135.5015 },
        'ÂøÉÊñéÊ©ã': { lat: 34.6750, lng: 135.5010 },
        'Â§©ÁéãÂØ∫': { lat: 34.6465, lng: 135.5133 },
        'Á¶èÂ≥∂': { lat: 34.6930, lng: 135.4830 },
        'Êú¨Áî∫': { lat: 34.6810, lng: 135.4960 },
        'Ê∑ÄÂ±ãÊ©ã': { lat: 34.6900, lng: 135.5020 },
        'Â§©Ê∫Ä': { lat: 34.7055, lng: 135.5120 },
        '‰∫¨Ê©ã': { lat: 34.6970, lng: 135.5350 },
        'Ë•øÊàê': { lat: 34.6350, lng: 135.5050 },
        'Êñ∞Â§ßÈò™': { lat: 34.7330, lng: 135.5000 },
        'ÂçÅ‰∏â': { lat: 34.7200, lng: 135.4750 },
        '‰∏≠‰πãÂ≥∂': { lat: 34.6914, lng: 135.4946 },
        'OBP': { lat: 34.6932, lng: 135.5199 },
        'Â§ßÈò™ÂüéÂÖ¨Âúí': { lat: 34.6873, lng: 135.5320 },
        'Â§©‰øùÂ±±': { lat: 34.6545, lng: 135.4290 },
        'USJ': { lat: 34.6654, lng: 135.4324 },
        '‰∫¨„Çª„É©„Éâ„Éº„É†': { lat: 34.6694, lng: 135.4762 },
        'Ê¢ÖÁî∞„Çπ„Ç´„Ç§„Éì„É´': { lat: 34.7052, lng: 135.4876 },
        '„Ç§„É≥„ÉÜ„ÉÉ„ÇØ„Çπ': { lat: 34.6360, lng: 135.4190 },
        'Êµ∑ÈÅäÈ§®': { lat: 34.6545, lng: 135.4290 },
        'ÈòøÂÄçÈáé': { lat: 34.6460, lng: 135.5140 },
        'Â†∫Á≠ãÊú¨Áî∫': { lat: 34.6820, lng: 135.5050 },
        'ËÇ•ÂæåÊ©ã': { lat: 34.6880, lng: 135.4920 },
        'Ë∞∑Áî∫': { lat: 34.6800, lng: 135.5180 },
        '‰∏äÊú¨Áî∫': { lat: 34.6700, lng: 135.5250 },
        'È∂¥Ê©ã': { lat: 34.6680, lng: 135.5300 },
        'Ê±üÂùÇ': { lat: 34.7510, lng: 135.5000 },
        'ÂçÉÈáå‰∏≠Â§Æ': { lat: 34.8070, lng: 135.4940 },
        'Ë±ä‰∏≠': { lat: 34.7810, lng: 135.4700 },
        'ÂêπÁî∞': { lat: 34.7640, lng: 135.5180 },
        'ÁÆïÈù¢': { lat: 34.8270, lng: 135.4700 },
        '‰ºä‰∏πÁ©∫Ê∏Ø': { lat: 34.7850, lng: 135.4380 }
    };

    const DAY_NAMES = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
    const TIME_PERIOD_LABELS = {
        '0-2': 'Ê∑±Â§úÂ∏Ø',
        '2-4': 'Ê∑±Â§úÂ∏Ø',
        '4-6': 'Êó©ÊúùÂ∏Ø',
        '6-8': 'ÊúùÂ∏Ø',
        '8-10': 'ÊúùÂ∏Ø',
        '10-12': 'ÊòºÂ∏Ø',
        '12-14': 'ÊòºÂ∏Ø',
        '14-16': 'ÊòºÂ∏Ø',
        '16-18': 'Â§ïÊñπÂ∏Ø',
        '18-20': 'Â§ïÊñπÂ∏Ø',
        '20-22': 'Â§úÂ∏Ø',
        '22-24': 'Ê∑±Â§úÂ∏Ø'
    };

    const LONG_RIDES = [
        { lat: 34.7010, lng: 135.4975, fare: 8200, from: 'ÂåóÊñ∞Âú∞', to: 'ÁÆïÈù¢', time: '23:40', date: '2/5', app: 'uber' },
        { lat: 34.6873, lng: 135.5320, fare: 5400, from: 'Â§ßÈò™ÂüéÂÖ¨Âúí', to: 'Êñ∞Â§ßÈò™', time: '21:35', date: '2/5', app: 'uber' },
        { lat: 34.6914, lng: 135.4946, fare: 6800, from: '‰∏≠‰πãÂ≥∂', to: 'Ë±ä‰∏≠', time: '20:50', date: '2/6', app: 'didi' },
        { lat: 34.6932, lng: 135.5199, fare: 7200, from: 'OBP', to: '‰ºä‰∏πÁ©∫Ê∏Ø', time: '22:15', date: '2/6', app: 'uber' },
        { lat: 34.6360, lng: 135.4190, fare: 5900, from: '„Ç§„É≥„ÉÜ„ÉÉ„ÇØ„Çπ', to: 'Êñ∞Â§ßÈò™', time: '18:20', date: '2/6', app: 'nagashi' },
        { lat: 34.6690, lng: 135.5020, fare: 4200, from: '„Å™„Çì„Å∞', to: 'ÂêπÁî∞', time: '19:45', date: '2/7', app: 'didi' },
        { lat: 34.6654, lng: 135.4324, fare: 5600, from: 'USJ', to: 'Ê¢ÖÁî∞', time: '20:30', date: '2/7', app: 'nagashi' },
        { lat: 34.7025, lng: 135.4950, fare: 9100, from: 'ÂåóÊñ∞Âú∞', to: 'ÂçÉÈáå‰∏≠Â§Æ', time: '23:55', date: '2/7', app: 'uber' },
        { lat: 34.6905, lng: 135.4849, fare: 6500, from: '„É™„Éº„Ç¨„É≠„Ç§„É§„É´', to: 'Êñ∞Â§ßÈò™', time: '21:10', date: '2/8', app: 'nagashi' },
        { lat: 34.6810, lng: 135.4960, fare: 4800, from: 'Êú¨Áî∫', to: 'Ë±ä‰∏≠', time: '18:50', date: '2/8', app: 'didi' },
        { lat: 34.6545, lng: 135.4290, fare: 5200, from: 'Â§©‰øùÂ±±', to: 'Ê¢ÖÁî∞', time: '16:15', date: '2/8', app: 'uber' },
        { lat: 34.6694, lng: 135.4762, fare: 3800, from: '‰∫¨„Çª„É©„Éâ„Éº„É†', to: 'Èõ£Ê≥¢', time: '21:25', date: '2/8', app: 'nagashi' }
    ];

    const VENUES = [
        { lat: 34.6694, lng: 135.4762, name: 'üìç ‰∫¨„Çª„É©„Éâ„Éº„É†', type: 'venue' },
        { lat: 34.6873, lng: 135.5320, name: 'üìç Â§ßÈò™Âüé„Éõ„Éº„É´', type: 'venue' },
        { lat: 34.6654, lng: 135.4324, name: 'üìç USJ', type: 'venue' },
        { lat: 34.6932, lng: 135.5199, name: 'üìçüè® „Éã„É•„Éº„Ç™„Éº„Çø„Éã', type: 'hotel' },
        { lat: 34.6905, lng: 135.4849, name: 'üìçüè® „É™„Éº„Ç¨„É≠„Ç§„É§„É´', type: 'hotel' },
        { lat: 34.6965, lng: 135.4897, name: 'üìçüè® Â∏ùÂõΩ„Éõ„ÉÜ„É´', type: 'hotel' }
    ];

    function getPeriod(time) {
        const h = parseInt(time.split(':')[0]);
        if (h >= 5 && h < 10) return 'morning';
        if (h >= 10 && h < 17) return 'day';
        if (h >= 17 && h < 22) return 'evening';
        return 'night';
    }
    LONG_RIDES.forEach(r => r.period = getPeriod(r.time));
    const PERIOD_LABELS = { morning: 'üåÖ Êúù', day: '‚òÄÔ∏è Êòº', evening: 'üåÜ Â§ú', night: 'üåô Ê∑±Â§ú' };

    let appMap = null, hotspotLayers = [], currentLocationMarker = null;
    let hotspotData = [];

    // Get current time slot (2-hour window)
    function getTimeSlot() {
        const now = new Date();
        const h = now.getHours();
        const startHour = Math.floor(h / 2) * 2;
        const endHour = startHour + 2;
        return {
            start: startHour,
            end: endHour,
            label: `${startHour}:00 „Äú ${endHour === 24 ? '0' : endHour}:00`
        };
    }

    // Get current day of week
    function getDayOfWeek() {
        const now = new Date();
        return {
            index: now.getDay(),
            name: DAY_NAMES[now.getDay()]
        };
    }

    // Initialize hotspot map
    function initAppMap() {
        if (appMap) return;
        appMap = L.map('map', { center: [34.6937, 135.5023], zoom: 13, zoomControl: false });
        L.control.zoom({ position: 'topright' }).addTo(appMap);
        L.tileLayer('https://tile.openstreetmap.jp/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap ¬© CartoDB', maxZoom: 19
        }).addTo(appMap);
        fetchHotspotData();
    }

    // Fetch hotspot data from Supabase
    async function fetchHotspotData() {
        const timeSlot = getTimeSlot();
        const dayOfWeek = getDayOfWeek();

        // Update UI
        document.getElementById('hotspot-time-range').textContent = timeSlot.label;
        document.getElementById('hotspot-day').textContent = dayOfWeek.name + 'Êõú';

        if (!sb) {
            renderHotspotMap([]);
            return;
        }

        try {
            // Get all logs
            const { data: logs } = await sb
                .from('flow_taxi_logs')
                .select('*')
                .order('ride_date', { ascending: false });

            if (!logs || logs.length === 0) {
                renderHotspotMap([]);
                return;
            }

            // Filter by day of week and time slot
            const filtered = logs.filter(log => {
                const logDate = new Date(log.ride_date);
                if (logDate.getDay() !== dayOfWeek.index) return false;

                if (log.ride_time) {
                    const h = parseInt(log.ride_time.split(':')[0]);
                    if (h < timeSlot.start || h >= timeSlot.end) return false;
                }
                return true;
            });

            hotspotData = filtered;
            document.getElementById('hotspot-count').textContent = `ÈÅéÂéª„ÅÆÂêåÊù°‰ª∂ ${filtered.length}‰ª∂`;
            renderHotspotMap(filtered);
        } catch (e) {
            console.warn('fetchHotspotData error:', e);
            renderHotspotMap([]);
        }
    }

    // Get coordinates for an area
    function getAreaCoords(areaName) {
        if (AREA_COORDS[areaName]) return AREA_COORDS[areaName];
        // Try partial match
        for (const key in AREA_COORDS) {
            if (areaName.includes(key) || key.includes(areaName)) {
                return AREA_COORDS[key];
            }
        }
        return null;
    }

    // Render hotspot map
    function renderHotspotMap(logs) {
        if (!appMap) return;

        // Clear existing layers
        hotspotLayers.forEach(l => appMap.removeLayer(l));
        hotspotLayers = [];

        if (!logs || logs.length === 0) {
            // Show empty state
            document.getElementById('hotspot-recommend').style.display = 'none';
            document.getElementById('hotspot-insight').style.display = 'none';
            return;
        }

        // Group by area
        const areaGroups = {};
        logs.forEach(log => {
            const area = log.area || '‰∏çÊòé';
            if (!areaGroups[area]) areaGroups[area] = [];
            areaGroups[area].push(log);
        });

        // Sort areas by count
        const sortedAreas = Object.entries(areaGroups)
            .sort((a, b) => b[1].length - a[1].length);

        // Draw circles for each area
        sortedAreas.forEach(([area, areaLogs]) => {
            const coords = getAreaCoords(area);
            if (!coords) return;

            const count = areaLogs.length;
            let radius, color, opacity, borderColor;

            if (count >= 3) {
                radius = 300;
                color = '#00e676';
                opacity = 0.25;
                borderColor = '#00e676';
            } else if (count === 2) {
                radius = 200;
                color = '#ffb74d';
                opacity = 0.2;
                borderColor = '#ffb74d';
            } else {
                radius = 150;
                color = '#ffffff';
                opacity = 0.1;
                borderColor = 'rgba(255,255,255,0.4)';
            }

            // Draw circle
            const circle = L.circle([coords.lat, coords.lng], {
                radius: radius,
                fillColor: color,
                fillOpacity: opacity,
                color: borderColor,
                weight: 2
            }).addTo(appMap);
            hotspotLayers.push(circle);

            // Add count label
            const countIcon = L.divIcon({
                className: '',
                html: `<div class="hotspot-circle-label">${count}</div>`,
                iconSize: [30, 20],
                iconAnchor: [15, 10]
            });
            const countMarker = L.marker([coords.lat, coords.lng], { icon: countIcon }).addTo(appMap);
            hotspotLayers.push(countMarker);

            // Add area label below
            const labelIcon = L.divIcon({
                className: '',
                html: `<div class="hotspot-area-label">${area}</div>`,
                iconSize: [80, 16],
                iconAnchor: [40, -5]
            });
            const labelMarker = L.marker([coords.lat, coords.lng], { icon: labelIcon }).addTo(appMap);
            hotspotLayers.push(labelMarker);
        });

        // Update recommend card
        if (sortedAreas.length > 0) {
            const [topArea, topLogs] = sortedAreas[0];
            const timeSlot = getTimeSlot();
            document.getElementById('hotspot-recommend').style.display = 'block';
            document.getElementById('hotspot-recommend-area').textContent = topArea;
            document.getElementById('hotspot-recommend-detail').textContent = `${topLogs.length}‰ª∂ / ${timeSlot.label}`;
        } else {
            document.getElementById('hotspot-recommend').style.display = 'none';
        }

        // Generate insight
        generateInsight(logs, sortedAreas);
    }

    // Generate insight text
    function generateInsight(logs, sortedAreas) {
        if (!logs || logs.length === 0 || sortedAreas.length === 0) {
            document.getElementById('hotspot-insight').style.display = 'none';
            return;
        }

        const dayOfWeek = getDayOfWeek();
        const timeSlot = getTimeSlot();
        const timePeriodKey = `${timeSlot.start}-${timeSlot.end}`;
        const periodLabel = TIME_PERIOD_LABELS[timePeriodKey] || 'ÊôÇÈñìÂ∏Ø';

        // Top area
        const [topArea, topLogs] = sortedAreas[0];

        // App breakdown
        const appCounts = { nagashi: 0, uber: 0, didi: 0 };
        let totalFare = 0;
        logs.forEach(log => {
            if (log.app && appCounts.hasOwnProperty(log.app)) {
                appCounts[log.app]++;
            }
            if (log.fare) totalFare += log.fare;
        });

        const avgFare = logs.length > 0 ? Math.round(totalFare / logs.length) : 0;
        const totalApps = appCounts.nagashi + appCounts.uber + appCounts.didi;

        // Build insight text
        let text = `${dayOfWeek.name}Êõú„ÅÆ${periodLabel}„ÅØ`;

        if (sortedAreas.length > 1) {
            text += `${topArea}„Éª${sortedAreas[1][0]}„Ç®„É™„Ç¢„Åß‰πóËªä„ÅåÈõÜ‰∏≠„ÄÇ`;
        } else {
            text += `${topArea}„Ç®„É™„Ç¢„Åß‰πóËªä„ÅåÈõÜ‰∏≠„ÄÇ`;
        }

        if (totalApps > 0) {
            const parts = [];
            if (appCounts.nagashi > 0) parts.push(`ÊµÅ„Åó${appCounts.nagashi}‰ª∂`);
            if (appCounts.uber > 0) parts.push(`Uber${appCounts.uber}‰ª∂`);
            if (appCounts.didi > 0) parts.push(`DiDi${appCounts.didi}‰ª∂`);
            text += `ÈÅéÂéª${logs.length}‰ª∂‰∏≠„ÄÅ${parts.join('/')}`;
        }

        if (avgFare > 0) {
            text += `„ÄÅÂπ≥ÂùáÂçò‰æ°¬•${avgFare.toLocaleString()}`;
        }

        document.getElementById('hotspot-insight').style.display = 'block';
        document.getElementById('hotspot-insight-text').textContent = text;
    }

    // Go to current location
    function goToCurrentLocation() {
        if (!navigator.geolocation) {
            alert('‰ΩçÁΩÆÊÉÖÂ†±„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                if (appMap) {
                    appMap.setView([lat, lng], 14);

                    // Remove existing marker
                    if (currentLocationMarker) {
                        appMap.removeLayer(currentLocationMarker);
                    }

                    // Add current location marker
                    const icon = L.divIcon({
                        className: '',
                        html: '<div class="current-location-marker"></div>',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });
                    currentLocationMarker = L.marker([lat, lng], { icon }).addTo(appMap);
                }
            },
            (error) => {
                console.warn('Geolocation error:', error);
                alert('‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    // ========================================
    // LONG TAB - Map
    // ========================================
    let longMap = null, longMarkers = [], longHeatLayer = null;
    let longFilters = { view: 'pin', period: 'all', fare: 'all' };

    function initLongMap() {
        if (longMap) return;
        longMap = L.map('long-map', { center: [34.6937, 135.5023], zoom: 12, zoomControl: false });
        L.control.zoom({ position: 'bottomright' }).addTo(longMap);
        L.tileLayer('https://tile.openstreetmap.jp/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap ¬© CartoDB', maxZoom: 19
        }).addTo(longMap);
        renderLongMap();
    }

    function renderLongMap() {
        if (!longMap) return;
        longMarkers.forEach(m => longMap.removeLayer(m));
        longMarkers = [];
        if (longHeatLayer) { longMap.removeLayer(longHeatLayer); longHeatLayer = null; }

        let filtered = LONG_RIDES.filter(r => {
            if (longFilters.period !== 'all' && r.period !== longFilters.period) return false;
            if (longFilters.fare !== 'all' && r.fare < parseInt(longFilters.fare)) return false;
            return true;
        });

        if (longFilters.view === 'pin') {
            VENUES.forEach(v => {
                const short = v.name.replace('üìç ', '').replace('üìçüè® ', 'üè®');
                const icon = L.divIcon({ className: '', html: `<div class="venue-pin ${v.type}">${short}</div>`, iconSize: [80,20], iconAnchor: [40,10] });
                const marker = L.marker([v.lat, v.lng], { icon }).addTo(longMap);
                marker.bindPopup(`<div><div class="popup-area">${v.name}</div><a href="https://www.google.com/maps/dir/?api=1&destination=${v.lat},${v.lng}&travelmode=driving" target="_blank" class="popup-navi-btn">üöó Google Maps„ÅßË°å„Åè</a></div>`);
                longMarkers.push(marker);
            });
            filtered.forEach(r => {
                const fc = r.fare >= 5000 ? 'high' : 'medium';
                const icon = L.divIcon({ className: '', html: `<div class="app-dot ${fc}"></div>`, iconSize: [14,14], iconAnchor: [7,7] });
                const marker = L.marker([r.lat, r.lng], { icon }).addTo(longMap);
                marker.bindPopup(`<div><div class="popup-tag ${r.period}">${PERIOD_LABELS[r.period]} ${r.time}</div><div class="popup-route">${r.from} ‚Üí ${r.to}</div><div class="popup-fare ${fc}">¬•${r.fare.toLocaleString()}</div><div class="popup-datetime">${r.date}</div><a href="https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}&travelmode=driving" target="_blank" class="popup-navi-btn">üöó Google Maps„ÅßË°å„Åè</a></div>`);
                longMarkers.push(marker);
            });
            document.getElementById('long-legend').innerHTML = `<div class="legend-title">„É≠„É≥„Ç∞‰πóËªä</div><div class="legend-item"><div class="legend-box high"></div><span>¬•5,000‰ª•‰∏ä</span></div><div class="legend-item"><div class="legend-box medium"></div><span>¬•3,000„Äú4,999</span></div><div class="legend-item"><div class="legend-box venue"></div><span>„Ç§„Éô„É≥„Éà‰ºöÂ†¥</span></div><div class="legend-item"><div class="legend-box hotel"></div><span>„Éõ„ÉÜ„É´</span></div>`;
        } else {
            longHeatLayer = L.heatLayer(filtered.map(r => [r.lat, r.lng, r.fare/10000]), { radius: 45, blur: 15, maxZoom: 17, minOpacity: 0.6, max: 1.0, gradient: { 0:'#0066ff', 0.3:'#00ccaa', 0.5:'#44dd00', 0.7:'#ffaa00', 0.85:'#ff4400', 1:'#cc0000' } }).addTo(longMap);
            document.getElementById('long-legend').innerHTML = `<div class="legend-title">„É≠„É≥„Ç∞Áô∫ÁîüÂØÜÂ∫¶</div><div class="legend-item"><div class="legend-gradient"></div></div>`;
        }

        const total = filtered.reduce((s, r) => s + r.fare, 0);
        const avg = filtered.length > 0 ? Math.round(total / filtered.length) : 0;
        document.getElementById('long-stats').innerHTML = `<div class="stats-label">„É≠„É≥„Ç∞ÂêàË®àÔºà‰ªäÊúàÔºâ</div><div class="stats-value">¬•${(total/1000).toFixed(0)}k</div><div class="stats-detail">${filtered.length}‰ª∂ / Âπ≥Âùá ¬•${avg.toLocaleString()}</div>`;
    }

    // Long tab filters
    document.querySelectorAll('#long-content .toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#long-content .toggle-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active'); longFilters.view = this.dataset.view; renderLongMap();
        });
    });
    document.querySelectorAll('#long-content .filter-btn[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#long-content .filter-btn[data-period]').forEach(b => b.classList.remove('active'));
            this.classList.add('active'); longFilters.period = this.dataset.period; renderLongMap();
        });
    });
    document.querySelectorAll('#long-content .filter-btn[data-fare]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#long-content .filter-btn[data-fare]').forEach(b => b.classList.remove('active'));
            this.classList.add('active'); longFilters.fare = this.dataset.fare; renderLongMap();
        });
    });

    // ========================================
    // DASHBOARD TAB
    // ========================================
    let revenueChart = null, timeChart = null;
    let dashboardPeriod = 'daily';
    let TAXI_LOGS = [];

    // Sample data (fallback when Supabase is unavailable)
    const SAMPLE_TAXI_LOGS = [
        { ride_date: '2026-02-11', ride_time: '07:20', app: 'uber', fare: 2400, area: 'Ê¢ÖÁî∞' },
        { ride_date: '2026-02-11', ride_time: '09:45', app: 'didi', fare: 1800, area: '„Å™„Çì„Å∞' },
        { ride_date: '2026-02-11', ride_time: '12:30', app: 'uber', fare: 3200, area: 'ÂåóÊñ∞Âú∞' },
        { ride_date: '2026-02-11', ride_time: '14:20', app: 'nagashi', fare: 2100, area: 'Â§©ÁéãÂØ∫' },
        { ride_date: '2026-02-11', ride_time: '19:30', app: 'uber', fare: 5400, area: 'Â§ßÈò™ÂüéÂÖ¨Âúí' },
        { ride_date: '2026-02-11', ride_time: '21:15', app: 'didi', fare: 4800, area: '‰∏≠‰πãÂ≥∂' },
        { ride_date: '2026-02-11', ride_time: '23:40', app: 'uber', fare: 7200, area: 'ÂåóÊñ∞Âú∞' },
        { ride_date: '2026-02-10', ride_time: '08:00', app: 'uber', fare: 3100, area: 'Ê¢ÖÁî∞' },
        { ride_date: '2026-02-10', ride_time: '11:30', app: 'didi', fare: 2200, area: 'USJ' },
        { ride_date: '2026-02-10', ride_time: '18:45', app: 'uber', fare: 6200, area: '‰∫¨„Çª„É©„Éâ„Éº„É†' },
        { ride_date: '2026-02-10', ride_time: '22:00', app: 'nagashi', fare: 4500, area: 'ÂåóÊñ∞Âú∞' },
        { ride_date: '2026-02-09', ride_time: '07:30', app: 'uber', fare: 2800, area: 'Êñ∞Â§ßÈò™' },
        { ride_date: '2026-02-09', ride_time: '13:00', app: 'didi', fare: 1900, area: 'Â§©ÁéãÂØ∫' },
        { ride_date: '2026-02-09', ride_time: '20:30', app: 'uber', fare: 5800, area: 'Â§ßÈò™ÂüéÂÖ¨Âúí' },
        { ride_date: '2026-02-08', ride_time: '09:00', app: 'nagashi', fare: 3500, area: 'Ê¢ÖÁî∞' },
        { ride_date: '2026-02-08', ride_time: '15:30', app: 'uber', fare: 2600, area: '„Å™„Çì„Å∞' },
        { ride_date: '2026-02-08', ride_time: '21:00', app: 'didi', fare: 7100, area: '‰∏≠‰πãÂ≥∂' },
        { ride_date: '2026-02-07', ride_time: '10:00', app: 'uber', fare: 2200, area: 'Â§©ÁéãÂØ∫' },
        { ride_date: '2026-02-07', ride_time: '19:00', app: 'uber', fare: 8500, area: 'ÂåóÊñ∞Âú∞' },
        { ride_date: '2026-02-06', ride_time: '08:30', app: 'didi', fare: 2900, area: 'Êñ∞Â§ßÈò™' },
        { ride_date: '2026-02-06', ride_time: '17:00', app: 'nagashi', fare: 4200, area: 'USJ' },
        { ride_date: '2026-02-05', ride_time: '12:00', app: 'uber', fare: 3300, area: 'Ê¢ÖÁî∞' },
        { ride_date: '2026-02-05', ride_time: '20:00', app: 'uber', fare: 6800, area: '‰∫¨„Çª„É©„Éâ„Éº„É†' }
    ];

    // Fetch taxi logs from Supabase (always fetch 30 days)
    async function fetchTaxiLogs() {
        if (!sb) return [];
        try {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const monthAgo = new Date(today);
            monthAgo.setDate(monthAgo.getDate() - 30);
            const fromDate = monthAgo.toISOString().split('T')[0];

            const { data: logs } = await sb
                .from('flow_taxi_logs')
                .select('*')
                .gte('ride_date', fromDate)
                .lte('ride_date', todayStr)
                .order('ride_date', { ascending: false })
                .order('ride_time', { ascending: false });

            if (logs && logs.length > 0) {
                console.log(`‚úÖ Loaded ${logs.length} taxi logs from Supabase`);
                return logs;
            }
            return [];
        } catch (e) {
            console.warn('fetchTaxiLogs error:', e);
            return [];
        }
    }

    // Get time period from ride_time
    function getTimePeriod(time) {
        if (!time) return 'day';
        const h = parseInt(time.split(':')[0]);
        if (h >= 5 && h < 10) return 'morning';
        if (h >= 10 && h < 17) return 'day';
        if (h >= 17 && h < 22) return 'evening';
        return 'night';
    }

    // Process logs for dashboard display
    function processDashboardData(logs) {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        let filteredLogs = logs;

        if (dashboardPeriod === 'daily') {
            filteredLogs = logs.filter(l => l.ride_date === todayStr);
        } else if (dashboardPeriod === 'weekly') {
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            filteredLogs = logs.filter(l => l.ride_date >= weekAgoStr);
        }
        // monthly uses all logs

        // Build chart labels and data
        let labels = [];
        let chartData = [];

        if (dashboardPeriod === 'daily') {
            labels = ['6ÊôÇ', '9ÊôÇ', '12ÊôÇ', '15ÊôÇ', '18ÊôÇ', '21ÊôÇ', '24ÊôÇ'];
            const hourBuckets = [0, 0, 0, 0, 0, 0, 0];
            filteredLogs.forEach(l => {
                const h = parseInt((l.ride_time || '12:00').split(':')[0]);
                if (h < 9) hourBuckets[0] += l.fare;
                else if (h < 12) hourBuckets[1] += l.fare;
                else if (h < 15) hourBuckets[2] += l.fare;
                else if (h < 18) hourBuckets[3] += l.fare;
                else if (h < 21) hourBuckets[4] += l.fare;
                else if (h < 24) hourBuckets[5] += l.fare;
                else hourBuckets[6] += l.fare;
            });
            chartData = hourBuckets;
        } else if (dashboardPeriod === 'weekly') {
            labels = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü', 'Êó•'];
            const dayBuckets = [0, 0, 0, 0, 0, 0, 0];
            filteredLogs.forEach(l => {
                const d = new Date(l.ride_date);
                const dayIndex = (d.getDay() + 6) % 7; // Monday = 0
                dayBuckets[dayIndex] += l.fare;
            });
            chartData = dayBuckets;
        } else {
            labels = ['Á¨¨1ÈÄ±', 'Á¨¨2ÈÄ±', 'Á¨¨3ÈÄ±', 'Á¨¨4ÈÄ±'];
            const weekBuckets = [0, 0, 0, 0];
            filteredLogs.forEach(l => {
                const d = new Date(l.ride_date);
                const dayOfMonth = d.getDate();
                const weekIndex = Math.min(3, Math.floor((dayOfMonth - 1) / 7));
                weekBuckets[weekIndex] += l.fare;
            });
            chartData = weekBuckets;
        }

        // Time period data
        const timeBuckets = { morning: 0, day: 0, evening: 0, night: 0 };
        filteredLogs.forEach(l => {
            const period = getTimePeriod(l.ride_time);
            timeBuckets[period] += l.fare;
        });
        const timeData = {
            labels: ['Êúù', 'Êòº', 'Â§ï', 'Â§ú'],
            data: [timeBuckets.morning, timeBuckets.day, timeBuckets.evening, timeBuckets.night]
        };

        return {
            labels,
            data: chartData,
            rides: filteredLogs.map(l => ({
                app: l.app || 'nagashi',
                fare: l.fare || 0,
                area: l.area || '‰∏çÊòé',
                time: l.ride_time || ''
            })),
            timeData
        };
    }

    async function initDashboard() {
        // Fetch from Supabase or use sample data
        const fetched = await fetchTaxiLogs();
        if (fetched && fetched.length > 0) {
            TAXI_LOGS = fetched;
        } else {
            TAXI_LOGS = SAMPLE_TAXI_LOGS;
            console.log('üìä Using sample taxi logs');
        }
        renderDashboard();
    }

    function renderDashboard() {
        const processed = processDashboardData(TAXI_LOGS);
        const data = processed;
        const timeData = processed.timeData;

        // Calculate totals
        const totalRevenue = data.data.reduce((s, v) => s + v, 0);
        const totalRides = data.rides.length;
        const avgFare = totalRides > 0 ? Math.round(totalRevenue / totalRides) : 0;
        const longRides = data.rides.filter(r => r.fare >= 3000).length;
        const longRate = totalRides > 0 ? Math.round((longRides / totalRides) * 100) : 0;

        // App breakdown
        const uberTotal = data.rides.filter(r => r.app === 'uber').reduce((s, r) => s + r.fare, 0);
        const didiTotal = data.rides.filter(r => r.app === 'didi').reduce((s, r) => s + r.fare, 0);
        const nagashiTotal = data.rides.filter(r => r.app === 'nagashi').reduce((s, r) => s + r.fare, 0);

        // Update summary cards
        document.getElementById('totalRevenue').textContent = `¬•${totalRevenue.toLocaleString()}`;
        document.getElementById('totalRides').textContent = totalRides;
        document.getElementById('avgFare').textContent = `¬•${avgFare.toLocaleString()}`;
        document.getElementById('longRate').textContent = `${longRate}%`;

        // Comparison text (show period label only, actual comparison requires more historical data)
        const periodLabel = dashboardPeriod === 'daily' ? '‰ªäÊó•' : dashboardPeriod === 'weekly' ? 'ÈÅéÂéª7Êó•Èñì' : 'ÈÅéÂéª30Êó•Èñì';
        document.getElementById('revenueCompare').textContent = periodLabel;
        document.getElementById('ridesCompare').textContent = periodLabel;
        document.getElementById('avgCompare').textContent = periodLabel;

        // App breakdown
        document.getElementById('uberRevenue').textContent = `¬•${(uberTotal/1000).toFixed(0)}k`;
        document.getElementById('didiRevenue').textContent = `¬•${(didiTotal/1000).toFixed(0)}k`;
        document.getElementById('nagashiRevenue').textContent = `¬•${(nagashiTotal/1000).toFixed(0)}k`;
        document.getElementById('uberPct').textContent = totalRevenue > 0 ? `${Math.round(uberTotal/totalRevenue*100)}%` : '0%';
        document.getElementById('didiPct').textContent = totalRevenue > 0 ? `${Math.round(didiTotal/totalRevenue*100)}%` : '0%';
        document.getElementById('nagashiPct').textContent = totalRevenue > 0 ? `${Math.round(nagashiTotal/totalRevenue*100)}%` : '0%';

        // Revenue Chart
        if (revenueChart) revenueChart.destroy();
        const ctx1 = document.getElementById('revenueChart').getContext('2d');
        revenueChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Â£≤‰∏ä',
                    data: data.data,
                    borderColor: '#14b8a6',
                    backgroundColor: 'rgba(20, 184, 166, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#14b8a6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 10 }, callback: v => `¬•${(v/1000).toFixed(0)}k` } }
                }
            }
        });

        // Time Chart
        if (timeChart) timeChart.destroy();
        const ctx2 = document.getElementById('timeChart').getContext('2d');
        timeChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: timeData.labels,
                datasets: [{
                    label: 'Â£≤‰∏ä',
                    data: timeData.data,
                    backgroundColor: ['#f59e0b', '#0ea5e9', '#f97316', '#6366f1'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 11 } } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 10 }, callback: v => `¬•${(v/1000).toFixed(0)}k` } }
                }
            }
        });

        // Area Ranking
        const areaMap = {};
        data.rides.forEach(r => {
            if (!areaMap[r.area]) areaMap[r.area] = { total: 0, count: 0 };
            areaMap[r.area].total += r.fare;
            areaMap[r.area].count += r.count || 1;
        });
        const areaRanking = Object.entries(areaMap)
            .map(([area, data]) => ({ area, ...data }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);

        const rankClasses = ['gold', 'silver', 'bronze', 'normal', 'normal'];
        document.getElementById('areaRanking').innerHTML = areaRanking.map((item, i) => `
            <div class="ranking-item">
                <div class="ranking-rank ${rankClasses[i]}">${i + 1}</div>
                <div class="ranking-info">
                    <div class="ranking-name">${item.area}</div>
                    <div class="ranking-detail">${item.count}‰ª∂</div>
                </div>
                <div class="ranking-value">¬•${item.total.toLocaleString()}</div>
            </div>
        `).join('');
    }

    // Dashboard period tabs
    document.querySelectorAll('.period-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            dashboardPeriod = this.dataset.period;
            renderDashboard();
        });
    });

    // ========================================
    // LINE Paste Modal
    // ========================================
    const VENUE_KEYWORDS = {
        'Âüé„Éõ„Éº„É´': { category: 'concert', rank: 'S', fullName: 'Â§ßÈò™Âüé„Éõ„Éº„É´' },
        '‰∫¨„Çª„É©„Éâ„Éº„É†': { category: 'concert', rank: 'S', fullName: '‰∫¨„Çª„É©„Éâ„Éº„É†Â§ßÈò™' },
        '„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´„Éõ„Éº„É´': { category: 'concert', rank: 'A', fullName: '„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´„Éõ„Éº„É´' },
        'USJ': { category: 'facility', rank: 'B', fullName: 'USJ' },
        'Êµ∑ÈÅäÈ§®': { category: 'facility', rank: 'B', fullName: 'Êµ∑ÈÅäÈ§®' },
        '„Éã„É•„Éº„Ç™„Éº„Çø„Éã': { category: 'hotel', rank: 'A', fullName: '„Éõ„ÉÜ„É´„Éã„É•„Éº„Ç™„Éº„Çø„ÉãÂ§ßÈò™' },
        '„É™„Éº„Ç¨„É≠„Ç§„É§„É´': { category: 'hotel', rank: 'A', fullName: '„É™„Éº„Ç¨„É≠„Ç§„É§„É´„Éõ„ÉÜ„É´' },
        'Â∏ùÂõΩ„Éõ„ÉÜ„É´': { category: 'hotel', rank: 'A', fullName: 'Â∏ùÂõΩ„Éõ„ÉÜ„É´Â§ßÈò™' },
        '„Ç™„É™„ÉÉ„ÇØ„ÇπÂäáÂ†¥': { category: 'concert', rank: 'A', fullName: '„Ç™„É™„ÉÉ„ÇØ„ÇπÂäáÂ†¥' },
        'ZEPP': { category: 'concert', rank: 'A', fullName: 'Zepp Namba' },
        '„Ç§„É≥„ÉÜ„ÉÉ„ÇØ„Çπ': { category: 'facility', rank: 'A', fullName: '„Ç§„É≥„ÉÜ„ÉÉ„ÇØ„ÇπÂ§ßÈò™' },
        '„Çπ„Ç´„Ç§„Éì„É´': { category: 'facility', rank: 'B', fullName: 'Ê¢ÖÁî∞„Çπ„Ç´„Ç§„Éì„É´' },
        'Â§©ÁéãÂØ∫ÂãïÁâ©': { category: 'facility', rank: 'B', fullName: 'Â§©ÁéãÂØ∫ÂãïÁâ©Âúí' }
    };

    const fabBtn = document.getElementById('fabBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const lineModal = document.getElementById('lineModal');

    // LINE Modal functions
    function openLineModal() { modalOverlay.classList.add('active'); setTimeout(() => lineModal.classList.add('active'), 10); }
    function closeLineModal() {
        lineModal.classList.remove('active');
        setTimeout(() => {
            modalOverlay.classList.remove('active');
            document.getElementById('lineTextarea').value = '';
            document.getElementById('parsePreview').classList.remove('active');
            document.getElementById('addEventBtn').style.display = 'none';
            document.getElementById('parseBtn').style.display = 'block';
            parsedEvents = [];
        }, 300);
    }

    // Taxi Log Modal
    const taxiModalOverlay = document.getElementById('taxiModalOverlay');
    const taxiModal = document.getElementById('taxiModal');
    let selectedApp = 'uber';

    function openTaxiModal() {
        // Set current time as default
        const now = new Date();
        document.getElementById('taxiTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        document.getElementById('taxiFrom').value = '';
        document.getElementById('taxiTo').value = '';
        document.getElementById('taxiFare').value = '';
        selectedApp = 'uber';
        document.querySelectorAll('.app-select-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.app-select-btn[data-app="uber"]').classList.add('active');

        taxiModalOverlay.classList.add('active');
        setTimeout(() => taxiModal.classList.add('active'), 10);
    }

    function closeTaxiModal() {
        taxiModal.classList.remove('active');
        setTimeout(() => taxiModalOverlay.classList.remove('active'), 300);
    }

    // App select buttons
    document.querySelectorAll('.app-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.app-select-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedApp = this.dataset.app;
        });
    });

    // Save taxi log
    document.getElementById('saveTaxiBtn').addEventListener('click', async () => {
        const time = document.getElementById('taxiTime').value;
        const from = document.getElementById('taxiFrom').value.trim();
        const fare = parseInt(document.getElementById('taxiFare').value);

        // Validation
        if (!time) { alert('‰πóËªäÊôÇÂàª„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        if (!from) { alert('Âá∫Áô∫Âú∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        if (!fare || fare <= 0) { alert('ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

        const today = new Date().toISOString().split('T')[0];
        const record = {
            ride_date: today,
            ride_time: time,
            area: from,
            fare: fare,
            app: selectedApp
        };

        // Save to Supabase
        if (sb) {
            try {
                const { error } = await sb.from('flow_taxi_logs').insert([record]);
                if (error) {
                    console.error('Save error:', error);
                    if (error.code === '42501') {
                        alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\nRLS„Éù„É™„Ç∑„Éº„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                    } else {
                        alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    }
                    return;
                }
                console.log('‚úÖ Taxi log saved');
            } catch (e) {
                console.error('Save error:', e);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }
        } else {
            console.log('üìù Taxi log (offline):', record);
        }

        // Close modal and refresh dashboard
        closeTaxiModal();

        // Add to local cache and refresh
        TAXI_LOGS.unshift(record);
        renderDashboard();

        // Show success feedback
        const btn = document.getElementById('saveTaxiBtn');
        btn.textContent = '‚úÖ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
        btn.style.background = '#22c55e';
        setTimeout(() => {
            btn.textContent = '‰øùÂ≠ò„Åô„Çã';
            btn.style.background = '';
        }, 1500);
    });

    // Taxi modal event listeners
    document.getElementById('taxiModalClose').addEventListener('click', closeTaxiModal);
    taxiModalOverlay.addEventListener('click', closeTaxiModal);
    taxiModal.addEventListener('click', e => e.stopPropagation());

    // FAB button - open different modal based on current tab
    function getCurrentTab() {
        const activeTab = document.querySelector('.tab.active');
        return activeTab ? activeTab.dataset.tab : 'events';
    }

    fabBtn.addEventListener('click', () => {
        if (getCurrentTab() === 'dashboard') {
            openTaxiModal();
        } else {
            openLineModal();
        }
    });

    document.getElementById('modalClose').addEventListener('click', closeLineModal);
    modalOverlay.addEventListener('click', closeLineModal);
    lineModal.addEventListener('click', e => e.stopPropagation());

    // Parse multiple events from text
    function parseEventsFromText(text) {
        const events = [];
        const lines = text.split('\n');
        let currentEvent = null;

        for (const line of lines) {
            // Check for venue keywords
            for (const [kw, info] of Object.entries(VENUE_KEYWORDS)) {
                if (line.includes(kw)) {
                    // Save previous event if exists
                    if (currentEvent && currentEvent.venue) {
                        events.push(currentEvent);
                    }
                    // Start new event
                    currentEvent = {
                        venue: kw,
                        venueFull: info.fullName,
                        category: info.category,
                        rank: info.rank,
                        endTime: null,
                        count: null,
                        detail: line.trim()
                    };
                    break;
                }
            }

            // Extract time for current event
            if (currentEvent) {
                const tm = line.match(/(\d{1,2}):(\d{2})/g);
                if (tm) currentEvent.endTime = tm[tm.length - 1];
                const cm = line.match(/(\d+)Âêç/);
                if (cm) currentEvent.count = parseInt(cm[1]);
            }
        }

        // Don't forget last event
        if (currentEvent && currentEvent.venue) {
            events.push(currentEvent);
        }

        // If no events found by line parsing, try single event parse
        if (events.length === 0) {
            for (const [kw, info] of Object.entries(VENUE_KEYWORDS)) {
                if (text.includes(kw)) {
                    const tm = text.match(/(\d{1,2}):(\d{2})/g);
                    const cm = text.match(/(\d+)Âêç/);
                    events.push({
                        venue: kw,
                        venueFull: info.fullName,
                        category: info.category,
                        rank: info.rank,
                        endTime: tm ? tm[tm.length - 1] : null,
                        count: cm ? parseInt(cm[1]) : null,
                        detail: text.trim().substring(0, 100)
                    });
                    break;
                }
            }
        }

        return events;
    }

    let parsedEvents = [];

    document.getElementById('parseBtn').addEventListener('click', () => {
        const text = document.getElementById('lineTextarea').value;
        if (!text.trim()) return;

        parsedEvents = parseEventsFromText(text);

        if (parsedEvents.length === 0) {
            alert('‰ºöÂ†¥ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            return;
        }

        // Show preview
        if (parsedEvents.length === 1) {
            const e = parsedEvents[0];
            document.getElementById('previewVenue').textContent = e.venueFull || e.venue;
            document.getElementById('previewTime').textContent = e.endTime || 'Êú™Ê§úÂá∫';
            document.getElementById('previewCount').textContent = e.count ? `${e.count}Âêç` : 'Êú™Ê§úÂá∫';
            document.getElementById('previewRank').textContent = e.rank || '-';
        } else {
            document.getElementById('previewVenue').textContent = `${parsedEvents.length}‰ª∂„ÅÆ„Ç§„Éô„É≥„Éà`;
            document.getElementById('previewTime').textContent = parsedEvents.map(e => e.endTime || '?').join(', ');
            document.getElementById('previewCount').textContent = '-';
            document.getElementById('previewRank').textContent = '-';
        }

        document.getElementById('parsePreview').classList.add('active');
        document.getElementById('parseBtn').style.display = 'none';
        document.getElementById('addEventBtn').style.display = 'block';
    });

    document.getElementById('addEventBtn').addEventListener('click', async () => {
        if (!parsedEvents || parsedEvents.length === 0) return;

        const btn = document.getElementById('addEventBtn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '‰øùÂ≠ò‰∏≠...';

        const today = new Date().toISOString().split('T')[0];
        let addedCount = 0;
        let skippedCount = 0;
        let errorCount = 0;

        for (const parsed of parsedEvents) {
            const newEvent = {
                venue: parsed.venueFull, type: parsed.category, rank: parsed.rank,
                endTime: parsed.endTime || '21:00', label: 'ÁµÇ‰∫Ü‰∫àÂÆö', people: parsed.count,
                artist: null, detail: parsed.detail || null, startTime: null, memo: null, source: 'manual'
            };

            if (sb) {
                try {
                    // Check for duplicate (same date, venue, end_time, AND detail)
                    const { data: existing, error: selectError } = await sb
                        .from('flow_manual_events')
                        .select('id')
                        .eq('event_date', today)
                        .eq('venue', newEvent.venue)
                        .eq('end_time', newEvent.endTime)
                        .eq('detail', newEvent.detail || '')
                        .limit(1);

                    if (selectError) {
                        console.warn('Duplicate check failed:', selectError);
                        errorCount++;
                        continue;
                    }

                    if (existing && existing.length > 0) {
                        console.log('‚ö†Ô∏è Duplicate event skipped:', newEvent.venue);
                        skippedCount++;
                        continue;
                    }

                    // Insert new event
                    const { error } = await sb.from('flow_manual_events').insert([{
                        event_date: today, venue: newEvent.venue, detail: newEvent.detail || '',
                        event_type: newEvent.type, rank: newEvent.rank, end_time: newEvent.endTime,
                        people_count: newEvent.people || null
                    }]);

                    if (error) {
                        console.warn('Save failed:', error);
                        errorCount++;
                        continue;
                    }

                    addedCount++;
                    EVENTS.push(newEvent);
                    console.log('‚úÖ Event saved:', newEvent.venue);

                } catch (e) {
                    console.warn('Save failed:', e);
                    errorCount++;
                }
            } else {
                // SupabaseÊú™Êé•Á∂ö„ÅÆÂ†¥Âêà„ÅØ„É≠„Éº„Ç´„É´„ÅÆ„Åø
                addedCount++;
                EVENTS.push(newEvent);
            }
        }

        // Show result
        renderTimeline();
        updateNextBanner(EVENTS);

        if (addedCount > 0 && skippedCount === 0 && errorCount === 0) {
            btn.textContent = `‚úÖ ${addedCount}‰ª∂ËøΩÂä†„Åó„Åæ„Åó„Åü`;
            btn.style.background = '#22c55e';
        } else if (addedCount > 0) {
            btn.textContent = `‚úÖ ${addedCount}‰ª∂ËøΩÂä†„ÄÅ${skippedCount}‰ª∂„Çπ„Ç≠„ÉÉ„Éó`;
            btn.style.background = '#22c55e';
        } else if (skippedCount > 0) {
            btn.textContent = `‚ö†Ô∏è ${skippedCount}‰ª∂„Åô„Åπ„Å¶ÁôªÈå≤Ê∏à„Åø`;
            btn.style.background = '#f59e0b';
        } else {
            btn.textContent = '‚ùå ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            btn.style.background = '#ef4444';
        }

        // Close modal after brief delay to show success message
        setTimeout(() => {
            closeLineModal();
            btn.textContent = originalText;
            btn.style.background = '';
            btn.disabled = false;

            // Switch to events tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab[data-tab="events"]').classList.add('active');
            document.getElementById('events-content').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 2000);
    });

    // ========================================
    // Initialize
    // ========================================
    async function initializeApp() {
        try {
            updateHeaderDate();
            const fetched = await fetchTodayEvents();
            EVENTS = (fetched && fetched.length > 0) ? fetched : SAMPLE_EVENTS;
            console.log(`‚úÖ Loaded ${EVENTS.length} events` + (fetched.length > 0 ? ' from Supabase' : ' (sample data)'));
            renderTimeline();
            updateNextBanner(EVENTS);
        } catch (e) {
            console.error('Init error:', e);
            EVENTS = SAMPLE_EVENTS;
            renderTimeline();
            updateNextBanner(EVENTS);
        }
    }

    initializeApp();

    // Auto-refresh every 60s
    setInterval(() => updateNextBanner(EVENTS), 60000);

    // Unregister any existing Service Workers
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
                registration.unregister().then(() => {
                    console.log('‚úÖ Service Worker unregistered');
                });
            });
        });
    }
    </script>
</body>
</html>
